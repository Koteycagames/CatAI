<!DOCTYPE html>
<html lang="ru" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CatAI Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* –ü—Ä—è—á–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–µ —Å—Ç—Ä–µ–ª–∫–∏ —É <select> */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
        #chat-messages::-webkit-scrollbar {
            width: 8px; /* –®–∏—Ä–∏–Ω–∞ */
        }
        #chat-messages::-webkit-scrollbar-track {
            background: #2d3748; /* –¶–≤–µ—Ç —Ñ–æ–Ω–∞ —Ç—Ä–µ–∫–∞ */
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background-color: #4a5568; /* –¶–≤–µ—Ç –ø–æ–ª–∑—É–Ω–∫–∞ */
            border-radius: 20px; /* –°–∫—Ä—É–≥–ª–µ–Ω–∏–µ */
        }
        /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ –¥–ª—è —Å–∞–π–¥–±–∞—Ä–∞ */
        #chat-history-list::-webkit-scrollbar {
            width: 6px;
        }
        #chat-history-list::-webkit-scrollbar-track {
            background: #1a202c; 
        }
        #chat-history-list::-webkit-scrollbar-thumb {
            background-color: #4a5568;
            border-radius: 20px;
        }
    </style>
</head>
<body class="bg-gray-900 text-white h-full overflow-hidden">

    <section id="login" class="page flex items-center justify-center h-full">
        <div class="w-full max-w-md p-8 space-y-6 bg-gray-800 rounded-lg shadow-lg">
            <h2 class="text-3xl font-bold text-center text-white">–í—Ö–æ–¥ –≤ CatAI</h2>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="login-email" class="text-sm font-medium text-gray-300 block mb-2">Email</label>
                    <input type="email" id="login-email" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" value="" required>
                </div>
                <div>
                    <label for="login-password" class="text-sm font-medium text-gray-300 block mb-2">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="login-password" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" value="" required>
                </div>
                <button type="submit" class="w-full px-4 py-2 font-bold text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                    –í–æ–π—Ç–∏
                </button>
            </form>
            <p id="login-error" class="text-sm text-red-500 text-center"></p>
            <p class="text-sm text-center text-gray-400">
                –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#register" class="font-medium text-blue-500 hover:text-blue-400">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
            </p>
        </div>
    </section>

    <section id="register" class="page hidden items-center justify-center h-full">
        <div class="w-full max-w-md p-8 space-y-6 bg-gray-800 rounded-lg shadow-lg">
            <h2 class="text-3xl font-bold text-center text-white">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ CatAI</h2>
            <form id="register-form" class="space-y-6">
                <div>
                    <label for="register-email" class="text-sm font-medium text-gray-300 block mb-2">Email</label>
                    <input type="email" id="register-email" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="register-password" class="text-sm font-medium text-gray-300 block mb-2">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="register-password" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="register-password-confirm" class="text-sm font-medium text-gray-300 block mb-2">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="register-password-confirm" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <button type="submit" class="w-full px-4 py-2 font-bold text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                    –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                </button>
            </form>
            <p id="register-error" class="text-sm text-red-500 text-center"></p>
            <p class="text-sm text-center text-gray-400">
                –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="#login" class="font-medium text-blue-500 hover:text-blue-400">–í–æ–π—Ç–∏</a>
            </p>
        </div>
    </section>

    <section id="ai" class="page hidden h-full flex overflow-hidden">
       
        <div class="flex-shrink-0 w-64 bg-gray-950 flex flex-col border-r border-gray-700">
            <div class="p-4 border-b border-gray-700">
                <button id="new-chat-btn" class="flex items-center justify-between w-full px-3 py-2 text-sm font-medium text-left text-white bg-gray-800 rounded-md hover:bg-gray-700">
                    –ù–æ–≤—ã–π —á–∞—Ç
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                </button>
            </div>
           
            <nav id="chat-history-list" class="flex-1 overflow-y-auto space-y-1 p-4">
                </nav>
           
            <div class="border-t border-gray-700 p-4">
                 <a href="#models" id="models-btn" class="flex w-full items-center px-3 py-2 text-sm font-medium rounded-md text-gray-400 hover:bg-gray-800 hover:text-white mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M5 2a1 1 0 00-1 1v1h1a1 1 0 010 2H4v1a1 1 0 001 1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1V9a1 1 0 011-1h2a1 1 0 001-1V6h-1a1 1 0 110-2h1V3a1 1 0 00-1-1H5zM2 13v3a1 1 0 001 1h3a1 1 0 001-1v-3a1 1 0 00-1-1H3a1 1 0 00-1 1zm14 0v3a1 1 0 001 1h3a1 1 0 001-1v-3a1 1 0 00-1-1h-3a1 1 0 00-1 1z" clip-rule="evenodd" />
                    </svg>
                    –ú–æ–¥–µ–ª–∏
                </a>
                 <a href="#admin" id="admin-panel-btn" class="hidden flex w-full items-center px-3 py-2 text-sm font-medium rounded-md text-yellow-400 hover:bg-gray-800 hover:text-white mb-2">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                         <path fill-rule="evenodd" d="M18 8a6 6 0 01-7.743 5.743L10 14l-1 1-1 1H6v2H2v-4l4.257-4.257A6 6 0 1118 8zm-6-4a4 4 0 100 8 4 4 0 000-8z" clip-rule="evenodd" />
                     </svg>
                     –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
                 </a>
                 <a href="#login" id="logout-btn" class="flex w-full items-center px-3 py-2 text-sm font-medium rounded-md text-gray-400 hover:bg-gray-800 hover:text-white">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                       <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V5.414L12.586 14 14 12.586 5.414 4H16a1 1 0 100-2H4a1 1 0 00-1 1z" clip-rule="evenodd" />
                     </svg>
                     –í—ã–π—Ç–∏
                 </a>
            </div>
        </div>
       
        <div class="flex-1 flex flex-col overflow-hidden">
            <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-6">
                </div>
           
            <div id="typing-indicator" class="hidden px-6 py-2 text-sm text-gray-400">
                CatAI –ø–µ—á–∞—Ç–∞–µ—Ç...
            </div>
           
            <div class="p-6 border-t border-gray-700 bg-gray-900">
                <form id="chat-form" class="flex items-center space-x-4">
                    <div class="relative">
                        <select id="model-select" class="w-40 bg-gray-800 border border-gray-700 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 pr-8">
                            <option value="base">CatAI base</option>
                            <option value="fast">CatAI Fast</option>
                            <option value="pro" disabled>CatAI PRO (–ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏)</option>
                        </select>
                        <svg class="w-4 h-4 text-gray-400 absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>

                    <input type="text" id="chat-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." class="flex-1 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="off">
                   
                    <button type="submit" class="p-2 bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <svg class="w-6 h-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                        </svg>
                    </button>
                </form>
            </div>
        </div>
    </section>

    <div id="models-modal" class="page hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div id="modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity" aria-hidden="true"></div>

            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
               
                <div id="modal-state-default">
                    <div class="bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-600 sm:mx-0 sm:h-10 sm:w-10">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5 2a1 1 0 00-1 1v1h1a1 1 0 010 2H4v1a1 1 0 001 1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1V9a1 1 0 011-1h2a1 1 0 001-1V6h-1a1 1 0 110-2h1V3a1 1 0 00-1-1H5zM2 13v3a1 1 0 001 1h3a1 1 0 001-1v-3a1 1 0 00-1-1H3a1 1 0 00-1 1zm14 0v3a1 1 0 001 1h3a1 1 0 001-1v-3a1 1 0 00-1-1h-3a1 1 0 00-1 1z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                                <h3 class="text-lg leading-6 font-medium text-white" id="modal-title">
                                    –ú–æ–¥–µ–ª–∏ CatAI
                                </h3>
                                <div class="mt-2">
                                    <p class="text-sm text-gray-400">
                                        –í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ –≤–∞—à–∏ –∑–∞–¥–∞—á–∏. PRO-–º–æ–¥–µ–ª–∏ —Ç—Ä–µ–±—É—é—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏.
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-6 space-y-6">
                            <fieldset>
                                <legend class="text-base font-medium text-white">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å</legend>
                                <div class="mt-4 space-y-2">
                                    <label for="model-base" class="flex items-center p-3 rounded-lg bg-gray-700 hover:bg-gray-600 cursor-pointer">
                                        <input id="model-base" name="model-selection" type="radio" value="base" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-500">
                                        <span class="ml-3 text-sm font-medium text-white">CatAI base (–ë–µ—Å–ø–ª–∞—Ç–Ω–æ)</span>
                                    </label>
                                    <label for="model-fast" class="flex items-center p-3 rounded-lg bg-gray-700 hover:bg-gray-600 cursor-pointer">
                                        <input id="model-fast" name="model-selection" type="radio" value="fast" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-500">
                                        <span class="ml-3 text-sm font-medium text-white">CatAI Fast (–ë–µ—Å–ø–ª–∞—Ç–Ω–æ)</span>
                                    </label>
                                    <label for="model-pro" class="flex items-center p-3 rounded-lg bg-gray-700 hover:bg-gray-600 cursor-pointer">
                                        <input id="model-pro" name="model-selection" type="radio" value="pro" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-500">
                                        <span class="ml-3 text-sm font-medium text-white">CatAI PRO (–¢—Ä–µ–±—É–µ—Ç –æ–ø–ª–∞—Ç—ã)</span>
                                    </label>
                                </div>
                            </fieldset>

                            <fieldset id="limit-selection-fieldset" class="hidden">
                                <legend class="text-base font-medium text-white">–í—ã–±–µ—Ä–∏—Ç–µ –ª–∏–º–∏—Ç (–¥–ª—è PRO)</legend>
                                <div class="mt-4 grid grid-cols-3 gap-3">
                                    <label for="limit-1k" class="flex items-center justify-center p-3 rounded-lg bg-gray-700 hover:bg-gray-600 cursor-pointer text-sm font-medium text-white">
                                        <input id="limit-1k" name="limit-selection" type="radio" value="1k" class="sr-only">
                                        <span>1–∫</span>
                                    </label>
                                    <label for="limit-3k" class="flex items-center justify-center p-3 rounded-lg bg-gray-700 hover:bg-gray-600 cursor-pointer text-sm font-medium text-white">
                                        <input id="limit-3k" name="limit-selection" type="radio" value="3k" class="sr-only">
                                        <span>3–∫</span>
                                    </label>
                                    <label for="limit-5k" class="flex items-center justify-center p-3 rounded-lg bg-gray-700 hover:bg-gray-600 cursor-pointer text-sm font-medium text-white">
                                        <input id="limit-5k" name="limit-selection" type="radio" value="5k" class="sr-only">
                                        <span>5–∫</span>
                                    </label>
                                    <label for="limit-10k" class="flex items-center justify-center p-3 rounded-lg bg-gray-700 hover:bg-gray-600 cursor-pointer text-sm font-medium text-white">
                                        <input id="limit-10k" name="limit-selection" type="radio" value="10k" class="sr-only">
                                        <span>10–∫</span>
                                    </label>
                                    <label for="limit-30k" class="flex items-center justify-center p-3 rounded-lg bg-gray-700 hover:bg-gray-600 cursor-pointer text-sm font-medium text-white">
                                        <input id="limit-30k" name="limit-selection" type="radio" value="30k" class="sr-only">
                                        <span>30–∫</span>
                                    </label>
                                </div>
                            </fieldset>
                        </div>
                    </div>
                    <div class="bg-gray-800 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse border-t border-gray-700">
                        <button id="purchase-btn" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm" disabled>
                            –û–ø–ª–∞—Ç–∏—Ç—å (–°–∫–æ—Ä–æ)
                        </button>
                        <button id="close-modal-btn" type="button" class="mt-3 sm:mt-0 w-full inline-flex justify-center rounded-md border border-gray-600 shadow-sm px-4 py-2 bg-gray-700 text-base font-medium text-white hover:bg-gray-600 focus:outline-none sm:w-auto sm:text-sm">
                            –ó–∞–∫—Ä—ã—Ç—å
                        </button>
                    </div>
                </div>

                <div id="modal-state-waiting" class="hidden">
                    <div class="bg-gray-800 px-4 pt-5 pb-8 sm:p-6 sm:pb-8 text-center">
                        <h3 class="text-lg font-medium text-white">–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è...</h3>
                        <p class="text-sm text-gray-400 mt-2">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —ç—Ç–æ –æ–∫–Ω–æ. –ê–¥–º–∏–Ω –ø–æ–ª—É—á–∏–ª –≤–∞—à –∑–∞–ø—Ä–æ—Å.</p>
                        <svg class="animate-spin h-8 w-8 text-blue-500 mx-auto mt-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                </div>

                <div id="modal-state-error" class="hidden">
                    <div class="bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-600 sm:mx-0 sm:h-10 sm:w-10">
                                <svg class="h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </div>
                            <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                                <h3 class="text-lg leading-6 font-medium text-white">–ó–∞–ø—Ä–æ—Å –æ—Ç–∫–ª–æ–Ω–µ–Ω</h3>
                                <div class="mt-2">
                                    <p class="text-sm text-gray-400" id="modal-error-message">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ—Ç–∫–ª–æ–Ω–∏–ª –≤–∞—à –∑–∞–ø—Ä–æ—Å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-800 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse border-t border-gray-700">
                        <button id="close-error-btn" type="button" class="w-full inline-flex justify-center rounded-md border border-gray-600 shadow-sm px-4 py-2 bg-gray-700 text-base font-medium text-white hover:bg-gray-600 focus:outline-none sm:w-auto sm:text-sm">
                            –ó–∞–∫—Ä—ã—Ç—å
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>


    <div id="admin-modal" class="page hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="admin-modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div id="admin-modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity" aria-hidden="true"></div>

            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
                <div class="bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-yellow-600 sm:mx-0 sm:h-10 sm:w-10">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 8a6 6 0 01-7.743 5.743L10 14l-1 1-1 1H6v2H2v-4l4.257-4.257A6 6 0 1118 8zm-6-4a4 4 0 100 8 4 4 0 000-8z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-white" id="admin-modal-title">
                                –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å: –ó–∞–ø—Ä–æ—Å—ã
                            </h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-400">
                                    –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –ø–æ–∫—É–ø–∫—É –ø–æ–¥–ø–∏—Å–∫–∏.
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6">
                        <h2 class="text-lg font-semibold mb-4 text-white">–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã</h2>
                        <div id="admin-requests-list" class="space-y-3 max-h-96 overflow-y-auto">
                            <p class="text-gray-500">–û–∂–∏–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤...</p>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-800 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse border-t border-gray-700">
                    <button id="close-admin-modal-btn" type="button" class="mt-3 sm:mt-0 w-full inline-flex justify-center rounded-md border border-gray-600 shadow-sm px-4 py-2 bg-gray-700 text-base font-medium text-white hover:bg-gray-600 focus:outline-none sm:w-auto sm:text-sm">
                        –ó–∞–∫—Ä—ã—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        // –ò–º–ø–æ—Ä—Ç—ã Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω 'get'
        import { getDatabase, ref, onValue, push, set, serverTimestamp, update, off, get } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        // –¢–≤–æ—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCcgLac2riawIGPHsdkXLOeFTEY_TUZX_s",
            authDomain: "catai-1624d.firebaseapp.com",
            databaseURL: "https://catai-1624d-default-rtdb.firebaseio.com",
            projectId: "catai-1624d",
            storageBucket: "catai-1624d.firebasestorage.app",
            messagingSenderId: "565260079109",
            appId: "1:565260079109:web:fd10c337a424555c0b0c6c"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ===
        const pages = document.querySelectorAll('.page');
       
        // –§–æ—Ä–º—ã
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const registerForm = document.getElementById('register-form');
        const registerError = document.getElementById('register-error');

        // –ß–∞—Ç
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');
        const typingIndicator = document.getElementById('typing-indicator');
        const modelSelect = document.getElementById('model-select');
        const newChatBtn = document.getElementById('new-chat-btn');
        const chatHistoryList = document.getElementById('chat-history-list');
        const logoutBtn = document.getElementById('logout-btn');

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (–ú–æ–¥–µ–ª–∏)
        const modelsBtn = document.getElementById('models-btn');
        const modelsModal = document.getElementById('models-modal');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const limitSelectionFieldset = document.getElementById('limit-selection-fieldset');
        const modelSelectionRadios = document.querySelectorAll('input[name="model-selection"]');
        const purchaseBtn = document.getElementById('purchase-btn');
        const limitSelectionRadios = document.querySelectorAll('input[name="limit-selection"]');
        const modalStateDefault = document.getElementById('modal-state-default');
        const modalStateWaiting = document.getElementById('modal-state-waiting');
        const modalStateError = document.getElementById('modal-state-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const closeErrorBtn = document.getElementById('close-error-btn');
       
        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (–ê–¥–º–∏–Ω)
        const adminPanelBtn = document.getElementById('admin-panel-btn');
        const adminModal = document.getElementById('admin-modal');
        const adminModalBackdrop = document.getElementById('admin-modal-backdrop');
        const closeAdminModalBtn = document.getElementById('close-admin-modal-btn');
       
        // –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
        const adminRequestsList = document.getElementById('admin-requests-list');

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let currentUserId = null;
        let isAdmin = false; 
        let userChatsData = {}; // –ö—ç—à –¥–∞–Ω–Ω—ã—Ö –∏–∑ RTDB
        let currentActiveChatId = null;
        let chatsListener = null; // –•—Ä–∞–Ω–∏—Ç —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ø–∏—Å–∫–∏ –æ—Ç onValue
        let adminListener = null; 
        let purchaseListener = null; 
        let subscriptionStatus = { status: 'none', model: 'base', limit: 0 }; 
        let knowledgeBase = {}; // <--- 1. –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –ü–ï–†–ï–ú–ï–ù–ù–ê–Ø –î–õ–Ø –ë–ê–ó–´ –ó–ù–ê–ù–ò–ô

        const WELCOME_MESSAGE = '–ü—Ä–∏–≤–µ—Ç! –Ø CatAI. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?';

        // === –õ–û–ì–ò–ö–ê –ú–ê–†–®–†–£–¢–ò–ó–ê–¶–ò–ò (–ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–Ø –°–¢–†–ê–ù–ò–¶) ===

        function updateView() {
            const defaultHash = currentUserId ? '#ai' : '#login';
            const hash = window.location.hash || defaultHash;
           
            pages.forEach(page => page.classList.add('hidden'));

            // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ - –æ—Å–æ–±—ã–π —Å–ª—É—á–∞–π
            if (hash === '#models') {
                document.querySelector('#ai').classList.remove('hidden'); 
                modelsModal.classList.remove('hidden');
            } else if (hash === '#admin' && isAdmin) { // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–¥–º–∏–Ω-–º–æ–¥–∞–ª–∫—É
                document.querySelector('#ai').classList.remove('hidden'); 
                adminModal.classList.remove('hidden');
            } else if (hash === '#ai' && currentUserId) { // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á–∞—Ç
                document.querySelector('#ai').classList.remove('hidden');
            } else if (hash === '#register' && !currentUserId) {
                 document.querySelector('#register').classList.remove('hidden');
            } else if (hash === '#login' && !currentUserId) {
                 document.querySelector('#login').classList.remove('hidden');
            } else {
                // –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
                if (!currentUserId) {
                    document.querySelector('#login').classList.remove('hidden');
                } else {
                    document.querySelector('#ai').classList.remove('hidden');
                }
            }
        }
        window.addEventListener('hashchange', updateView);

        // === –ì–õ–ê–í–ù–´–ô –°–õ–£–®–ê–¢–ï–õ–¨ –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò ===
        onAuthStateChanged(auth, async (user) => { // <--- 2. –°–î–ï–õ–ê–õ–ò ASYNC
            // –°–Ω–∞—á–∞–ª–∞ –≤—Å—ë —á–∏—Å—Ç–∏–º
            cleanupChatListeners();
            cleanupAdminListeners();
            currentUserId = null;
            isAdmin = false;
            adminPanelBtn.classList.add('hidden'); // –ü—Ä—è—á–µ–º –∞–¥–º–∏–Ω-–∫–Ω–æ–ø–∫—É
           
            if (user) {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª
                currentUserId = user.uid;

                if (user.email.toLowerCase() === 'admin@gmail.com') {
                    isAdmin = true;
                    adminPanelBtn.classList.remove('hidden'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–¥–º–∏–Ω-–∫–Ω–æ–ø–∫—É
                    setupAdminListeners(); // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∫–∏
                } else {
                    isAdmin = false;
                }
               
                setupChatListeners(currentUserId); // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å —á–∞—Ç–æ–≤ –î–õ–Ø –í–°–ï–•
                setupSubscriptionListener(currentUserId); // –û–ë–©–ò–ô –°–õ–£–®–ê–¢–ï–õ–¨ –ü–û–î–ü–ò–°–ö–ò (–¥–ª—è –≤—Å–µ—Ö)
                
                // === 3. –ñ–î–ï–ú –ó–ê–ì–†–£–ó–ö–ò –ë–ê–ó–´ –ó–ù–ê–ù–ò–ô ===
                await loadKnowledgeBase();

                if (window.location.hash === '#login' || window.location.hash === '#register' || !window.location.hash) {
                    window.location.hash = '#ai';
                }

            } else {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª
                knowledgeBase = {}; // <--- 4. –û–ß–ò–©–ê–ï–ú –ë–ê–ó–£ –ü–†–ò –í–´–•–û–î–ï
                if (window.location.hash !== '#login' && window.location.hash !== '#register') {
                    window.location.hash = '#login';
                }
                chatHistoryList.innerHTML = '';
                chatMessages.innerHTML = '';
            }
            updateView();
        });

        // === –õ–û–ì–ò–ö–ê –§–û–†–ú –í–•–û–î–ê –ò –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò (FIREBASE) ===
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            loginError.textContent = '';
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged —Å–∞–º –ø–µ—Ä–µ–∫–∏–Ω–µ—Ç –Ω–∞ #ai –∏–ª–∏ #admin
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:", error);
                loginError.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å.';
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-password-confirm').value;
            registerError.textContent = '';

            if (password !== confirmPassword) {
                registerError.textContent = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç.';
                return;
            }

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged –ø–æ–π–º–∞–µ—Ç –Ω–æ–≤–æ–≥–æ —é–∑–µ—Ä–∞, –Ω–æ —Å–Ω–∞—á–∞–ª–∞ –ª—É—á—à–µ
                // –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –µ–º—É –≤–æ–π—Ç–∏.
                alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏.');
                window.location.hash = '#login';
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:", error);
                registerError.textContent = '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + error.message;
            }
        });

        logoutBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            await signOut(auth);
        });
       
        // === –õ–û–ì–ò–ö–ê FIREBASE REALTIME DATABASE ===

        // === 5. –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ó–ê–ì–†–£–ó–ö–ê –ë–ê–ó–´ –ó–ù–ê–ù–ò–ô ===
        async function loadKnowledgeBase() {
            // !!! –í–ê–ñ–ù–û: –£–∫–∞–∂–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å –∫ —Ç–≤–æ–µ–º—É JSON —Ñ–∞–π–ª—É –≤ Firebase
            const KNOWLEDGE_BASE_PATH = '/'; // <--- –ò–ó–ú–ï–ù–ò –≠–¢–û –ù–ê –°–í–û–ô –ü–£–¢–¨

            console.log(`–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π –∏–∑ Firebase –ø–æ –ø—É—Ç–∏: ${KNOWLEDGE_BASE_PATH}...`);
            try {
                const dbRef = ref(db, KNOWLEDGE_BASE_PATH);
                const snapshot = await get(dbRef);
                
                if (snapshot.exists()) {
                    knowledgeBase = snapshot.val();
                    console.log('–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!', Object.keys(knowledgeBase).length, '–∑–∞–ø–∏—Å–µ–π.');
                } else {
                    console.warn('–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ –ø—É—Ç–∏:', KNOWLEDGE_BASE_PATH);
                    knowledgeBase = {}; // –û—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–º
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π:', error);
                knowledgeBase = {}; // –û—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–º –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
            }
        }

        // –°–ª—É—à–∞—Ç–µ–ª—å –ø–æ–¥–ø–∏—Å–∫–∏ (–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ –≤—Ö–æ–¥–µ)
        function setupSubscriptionListener(uid) {
            const subRef = ref(db, `users/${uid}/subscription`);
            onValue(subRef, (snapshot) => {
                subscriptionStatus = snapshot.val() || { status: 'none', model: 'base', limit: 0 };
                updateModelAvailability();
            });
        }

        function updateModelAvailability() {
            const proOption = document.querySelector('#model-select option[value="pro"]');
            if (!proOption) return;

            if (subscriptionStatus.status === 'active' && subscriptionStatus.model === 'pro') {
                proOption.disabled = false;
                proOption.textContent = `CatAI PRO (–î–æ ${subscriptionStatus.limit / 1000}–∫)`;
            } else {
                proOption.disabled = true;
                proOption.textContent = 'CatAI PRO (–ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏)';
            }
        }

        // –ì–ª–∞–≤–Ω—ã–π —Å–ª—É—à–∞—Ç–µ–ª—å —á–∞—Ç–æ–≤ (–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ –≤—Ö–æ–¥–µ)
        function setupChatListeners(uid) {
            cleanupChatListeners(); // –°–±—Ä–æ—Å —Å—Ç–∞—Ä—ã—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π

            const chatsRef = ref(db, `users/${uid}/chats`);
            chatsListener = onValue(chatsRef, (snapshot) => {
                userChatsData = snapshot.val() || {};
                renderSidebar(userChatsData);
               
                // –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –µ–≥–æ
                if (currentActiveChatId && userChatsData[currentActiveChatId]) {
                    renderChat(userChatsData[currentActiveChatId]);
                } else if (!currentActiveChatId && Object.keys(userChatsData).length > 0) {
                    // –ï—Å–ª–∏ —á–∞—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω, –≤—ã–±—Ä–∞—Ç—å –ø–µ—Ä–≤—ã–π
                    currentActiveChatId = Object.keys(userChatsData)[0];
                    renderChat(userChatsData[currentActiveChatId]);
                } else if (!currentActiveChatId) {
                    // –ï—Å–ª–∏ —á–∞—Ç–æ–≤ –Ω–µ—Ç, —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π
                    createNewChat();
                }
            });
        }

        // –û—Ç–ø–∏—Å–∫–∞ –æ—Ç —Å–ª—É—à–∞—Ç–µ–ª–µ–π
        function cleanupChatListeners() {
            if (chatsListener) {
                off(ref(db, `users/${currentUserId}/chats`), 'value', chatsListener);
                chatsListener = null;
            }
            if (purchaseListener) {
                off(ref(db, `purchaseRequests/${purchaseListener.id}`), 'value', purchaseListener.callback);
                purchaseListener = null;
            }
            userChatsData = {};
        }

        function cleanupAdminListeners() {
            if (adminListener) {
                off(ref(db, 'purchaseRequests'), 'value', adminListener);
                adminListener = null;
            }
        }

        async function createNewChat() {
            if (!currentUserId) return;
            const chatsRef = ref(db, `users/${currentUserId}/chats`);
            const newChatRef = push(chatsRef); // –°–æ–∑–¥–∞–µ–º ID
           
            await set(newChatRef, {
                title: '–ù–æ–≤—ã–π —á–∞—Ç',
                createdAt: serverTimestamp(),
                messages: [
                    { role: 'ai', content: WELCOME_MESSAGE }
                ]
            });
            currentActiveChatId = newChatRef.key;
        }

        // === –õ–û–ì–ò–ö–ê –ß–ê–¢–ê (–†–ï–ù–î–ï–†–ò–ù–ì) ===
       
        // <-- 6. –ë–õ–û–ö 'const cookingQA' –ë–´–õ –ü–û–õ–ù–û–°–¢–¨–Æ –£–î–ê–õ–ï–ù –û–¢–°–Æ–î–ê

        function renderSidebar(chatsData) {
            chatHistoryList.innerHTML = '';
            if (!chatsData) return;

            Object.entries(chatsData).forEach(([chatId, chatData]) => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = '#';
                a.dataset.chatId = chatId;
                a.textContent = chatData.title || '–ù–æ–≤—ã–π —á–∞—Ç';
                a.className = `block px-3 py-2 text-sm rounded-md truncate ${chatId === currentActiveChatId ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}`;
                li.appendChild(a);
                chatHistoryList.appendChild(li);
            });
        }

        function renderChat(chatData) {
            chatMessages.innerHTML = '';
            if (!chatData || !chatData.messages) {
                chatMessages.innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞.</p>';
                return;
            }
           
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: chatData.messages - —ç—Ç–æ –æ–±—ä–µ–∫—Ç (Object), –∞ –Ω–µ –º–∞—Å—Å–∏–≤ (Array)
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º Object.values() –¥–ª—è –∏—Ç–µ—Ä–∞—Ü–∏–∏
            Object.values(chatData.messages).forEach(msg => {
                appendMessage(msg.role, msg.content);
            });
        }

        function appendMessage(role, content) {
            const div = document.createElement('div');
            const isUser = role === 'user';
           
            const avatarChar = isUser ? 'U' : 'C';
            const avatarColor = isUser ? 'bg-indigo-600' : 'bg-blue-600';
            const title = isUser ? '–í—ã' : 'CatAI';
           
            div.className = 'flex items-start space-x-4';
            div.innerHTML = `
                <div class="flex-shrink-0 w-10 h-10 rounded-full ${avatarColor} flex items-center justify-center">
                    <span class="text-lg font-medium">${avatarChar}</span>
                </div>
                <div class="flex-1">
                    <p class="font-bold text-white">${title}</p>
                    <p class="mt-1 text-gray-300">${content}</p>
                </div>
            `;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // === 7. –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø getAIResponse ===
        // –û—Ç–≤–µ—Ç –ò–ò (—Å–∏–º—É–ª—è—Ü–∏—è)
        async function getAIResponse(userInput, chatId, selectedModel) {
            const lowerInput = userInput.toLowerCase().trim().replace('?', ''); // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∑–∞–ø—Ä–æ—Å
            let response = '';
            let modelPrefix = '';
           
            if (selectedModel === 'base') {
                modelPrefix = '(CatAI Base ‚öôÔ∏è): ';
            } else if (selectedModel === 'fast') {
                modelPrefix = '(CatAI Fast ‚ö°): ';
            } else if (selectedModel === 'pro') {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏
                if (subscriptionStatus.status !== 'active' || subscriptionStatus.model !== 'pro') {
                     response = '(CatAI): –û—à–∏–±–∫–∞! –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π PRO –ø–æ–¥–ø–∏—Å–∫–∏.';
                } else {
                    modelPrefix = `(CatAI PRO üöÄ ${subscriptionStatus.limit / 1000}–∫): `;
                }
            } else {
                modelPrefix = '(CatAI): ';
            }

            if (response) { // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –æ—Ç–≤–µ—Ç (–æ—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏)
               // response = response; // –ù–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
           
            // –ò–ó–ú–ï–ù–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê: –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –≤ –±–∞–∑–µ Q/A
            } else if (knowledgeBase[lowerInput]) {
                response = modelPrefix + knowledgeBase[lowerInput];
           
            // –ó–∞—Ç–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
            } else if (lowerInput.includes('–ø—Ä–∏–≤–µ—Ç')) {
                response = modelPrefix + '–ü—Ä–∏–≤–µ—Ç! –Ø CatAI, –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å. –ó–∞–¥–∞–π—Ç–µ –º–Ω–µ –≤–æ–ø—Ä–æ—Å –ø–æ –∫—É–ª–∏–Ω–∞—Ä–∏–∏!';
            } else if (lowerInput.includes('–∫–∞–∫ –¥–µ–ª–∞')) {
                response = modelPrefix + '–Ø CatAI, –∏ —É –º–µ–Ω—è –≤—Å–µ –≤ –ø–æ—Ä—è–¥–∫–µ. –ì–æ—Ç–æ–≤–ª—é –æ—Ç–≤–µ—Ç—ã –Ω–∞ –∫—É–ª–∏–Ω–∞—Ä–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã!';
           
            // –û—Ç–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
            } else {
                response = modelPrefix + '–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ –Ω–∞—à–µ–ª –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å –≤ —Å–≤–æ–µ–π –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å.';
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
            const chatRef = ref(db, `users/${currentUserId}/chats/${chatId}/messages`);
            const newMsgRef = push(chatRef);
            await set(newMsgRef, {
                role: 'ai',
                content: response
            });
            // onValue() –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç UI
        }

        // === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ===
       
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userInput = chatInput.value.trim();
            if (!userInput || !currentActiveChatId || !currentUserId) return;

            const selectedModel = modelSelect.value;
            chatInput.value = '';
           
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ó–∞–ø–æ–º–∏–Ω–∞–µ–º ID —á–∞—Ç–∞ –≤ –º–æ–º–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏
            const chatIdForResponse = currentActiveChatId;

            const currentChatData = userChatsData[currentActiveChatId];
            const messages = currentChatData.messages || [];
           
            // 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Firebase
            const messagesRef = ref(db, `users/${currentUserId}/chats/${currentActiveChatId}/messages`);
            const newUserMsgRef = push(messagesRef);
            await set(newUserMsgRef, {
                role: 'user',
                content: userInput
            });
           
            // 2. –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–ø–æ—Å–ª–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è), –æ–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞
            if (messages.length === 1 && currentChatData.title === '–ù–æ–≤—ã–π —á–∞—Ç') {
                const chatTitleRef = ref(db, `users/${currentUserId}/chats/${currentActiveChatId}/title`);
                await set(chatTitleRef, userInput.substring(0, 30));
            }

            // 3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–ø–µ—á–∞—Ç–∞–µ—Ç" –∏ –∂–¥–µ–º –æ—Ç–≤–µ—Ç
            typingIndicator.classList.remove('hidden');
           
            // –°–∏–º—É–ª—è—Ü–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏ –æ—Ç–≤–µ—Ç–∞ –ò–ò
            setTimeout(() => {
                // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ë—ã–ª–∞ –æ—à–∏–±–∫–∞ ReferenceError: 'chatId' –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω.
                // –ó–∞–º–µ–Ω—è–µ–º 'chatId' –Ω–∞ 'chatIdForResponse'
                if (currentActiveChatId === chatIdForResponse) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤ —Ç–æ–º –ª–∏ –º—ã —á–∞—Ç–µ
                    typingIndicator.classList.add('hidden');
                }
                getAIResponse(userInput, chatIdForResponse, selectedModel);
            }, 1500);
        });

        newChatBtn.addEventListener('click', () => {
            createNewChat();
        });

        chatHistoryList.addEventListener('click', (e) => {
            e.preventDefault();
            const link = e.target.closest('a[data-chat-id]');
            if (!link) return;

            const chatId = link.dataset.chatId;
            if (chatId === currentActiveChatId) return; // –ù–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –Ω–∞ —Ç–æ—Ç –∂–µ —á–∞—Ç
           
            currentActiveChatId = chatId;
            // onValue —Å–∞–º –ø–µ—Ä–µ—Ä–∏—Å—É–µ—Ç —Å–∞–π–¥–±–∞—Ä (–≤—ã–¥–µ–ª–∏—Ç –∞–∫—Ç–∏–≤–Ω—ã–π)
            // –∏ –≤—ã–∑–æ–≤–µ—Ç renderChat
            renderSidebar(userChatsData);
            renderChat(userChatsData[currentActiveChatId]);
           
            // –°–∫—Ä—ã—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä, –µ—Å–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è
            typingIndicator.classList.add('hidden');
        });

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (–ú–æ–¥–µ–ª–∏)
        function resetModal() {
             // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            modalStateDefault.classList.remove('hidden');
            modalStateWaiting.classList.add('hidden');
            modalStateError.classList.add('hidden');
           
            limitSelectionFieldset.classList.add('hidden');
            purchaseBtn.disabled = true;
            purchaseBtn.textContent = '–û–ø–ª–∞—Ç–∏—Ç—å (–°–∫–æ—Ä–æ)';
            modelSelectionRadios.forEach(radio => radio.checked = false);
            limitSelectionRadios.forEach(radio => radio.checked = false);

            // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç —Å—Ç–∞—Ä–æ–≥–æ —Å–ª—É—à–∞—Ç–µ–ª—è –∑–∞–ø—Ä–æ—Å–∞, –µ—Å–ª–∏ –æ–Ω –±—ã–ª
            if(purchaseListener) {
                off(ref(db, `purchaseRequests/${purchaseListener.id}`), 'value', purchaseListener.callback);
                purchaseListener = null;
            }
        }

        modelsBtn.addEventListener('click', (e) => {
            e.preventDefault();
            window.location.hash = '#models'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º hash
        });

        closeModalBtn.addEventListener('click', () => {
            window.location.hash = '#ai'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º hash
            resetModal(); // –°–±—Ä–æ—Å –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        });

        modalBackdrop.addEventListener('click', () => {
            window.location.hash = '#ai'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º hash
            resetModal(); // –°–±—Ä–æ—Å –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        });
       
        closeErrorBtn.addEventListener('click', () => {
            resetModal(); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—ã–±–æ—Ä–∞
        });

        modelSelectionRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                if (radio.value === 'pro') {
                    limitSelectionFieldset.classList.remove('hidden');
                    purchaseBtn.disabled = true; // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –ª–∏–º–∏—Ç–∞
                    purchaseBtn.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –ª–∏–º–∏—Ç';
                } else {
                    limitSelectionFieldset.classList.add('hidden');
                    purchaseBtn.disabled = true; // –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –º–æ–¥–µ–ª–∏ –ø–æ–∫–∞ –Ω–µ–ª—å–∑—è "–∫—É–ø–∏—Ç—å"
                    purchaseBtn.textContent = '–í—ã–±—Ä–∞—Ç—å (–°–∫–æ—Ä–æ)';
                }
            });
        });

        limitSelectionRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                purchaseBtn.textContent = '–û–ø–ª–∞—Ç–∏—Ç—å'; // –¢–ï–ü–ï–†–¨ –ú–û–ñ–ù–û –û–ü–õ–ê–¢–ò–¢–¨
                purchaseBtn.disabled = false; // –†–ê–ó–ë–õ–û–ö–ò–†–£–ï–ú –ö–ù–û–ü–ö–£
            });
        });
       
        // –û–ë–†–ê–ë–û–¢–ß–ò–ö –ü–û–ö–£–ü–ö–ò
        purchaseBtn.addEventListener('click', async () => {
            if (!currentUserId || !auth.currentUser) return;
           
            const selectedModelRadio = document.querySelector('input[name="model-selection"]:checked');
            const selectedLimitRadio = document.querySelector('input[name="limit-selection"]:checked');
           
            if (!selectedModelRadio || (selectedModelRadio.value === 'pro' && !selectedLimitRadio)) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å –∏ –ª–∏–º–∏—Ç.");
                return;
            }

            const model = selectedModelRadio.value;
            const limitText = selectedLimitRadio ? selectedLimitRadio.value.replace('k', '') : '0';
            const limit = parseInt(limitText) * 1000;
            const userEmail = auth.currentUser.email;

            // 1. –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤ —Ä–µ–∂–∏–º "–û–∂–∏–¥–∞–Ω–∏–µ"
            modalStateDefault.classList.add('hidden');
            modalStateWaiting.classList.remove('hidden');
           
            try {
                // 2. –°–æ–∑–¥–∞–µ–º –∑–∞–ø—Ä–æ—Å –≤ Firebase
                const requestsRef = ref(db, 'purchaseRequests');
                const newRequestRef = push(requestsRef); // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π ID
                const requestId = newRequestRef.key;
               
                await set(newRequestRef, {
                    userId: currentUserId,
                    userEmail: userEmail,
                    model: model,
                    limit: limit,
                    status: 'pending', // –°—Ç–∞—Ç—É—Å "–≤ –æ–∂–∏–¥–∞–Ω–∏–∏"
                    timestamp: serverTimestamp()
                });

                // 3. –ù–∞—á–∏–Ω–∞–µ–º —Å–ª—É—à–∞—Ç—å –ò–ó–ú–ï–ù–ï–ù–ò–Ø —ç—Ç–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
                const requestCallback = onValue(newRequestRef, (snapshot) => {
                    const data = snapshot.val();
                    if (!data) return; // –ó–∞–ø—Ä–æ—Å –º–æ–≥ –±—ã—Ç—å —É–¥–∞–ª–µ–Ω

                    if (data.status === 'confirmed') {
                        // –£–°–ü–ï–•!
                        if(purchaseListener) {
                            off(ref(db, `purchaseRequests/${purchaseListener.id}`), 'value', purchaseListener.callback);
                            purchaseListener = null;
                        }
                        modelsModal.classList.add('hidden'); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
                        resetModal();
                        alert('–ü–æ–¥–ø–∏—Å–∫–∞ —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!');
                        // updateModelAvailability() –≤—ã–∑–æ–≤–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ setupSubscriptionListener
                    } 
                   
                    if (data.status === 'canceled') {
                        // –û–¢–ö–ê–ó!
                        if(purchaseListener) {
                            off(ref(db, `purchaseRequests/${purchaseListener.id}`), 'value', purchaseListener.callback);
                            purchaseListener = null;
                        }
                        modalStateWaiting.classList.add('hidden');
                        modalStateError.classList.remove('hidden');
                        modalErrorMessage.textContent = data.reason || '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ—Ç–∫–ª–æ–Ω–∏–ª –≤–∞—à –∑–∞–ø—Ä–æ—Å.';
                    }
                });

                purchaseListener = { id: requestId, callback: requestCallback };

            } catch (error) {
                modalStateWaiting.classList.add('hidden');
                modalStateError.classList.remove('hidden');
                modalErrorMessage.textContent = '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞: ' + error.message;
            }
        });

        // ========================
        // === –õ–û–ì–ò–ö–ê –ê–î–ú–ò–ù–ö–ò ===
        // ========================
       
        // –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –î–õ–Ø –ê–î–ú–ò–ù-–ú–û–î–ê–õ–ö–ò
        adminPanelBtn.addEventListener('click', (e) => {
            e.preventDefault();
            window.location.hash = '#admin';
        });

        closeAdminModalBtn.addEventListener('click', () => {
            window.location.hash = '#ai';
        });

        adminModalBackdrop.addEventListener('click', () => {
            window.location.hash = '#ai';
        });

        function setupAdminListeners() {
            cleanupAdminListeners(); // –ß–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–π, –µ—Å–ª–∏ –µ—Å—Ç—å
            const requestsRef = ref(db, 'purchaseRequests');
           
            // –°–ª—É—à–∞–µ–º –í–°–ï –∑–∞–ø—Ä–æ—Å—ã
            adminListener = onValue(requestsRef, (snapshot) => {
                const requests = snapshot.val() || {};
                renderAdminPanel(requests);
            });
        }
       
        function renderAdminPanel(requests) {
            adminRequestsList.innerHTML = '';
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º: —Å–Ω–∞—á–∞–ª–∞ 'pending', –ø–æ—Ç–æ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ
            const sortedRequests = Object.entries(requests).sort(([, a], [, b]) => {
                if (a.status === 'pending' && b.status !== 'pending') return -1;
                if (a.status !== 'pending' && b.status === 'pending') return 1;
                return (b.timestamp || 0) - (a.timestamp || 0); // –ù–æ–≤—ã–µ –≤–≤–µ—Ä—Ö—É
            });
           
            if (sortedRequests.length === 0) {
                adminRequestsList.innerHTML = '<p class="text-gray-500">–ù–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤.</p>';
                return;
            }

            sortedRequests.forEach(([requestId, request]) => {
                const card = document.createElement('div');
                card.className = 'bg-gray-700 p-4 rounded-lg flex justify-between items-center';
               
                const date = request.timestamp ? new Date(request.timestamp).toLocaleString() : '...';
               
                let buttonsHtml = '';
                if (request.status === 'pending') {
                    buttonsHtml = `
                        <div class="space-x-2 flex-shrink-0">
                            <button data-id="${requestId}" data-action="confirm" class="px-3 py-1 bg-green-600 text-white text-sm rounded-md hover:bg-green-700">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                            <button data-id="${requestId}" data-action="cancel" class="px-3 py-1 bg-red-600 text-white text-sm rounded-md hover:bg-red-700">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                        </div>
                    `;
                } else if (request.status === 'confirmed') {
                    buttonsHtml = `<span class="text-sm text-green-400 font-medium">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω</span>`;
                } else if (request.status === 'canceled') {
                    buttonsHtml = `<span class="text-sm text-red-400 font-medium">–û—Ç–∫–ª–æ–Ω–µ–Ω</span>`;
                }
               
                card.innerHTML = `
                    <div class="flex-1 min-w-0 mr-4">
                        <p class="font-semibold text-white truncate">${request.userEmail}</p>
                        <p class="text-sm text-gray-300">
                            –•–æ—á–µ—Ç: <strong>${request.model.toUpperCase()}</strong>, 
                            –õ–∏–º–∏—Ç: <strong>${request.limit}</strong>
                        </p>
                        <p class="text-xs text-gray-400 mt-1">${date}</p>
                    </div>
                    ${buttonsHtml}
                `;
                adminRequestsList.appendChild(card);
            });
        }
       
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫ –∞–¥–º–∏–Ω–∫–∏
        adminRequestsList.addEventListener('click', async (e) => {
            const button = e.target.closest('button[data-id]');
            if (!button) return;

            const requestId = button.dataset.id;
            const action = button.dataset.action;
           
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
            button.disabled = true;
            button.textContent = '...';
           
            const requestRef = ref(db, `purchaseRequests/${requestId}`);
           
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º 'get' –¥–ª—è —Ä–∞–∑–æ–≤–æ–≥–æ —á—Ç–µ–Ω–∏—è
            const requestSnapshot = await get(requestRef);
            const requestData = requestSnapshot.val();
           
            if (!requestData) {
                console.error("–ó–∞–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                return;
            }

            const targetUserId = requestData.userId;

            if (action === 'confirm') {
                // 1. –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É —é–∑–µ—Ä–∞
                const subRef = ref(db, `users/${targetUserId}/subscription`);
                await set(subRef, {
                    model: requestData.model,
                    limit: requestData.limit,
                    status: 'active',
                    activatedAt: serverTimestamp()
                });
               
                // 2. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–ø—Ä–æ—Å–∞ (—é–∑–µ—Ä –ø–æ–ª—É—á–∏—Ç —ç—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
                await update(requestRef, { status: 'confirmed' });

            } else if (action === 'cancel') {
                // 1. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–ø—Ä–æ—Å–∞ —Å –ø—Ä–∏—á–∏–Ω–æ–π
                await update(requestRef, { 
                    status: 'canceled',
                    reason: '–ó–∞–ø—Ä–æ—Å –æ—Ç–∫–ª–æ–Ω–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.'
                });
            }
        });

    </script>

</body>
</html>
