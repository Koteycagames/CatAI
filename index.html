<!DOCTYPE html>
<html lang="ru" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CatAI Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Прячем нативные стрелки у <select> */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        /* Стилизация скроллбара */
        #chat-messages::-webkit-scrollbar {
            width: 8px; /* Ширина */
        }
        #chat-messages::-webkit-scrollbar-track {
            background: #2d3748; /* Цвет фона трека */
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background-color: #4a5568; /* Цвет ползунка */
            border-radius: 20px; /* Скругление */
        }
        /* Стилизация скроллбара для сайдбара */
        #chat-history-list::-webkit-scrollbar {
            width: 6px;
        }
        #chat-history-list::-webkit-scrollbar-track {
            background: #1a202c; 
        }
        #chat-history-list::-webkit-scrollbar-thumb {
            background-color: #4a5568;
            border-radius: 20px;
        }
    </style>
</head>
<body class="bg-gray-900 text-white h-full overflow-hidden">

    <!-- ======================= -->
    <!--      ЭКРАН ВХОДА        -->
    <!-- ======================= -->
    <section id="login" class="page flex items-center justify-center h-full">
        <div class="w-full max-w-md p-8 space-y-6 bg-gray-800 rounded-lg shadow-lg">
            <h2 class="text-3xl font-bold text-center text-white">Вход в CatAI</h2>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="login-email" class="text-sm font-medium text-gray-300 block mb-2">Email</label>
                    <input type="email" id="login-email" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" value="" required>
                </div>
                <div>
                    <label for="login-password" class="text-sm font-medium text-gray-300 block mb-2">Пароль</label>
                    <input type="password" id="login-password" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" value="" required>
                </div>
                <button type="submit" class="w-full px-4 py-2 font-bold text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                    Войти
                </button>
            </form>
            <p id="login-error" class="text-sm text-red-500 text-center"></p>
            <p class="text-sm text-center text-gray-400">
                Нет аккаунта? <a href="#register" class="font-medium text-blue-500 hover:text-blue-400">Регистрация</a>
            </p>
        </div>
    </section>

    <!-- ======================= -->
    <!--    ЭКРАН РЕГИСТРАЦИИ    -->
    <!-- ======================= -->
    <section id="register" class="page hidden items-center justify-center h-full">
        <div class="w-full max-w-md p-8 space-y-6 bg-gray-800 rounded-lg shadow-lg">
            <h2 class="text-3xl font-bold text-center text-white">Регистрация в CatAI</h2>
            <form id="register-form" class="space-y-6">
                <div>
                    <label for="register-email" class="text-sm font-medium text-gray-300 block mb-2">Email</label>
                    <input type="email" id="register-email" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="register-password" class="text-sm font-medium text-gray-300 block mb-2">Пароль</label>
                    <input type="password" id="register-password" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="register-password-confirm" class="text-sm font-medium text-gray-300 block mb-2">Повторите Пароль</label>
                    <input type="password" id="register-password-confirm" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <button type="submit" class="w-full px-4 py-2 font-bold text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                    Зарегистрироваться
                </button>
            </form>
            <p id="register-error" class="text-sm text-red-500 text-center"></p>
            <p class="text-sm text-center text-gray-400">
                Уже есть аккаунт? <a href="#login" class="font-medium text-blue-500 hover:text-blue-400">Войти</a>
            </p>
        </div>
    </section>

    <!-- ======================= -->
    <!--       ЭКРАН ЧАТА        -->
    <!-- ======================= -->
    <section id="ai" class="page hidden h-full flex overflow-hidden">
        
        <!-- === САЙДБАР (Навигация) === -->
        <div class="flex-shrink-0 w-64 bg-gray-950 flex flex-col border-r border-gray-700">
            <!-- Кнопка Нового Чата -->
            <div class="p-4 border-b border-gray-700">
                <button id="new-chat-btn" class="flex items-center justify-between w-full px-3 py-2 text-sm font-medium text-left text-white bg-gray-800 rounded-md hover:bg-gray-700">
                    Новый чат
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                </button>
            </div>
            
            <!-- Список Чатов -->
            <nav id="chat-history-list" class="flex-1 overflow-y-auto space-y-1 p-4">
                <!-- Сюда JS будет добавлять ссылки на чаты -->
            </nav>
            
            <!-- Футер сайдбара -->
            <div class="border-t border-gray-700 p-4">
                 <!-- КНОПКА МОДЕЛИ -->
                 <a href="#models" id="models-btn" class="flex w-full items-center px-3 py-2 text-sm font-medium rounded-md text-gray-400 hover:bg-gray-800 hover:text-white mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M5 2a1 1 0 00-1 1v1h1a1 1 0 010 2H4v1a1 1 0 001 1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1V9a1 1 0 011-1h2a1 1 0 001-1V6h-1a1 1 0 110-2h1V3a1 1 0 00-1-1H5zM2 13v3a1 1 0 001 1h3a1 1 0 001-1v-3a1 1 0 00-1-1H3a1 1 0 00-1 1zm14 0v3a1 1 0 001 1h3a1 1 0 001-1v-3a1 1 0 00-1-1h-3a1 1 0 00-1 1z" clip-rule="evenodd" />
                    </svg>
                    Модели
                </a>
                 <!-- /КНОПКА МОДЕЛИ -->

                 <!-- НОВАЯ КНОПКА АДМИН-ПАНЕЛИ (скрыта по умолчанию) -->
                 <a href="#admin" id="admin-panel-btn" class="hidden flex w-full items-center px-3 py-2 text-sm font-medium rounded-md text-yellow-400 hover:bg-gray-800 hover:text-white mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 8a6 6 0 01-7.743 5.743L10 14l-1 1-1 1H6v2H2v-4l4.257-4.257A6 6 0 1118 8zm-6-4a4 4 0 100 8 4 4 0 000-8z" clip-rule="evenodd" />
                    </svg>
                    Админ-панель
                </a>
                 <!-- /КНОПКА АДМИН-ПАНЕЛИ -->

                 <a href="#login" id="logout-btn" class="flex w-full items-center px-3 py-2 text-sm font-medium rounded-md text-gray-400 hover:bg-gray-800 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V5.414L12.586 14 14 12.586 5.414 4H16a1 1 0 100-2H4a1 1 0 00-1 1z" clip-rule="evenodd" />
                    </svg>
                    Выйти
                </a>
            </div>
        </div>
        
        <!-- === ОСНОВНОЕ ОКНО ЧАТА === -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Окно сообщений -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-6">
                <!-- Сюда JS будет добавлять сообщения -->
            </div>
            
            <!-- Индикатор "Печатает..." -->
            <div id="typing-indicator" class="hidden px-6 py-2 text-sm text-gray-400">
                CatAI печатает...
            </div>
            
            <!-- Форма отправки -->
            <div class="p-6 border-t border-gray-700 bg-gray-900">
                <form id="chat-form" class="flex items-center space-x-4">
                    <!-- Выбор модели -->
                    <div class="relative">
                        <select id="model-select" class="w-40 bg-gray-800 border border-gray-700 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 pr-8">
                            <option value="base">CatAI base</option>
                            <option value="fast">CatAI Fast</option>
                            <option value="pro" disabled>CatAI PRO (Нет подписки)</option>
                        </select>
                        <svg class="w-4 h-4 text-gray-400 absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>

                    <!-- Поле ввода -->
                    <input type="text" id="chat-input" placeholder="Введите ваше сообщение..." class="flex-1 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="off">
                    
                    <!-- Кнопка Отправить -->
                    <button type="submit" class="p-2 bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <svg class="w-6 h-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                        </svg>
                    </button>
                </form>
            </div>
        </div>
    </section>

    <!-- ======================= -->
    <!--     МОДАЛЬНОЕ ОКНО      -->
    <!-- ======================= -->
    <div id="models-modal" class="page hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <!-- Фон-оверлей -->
            <div id="modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity" aria-hidden="true"></div>

            <!-- Контент модального окна -->
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                
                <!-- 1. Форма выбора (по умолчанию) -->
                <div id="modal-state-default">
                    <div class="bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-600 sm:mx-0 sm:h-10 sm:w-10">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M5 2a1 1 0 00-1 1v1h1a1 1 0 010 2H4v1a1 1 0 001 1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1V9a1 1 0 011-1h2a1 1 0 001-1V6h-1a1 1 0 110-2h1V3a1 1 0 00-1-1H5zM2 13v3a1 1 0 001 1h3a1 1 0 001-1v-3a1 1 0 00-1-1H3a1 1 0 00-1 1zm14 0v3a1 1 0 001 1h3a1 1 0 001-1v-3a1 1 0 00-1-1h-3a1 1 0 00-1 1z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                                <h3 class="text-lg leading-6 font-medium text-white" id="modal-title">
                                    Модели CatAI
                                </h3>
                                <div class="mt-2">
                                    <p class="text-sm text-gray-400">
                                        Выберите модель, которая подходит под ваши задачи. PRO-модели требуют активной подписки.
                                    </p>
                                </div>
                            </div>
                        </div>
                        <!-- ИНТЕРАКТИВНЫЙ БЛОК ВЫБОРА -->
                        <div class="mt-6 space-y-6">
                            <!-- 1. Выбор Модели -->
                            <fieldset>
                                <legend class="text-base font-medium text-white">Выберите модель</legend>
                                <div class="mt-4 space-y-2">
                                    <label for="model-base" class="flex items-center p-3 rounded-lg bg-gray-700 hover:bg-gray-600 cursor-pointer">
                                        <input id="model-base" name="model-selection" type="radio" value="base" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-500">
                                        <span class="ml-3 text-sm font-medium text-white">CatAI base (Бесплатно)</span>
                                    </label>
                                    <label for="model-fast" class="flex items-center p-3 rounded-lg bg-gray-700 hover:bg-gray-600 cursor-pointer">
                                        <input id="model-fast" name="model-selection" type="radio" value="fast" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-500">
                                        <span class="ml-3 text-sm font-medium text-white">CatAI Fast (Бесплатно)</span>
                                    </label>
                                    <label for="model-pro" class="flex items-center p-3 rounded-lg bg-gray-700 hover:bg-gray-600 cursor-pointer">
                                        <input id="model-pro" name="model-selection" type="radio" value="pro" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-500">
                                        <span class="ml-3 text-sm font-medium text-white">CatAI PRO (Требует оплаты)</span>
                                    </label>
                                </div>
                            </fieldset>

                            <!-- 2. Выбор Лимита (скрыт) -->
                            <fieldset id="limit-selection-fieldset" class="hidden">
                                <legend class="text-base font-medium text-white">Выберите лимит (для PRO)</legend>
                                <div class="mt-4 grid grid-cols-3 gap-3">
                                    <label for="limit-1k" class="flex items-center justify-center p-3 rounded-lg bg-gray-700 hover:bg-gray-600 cursor-pointer text-sm font-medium text-white">
                                        <input id="limit-1k" name="limit-selection" type="radio" value="1k" class="sr-only">
                                        <span>1к</span>
                                    </label>
                                    <label for="limit-3k" class="flex items-center justify-center p-3 rounded-lg bg-gray-700 hover:bg-gray-600 cursor-pointer text-sm font-medium text-white">
                                        <input id="limit-3k" name="limit-selection" type="radio" value="3k" class="sr-only">
                                        <span>3к</span>
                                    </label>
                                    <label for="limit-5k" class="flex items-center justify-center p-3 rounded-lg bg-gray-700 hover:bg-gray-600 cursor-pointer text-sm font-medium text-white">
                                        <input id="limit-5k" name="limit-selection" type="radio" value="5k" class="sr-only">
                                        <span>5к</span>
                                    </label>
                                    <label for="limit-10k" class="flex items-center justify-center p-3 rounded-lg bg-gray-700 hover:bg-gray-600 cursor-pointer text-sm font-medium text-white">
                                        <input id="limit-10k" name="limit-selection" type="radio" value="10k" class="sr-only">
                                        <span>10к</span>
                                    </label>
                                    <label for="limit-30k" class="flex items-center justify-center p-3 rounded-lg bg-gray-700 hover:bg-gray-600 cursor-pointer text-sm font-medium text-white">
                                        <input id="limit-30k" name="limit-selection" type="radio" value="30k" class="sr-only">
                                        <span>30к</span>
                                    </label>
                                </div>
                            </fieldset>
                        </div>
                    </div>
                    <!-- Футер модального окна -->
                    <div class="bg-gray-800 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse border-t border-gray-700">
                        <button id="purchase-btn" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm" disabled>
                            Оплатить (Скоро)
                        </button>
                        <button id="close-modal-btn" type="button" class="mt-3 sm:mt-0 w-full inline-flex justify-center rounded-md border border-gray-600 shadow-sm px-4 py-2 bg-gray-700 text-base font-medium text-white hover:bg-gray-600 focus:outline-none sm:w-auto sm:text-sm">
                            Закрыть
                        </button>
                    </div>
                </div>

                <!-- 2. Ожидание -->
                <div id="modal-state-waiting" class="hidden">
                    <div class="bg-gray-800 px-4 pt-5 pb-8 sm:p-6 sm:pb-8 text-center">
                        <h3 class="text-lg font-medium text-white">Ожидание подтверждения...</h3>
                        <p class="text-sm text-gray-400 mt-2">Пожалуйста, не закрывайте это окно. Админ получил ваш запрос.</p>
                        <!-- Анимация спиннера -->
                        <svg class="animate-spin h-8 w-8 text-blue-500 mx-auto mt-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                </div>

                <!-- 3. Ошибка -->
                <div id="modal-state-error" class="hidden">
                    <div class="bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-600 sm:mx-0 sm:h-10 sm:w-10">
                                <svg class="h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </div>
                            <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                                <h3 class="text-lg leading-6 font-medium text-white">Запрос отклонен</h3>
                                <div class="mt-2">
                                    <p class="text-sm text-gray-400" id="modal-error-message">Администратор отклонил ваш запрос. Пожалуйста, попробуйте позже.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-800 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse border-t border-gray-700">
                        <button id="close-error-btn" type="button" class="w-full inline-flex justify-center rounded-md border border-gray-600 shadow-sm px-4 py-2 bg-gray-700 text-base font-medium text-white hover:bg-gray-600 focus:outline-none sm:w-auto sm:text-sm">
                            Закрыть
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>


    <!-- ======================= -->
    <!-- МОДАЛЬНОЕ ОКНО АДМИНА -->
    <!-- ======================= -->
    <div id="admin-modal" class="page hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="admin-modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <!-- Фон-оверлей -->
            <div id="admin-modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity" aria-hidden="true"></div>

            <!-- Контент модального окна -->
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
                <div class="bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-yellow-600 sm:mx-0 sm:h-10 sm:w-10">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 8a6 6 0 01-7.743 5.743L10 14l-1 1-1 1H6v2H2v-4l4.257-4.257A6 6 0 1118 8zm-6-4a4 4 0 100 8 4 4 0 000-8z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-white" id="admin-modal-title">
                                Админ-панель: Запросы
                            </h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-400">
                                    Подтвердите или отклоните запросы на покупку подписки.
                                </p>
                            </div>
                        </div>
                    </div>
                    <!-- Список запросов -->
                    <div class="mt-6">
                        <h2 class="text-lg font-semibold mb-4 text-white">Активные запросы</h2>
                        <div id="admin-requests-list" class="space-y-3 max-h-96 overflow-y-auto">
                            <!-- Запросы будут рендериться сюда -->
                            <p class="text-gray-500">Ожидание новых запросов...</p>
                        </div>
                    </div>
                </div>
                <!-- Футер модального окна -->
                <div class="bg-gray-800 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse border-t border-gray-700">
                    <button id="close-admin-modal-btn" type="button" class="mt-3 sm:mt-0 w-full inline-flex justify-center rounded-md border border-gray-600 shadow-sm px-4 py-2 bg-gray-700 text-base font-medium text-white hover:bg-gray-600 focus:outline-none sm:w-auto sm:text-sm">
                        Закрыть
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- 
      ========================================
      FIREBASE SDKs
      ========================================
    -->
    <script type="module">
        // Импорты Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        // ИСПРАВЛЕНИЕ: Добавлен 'get'
        import { getDatabase, ref, onValue, push, set, serverTimestamp, update, off, get } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        // Твоя конфигурация Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCcgLac2riawIGPHsdkXLOeFTEY_TUZX_s",
            authDomain: "catai-1624d.firebaseapp.com",
            databaseURL: "https://catai-1624d-default-rtdb.firebaseio.com",
            projectId: "catai-1624d",
            storageBucket: "catai-1624d.firebasestorage.app",
            messagingSenderId: "565260079109",
            appId: "1:565260079109:web:fd10c337a424555c0b0c6c"
        };

        // Инициализация Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // === ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ===
        const pages = document.querySelectorAll('.page');
        
        // Формы
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const registerForm = document.getElementById('register-form');
        const registerError = document.getElementById('register-error');

        // Чат
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');
        const typingIndicator = document.getElementById('typing-indicator');
        const modelSelect = document.getElementById('model-select');
        const newChatBtn = document.getElementById('new-chat-btn');
        const chatHistoryList = document.getElementById('chat-history-list');
        const logoutBtn = document.getElementById('logout-btn');

        // Модальное окно (Модели)
        const modelsBtn = document.getElementById('models-btn');
        const modelsModal = document.getElementById('models-modal');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const limitSelectionFieldset = document.getElementById('limit-selection-fieldset');
        const modelSelectionRadios = document.querySelectorAll('input[name="model-selection"]');
        const purchaseBtn = document.getElementById('purchase-btn');
        const limitSelectionRadios = document.querySelectorAll('input[name="limit-selection"]');
        const modalStateDefault = document.getElementById('modal-state-default');
        const modalStateWaiting = document.getElementById('modal-state-waiting');
        const modalStateError = document.getElementById('modal-state-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const closeErrorBtn = document.getElementById('close-error-btn');
        
        // Модальное окно (Админ)
        const adminPanelBtn = document.getElementById('admin-panel-btn');
        const adminModal = document.getElementById('admin-modal');
        const adminModalBackdrop = document.getElementById('admin-modal-backdrop');
        const closeAdminModalBtn = document.getElementById('close-admin-modal-btn');
        
        // Админ-панель
        const adminRequestsList = document.getElementById('admin-requests-list');

        // Состояние приложения
        let currentUserId = null;
        let isAdmin = false; 
        let userChatsData = {}; // Кэш данных из RTDB
        let currentActiveChatId = null;
        let chatsListener = null; // Хранит функцию отписки от onValue
        let adminListener = null; 
        let purchaseListener = null; 
        let subscriptionStatus = { status: 'none', model: 'base', limit: 0 }; 

        const WELCOME_MESSAGE = 'Привет! Я CatAI. Чем могу помочь?';

        // === ЛОГИКА МАРШРУТИЗАЦИИ (ПЕРЕКЛЮЧЕНИЯ СТРАНИЦ) ===

        function updateView() {
            const defaultHash = currentUserId ? '#ai' : '#login';
            const hash = window.location.hash || defaultHash;
            
            pages.forEach(page => page.classList.add('hidden'));

            // Модальные окна - особый случай
            if (hash === '#models') {
                document.querySelector('#ai').classList.remove('hidden'); 
                modelsModal.classList.remove('hidden');
            } else if (hash === '#admin' && isAdmin) { // Показываем админ-модалку
                document.querySelector('#ai').classList.remove('hidden'); 
                adminModal.classList.remove('hidden');
            } else if (hash === '#ai' && currentUserId) { // Показываем чат
                document.querySelector('#ai').classList.remove('hidden');
            } else if (hash === '#register' && !currentUserId) {
                 document.querySelector('#register').classList.remove('hidden');
            } else if (hash === '#login' && !currentUserId) {
                 document.querySelector('#login').classList.remove('hidden');
            } else {
                // Запасной вариант
                if (!currentUserId) {
                    document.querySelector('#login').classList.remove('hidden');
                } else {
                    document.querySelector('#ai').classList.remove('hidden');
                }
            }
        }
        window.addEventListener('hashchange', updateView);

        // === ГЛАВНЫЙ СЛУШАТЕЛЬ АУТЕНТИФИКАЦИИ ===
        onAuthStateChanged(auth, (user) => {
            // Сначала всё чистим
            cleanupChatListeners();
            cleanupAdminListeners();
            currentUserId = null;
            isAdmin = false;
            adminPanelBtn.classList.add('hidden'); // Прячем админ-кнопку
            
            if (user) {
                // Пользователь вошел
                currentUserId = user.uid;

                if (user.email.toLowerCase() === 'admin@gmail.com') {
                    isAdmin = true;
                    adminPanelBtn.classList.remove('hidden'); // Показываем админ-кнопку
                    setupAdminListeners(); // Запускаем слушатель админки
                } else {
                    isAdmin = false;
                }
                
                if (window.location.hash === '#login' || window.location.hash === '#register' || !window.location.hash) {
                    window.location.hash = '#ai';
                }
                setupChatListeners(currentUserId); // Запускаем слушатель чатов ДЛЯ ВСЕХ
                setupSubscriptionListener(currentUserId); // ОБЩИЙ СЛУШАТЕЛЬ ПОДПИСКИ (для всех)

            } else {
                // Пользователь вышел
                if (window.location.hash !== '#login' && window.location.hash !== '#register') {
                    window.location.hash = '#login';
                }
                chatHistoryList.innerHTML = '';
                chatMessages.innerHTML = '';
            }
            updateView();
        });

        // === ЛОГИКА ФОРМ ВХОДА И РЕГИСТРАЦИИ (FIREBASE) ===
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            loginError.textContent = '';
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged сам перекинет на #ai или #admin
            } catch (error) {
                console.error("Ошибка входа:", error);
                loginError.textContent = 'Неверный email или пароль.';
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-password-confirm').value;
            registerError.textContent = '';

            if (password !== confirmPassword) {
                registerError.textContent = 'Пароли не совпадают.';
                return;
            }

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged поймает нового юзера, но сначала лучше
                // предложить ему войти.
                alert('Регистрация успешна! Теперь вы можете войти.');
                window.location.hash = '#login';
            } catch (error) {
                console.error("Ошибка регистрации:", error);
                registerError.textContent = 'Ошибка регистрации: ' + error.message;
            }
        });

        logoutBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            await signOut(auth);
        });
        
        // === ЛОГИКА FIREBASE REALTIME DATABASE ===

        // Слушатель подписки (запускается при входе)
        function setupSubscriptionListener(uid) {
            const subRef = ref(db, `users/${uid}/subscription`);
            onValue(subRef, (snapshot) => {
                subscriptionStatus = snapshot.val() || { status: 'none', model: 'base', limit: 0 };
                updateModelAvailability();
            });
        }

        function updateModelAvailability() {
            const proOption = document.querySelector('#model-select option[value="pro"]');
            if (!proOption) return;

            if (subscriptionStatus.status === 'active' && subscriptionStatus.model === 'pro') {
                proOption.disabled = false;
                proOption.textContent = `CatAI PRO (До ${subscriptionStatus.limit / 1000}к)`;
            } else {
                proOption.disabled = true;
                proOption.textContent = 'CatAI PRO (Нет подписки)';
            }
        }

        // Главный слушатель чатов (запускается при входе)
        function setupChatListeners(uid) {
            cleanupChatListeners(); // Сброс старых слушателей

            const chatsRef = ref(db, `users/${uid}/chats`);
            chatsListener = onValue(chatsRef, (snapshot) => {
                userChatsData = snapshot.val() || {};
                renderSidebar(userChatsData);
                
                // Если активный чат существует, отрисовать его
                if (currentActiveChatId && userChatsData[currentActiveChatId]) {
                    renderChat(userChatsData[currentActiveChatId]);
                } else if (!currentActiveChatId && Object.keys(userChatsData).length > 0) {
                    // Если чат не выбран, выбрать первый
                    currentActiveChatId = Object.keys(userChatsData)[0];
                    renderChat(userChatsData[currentActiveChatId]);
                } else if (!currentActiveChatId) {
                    // Если чатов нет, создать новый
                    createNewChat();
                }
            });
        }

        // Отписка от слушателей
        function cleanupChatListeners() {
            if (chatsListener) {
                off(ref(db, `users/${currentUserId}/chats`), 'value', chatsListener);
                chatsListener = null;
            }
            if (purchaseListener) {
                off(ref(db, `purchaseRequests/${purchaseListener.id}`), 'value', purchaseListener.callback);
                purchaseListener = null;
            }
            userChatsData = {};
        }

        function cleanupAdminListeners() {
            if (adminListener) {
                off(ref(db, 'purchaseRequests'), 'value', adminListener);
                adminListener = null;
            }
        }

        async function createNewChat() {
            if (!currentUserId) return;
            const chatsRef = ref(db, `users/${currentUserId}/chats`);
            const newChatRef = push(chatsRef); // Создаем ID
            
            await set(newChatRef, {
                title: 'Новый чат',
                createdAt: serverTimestamp(),
                messages: [
                    { role: 'ai', content: WELCOME_MESSAGE }
                ]
            });
            currentActiveChatId = newChatRef.key;
        }

        // === ЛОГИКА ЧАТА (РЕНДЕРИНГ) ===
        
        // НОВЫЙ БЛОК: 100 Вопросов/Ответов по Кулинарии
        const cookingQA = {
            // 1-10: Basics & Eggs
            'как сварить яйцо вкрутую': 'Положите яйца в кастрюлю, залейте холодной водой. Доведите до кипения, затем уменьшите огонь и варите 9-12 минут. Остудите в холодной воде.',
            'как сварить яйцо всмятку': 'Опустите яйца в кипящую воду. Варите 3-4 минуты для жидкого желтка и 5-6 минут для полужидкого. Сразу остудите.',
            'как приготовить омлет': 'Взбейте 3 яйца с 2 ст. л. молока, посолите. Вылейте на разогретую сковороду со сливочным маслом. Готовьте 3-5 минут, помешивая.',
            'как пожарить яичницу-глазунью': 'Разогрейте сковородку с маслом. Аккуратно разбейте яйца, стараясь не повредить желток. Жарьте 3-4 минуты на среднем огне. Белок должен схватиться, а желток остаться жидким.',
            'что такое "аль денте"': 'Это итальянский термин, означающий степень готовности пасты (или риса), когда она уже готова, но остается слегка твердой "на зубок".',
            'как правильно варить макароны': 'Используйте большую кастрюлю. На каждые 100 г пасты берите 1 литр воды и 10 г соли. Варите в кипящей подсоленной воде время, указанное на упаковке, до состояния "аль денте".',
            'как приготовить рис, чтобы он был рассыпчатым': 'Промойте рис в холодной воде 5-7 раз, пока вода не станет прозрачной. Залейте водой в соотношении 1:1.5 (рис:вода). Доведите до кипения, убавьте огонь до минимума, накройте крышкой и варите 15-20 минут, не открывая.',
            'как приготовить гречку': 'Промойте 1 стакан гречки. Залейте 2 стаканами холодной воды, посолите. Доведите до кипения, убавьте огонь и варите под крышкой 15-20 минут, пока вода полностью не впитается.',
            'как сделать куриный бульон': 'Положите курицу (целую или части) в кастрюлю, залейте холодной водой. Доведите до кипения, снимите пену. Добавьте лук, морковь, сельдерей, лавровый лист. Варите на медленном огне 1.5-2 часа.',
            'как загустить соус': 'Можно использовать муку или крахмал (кукурузный, картофельный), разведенные в небольшом количестве холодной воды. Влейте смесь в соус и доведите до кипения, помешивая.',
        
            // 11-20: Meat & Poultry
            'как приготовить стейк': 'Достаньте мясо из холодильника за 30 минут до жарки. Раскалите сковороду (лучше чугунную). Обсушите стейк, смажьте маслом, посолите и поперчите. Жарьте по 2-4 минуты с каждой стороны для medium rare, в зависимости от толщины.',
            'как запечь курицу целиком': 'Натрите курицу солью, перцем и травами. Внутрь можно положить лимон и чеснок. Запекайте в духовке при 180°C около 1.5 часов (или из расчета 20 минут на каждые 500 г веса + 20 минут).',
            'как приготовить куриные грудки, чтобы они были сочными': 'Замаринуйте их (например, в кефире или соевом соусе) или быстро обжарьте на сильном огне с двух сторон до золотистой корочки, а затем доведите до готовности в духовке (15-20 мин при 180°C).',
            'как приготовить котлеты': 'Смешайте фарш (говядина+свинина) с мелко нарезанным луком, размоченным в молоке хлебом, яйцом, солью и перцем. Сформируйте котлеты, обваляйте в панировочных сухарях и обжарьте на сковороде до готовности.',
            'как приготовить гуляш': 'Нарежьте говядину кубиками, обжарьте. Добавьте лук, морковь, паприку, томатную пасту и немного бульона или воды. Тушите на медленном огне под крышкой 1.5-2 часа до мягкости мяса.',
            'что такое панировка': 'Это сухая смесь (сухари, мука, орехи) для обваливания продуктов (мяса, рыбы) перед жаркой. Она создает хрустящую корочку и сохраняет сочность.',
            'как приготовить бефстроганов': 'Тонко нарежьте говяжью вырезку. Быстро обжарьте на сильном огне. Добавьте нарезанный лук, обжарьте. Затем добавьте сметану, немного томатной пасты и потушите 5-10 минут. Не передержите!',
            'как приготовить отбивные': 'Нарежьте свинину или куриное филе ломтиками. Отбейте молотком. Посолите, поперчите. Обмакните во взбитое яйцо, затем в панировочные сухари. Жарьте на сковороде по 4-5 минут с каждой стороны.',
            'как приготовить буженину': 'Возьмите кусок свинины (окорок, шея). Нашпигуйте чесноком и морковью. Натрите солью, перцем и специями. Заверните в фольгу и запекайте в духовке при 180°C 1.5-2 часа (в зависимости от веса).',
            'как приготовить утку': 'Натрите утку солью и перцем. Внутрь положите яблоки (антоновку) и чернослив. Запекайте при 160°C 2-3 часа, периодически поливая вытопившимся жиром.',
        
            // 21-30: Fish & Seafood
            'как пожарить рыбу': 'Очистите рыбу. Нарежьте на порции. Посолите, поперчите. Обваляйте в муке. Жарьте на разогретой сковороде с маслом до золотистой корочки с обеих сторон.',
            'как запечь лосося в духовке': 'Положите филе лосося на фольгу. Сбрызните лимонным соком, посолите, поперчите. Можно добавить веточку розмарина. Заверните в фольгу и запекайте 15-20 минут при 200°C.',
            'как приготовить креветки': 'Замороженные вареные креветки достаточно залить кипятком на 2-3 минуты. Сырые креветки (серые) нужно варить в кипящей подсоленной воде 3-5 минут, пока они не станут розовыми.',
            'как приготовить уху': 'Сварите бульон из рыбьей головы и хвоста. Процедите. Добавьте в бульон картофель, нарезанный кубиками. Когда картофель будет почти готов, добавьте филе рыбы (например, судака) и лук. Варите 10-15 минут. В конце добавьте лавровый лист и укроп.',
            'как чистить кальмаров': 'Ошпарьте тушки кипятком — так кожица легко снимется. Удалите внутренности и прозрачную хрящевую пластину (хорду).',
            'как варить кальмаров': 'Главное — не переварить! Опустите подготовленные тушки в кипящую подсоленную воду. Варите ровно 2-3 минуты после закипания. Они станут белыми и нежными.',
            'как приготовить мидии': 'Замороженные очищенные мидии обжарьте на сковороде с чесноком и сливочным маслом 3-5 минут. Можно добавить белое вино или сливки и потушить еще пару минут.',
            'что такое севиче': 'Это блюдо из сырой рыбы или морепродуктов, маринованных в соке лайма или лимона. Кислота "готовит" рыбу без термической обработки. Добавляют также лук, чили, кинзу.',
            'как засолить красную рыбу': 'Смешайте соль и сахар в пропорции 2:1 (например, 2 ст. л. соли, 1 ст. л. сахара). Натрите этой смесью филе рыбы (форель, семга) со всех сторон. Положите в контейнер кожей вниз, накройте и уберите в холодильник на 24-48 часов.',
            'как приготовить рыбу на пару': 'Используйте пароварку или кастрюлю с дуршлагом. Положите филе (например, трески или тилапии) на решетку. Можно добавить лимон и травы. Готовьте 10-15 минут.',
        
            // 31-40: Vegetables & Salads
            'как приготовить салат цезарь': 'Натрите тарелку чесноком. Порвите листья салата романо. Добавьте обжаренные кубики белого хлеба (крутоны), тертый пармезан. Заправьте соусом (анчоусы, желток, вустерский соус, лимонный сок, оливковое масло). Сверху можно положить обжаренную куриную грудку.',
            'как приготовить греческий салат': 'Крупно нарежьте помидоры, огурцы, сладкий перец, красный лук. Добавьте оливки (каламату) и кубики сыра фета. Заправьте оливковым маслом, лимонным соком и орегано.',
            'как приготовить винегрет': 'Отварите и остудите свеклу, морковь, картофель. Нарежьте мелким кубиком. Добавьте квашеную капусту, соленые огурцы и мелко нарезанный лук. Заправьте растительным маслом.',
            'как приготовить салат оливье': 'Отварите картофель, морковь, яйца. Остудите, нарежьте мелким кубиком. Добавьте нарезанные соленые огурцы, вареную колбасу (или курицу) и зеленый горошек. Заправьте майонезом.',
            'как приготовить рататуй': 'Это овощное рагу. Нарежьте баклажаны, кабачки, помидоры и сладкий перец. Обжарьте лук и чеснок, добавьте овощи и тушите на медленном огне 30-40 минут. Добавьте травы (тимьян, розмарин).',
            'как запечь овощи': 'Нарежьте овощи (брокколи, цветная капуста, перец, кабачки, морковь). Сбрызните оливковым маслом, посыпьте солью, перцем и травами. Разложите на противне в один слой. Запекайте при 200°C 20-30 минут.',
            'как приготовить картофельное пюре': 'Отварите очищенный картофель в подсоленной воде. Слейте воду. Разомните картофель. Добавьте горячее молоко и сливочное масло. Взбейте до пышности.',
            'как приготовить картофель фри': 'Нарежьте картофель брусочками. Тщательно промойте и обсушите. Жарьте в большом количестве раскаленного растительного масла (фритюре) до золотистого цвета. Выложите на бумажное полотенце и посолите.',
            'как приготовить хумус': 'Отварите нут до мягкости (или возьмите консервированный). Измельчите в блендере. Добавьте тахини (кунжутную пасту), лимонный сок, чеснок, оливковое масло и немного воды (отвара). Взбейте до однородной пасты.',
            'как приготовить гуакамоле': 'Разомните вилкой мякоть спелого авокадо. Добавьте мелко нарезанные помидоры (без семян), красный лук, кинзу, сок лайма, соль и немного перца чили.',
        
            // 41-50: Soups
            'как приготовить борщ': 'Сварите мясной бульон. Обжарьте натертую свеклу, морковь, лук с добавлением томатной пасты и уксуса (для сохранения цвета свеклы). В кипящий бульон положите нашинкованную капусту, затем картофель. Когда картофель будет почти готов, добавьте зажарку. Варите еще 10 минут. Дайте настояться.',
            'как приготовить щи': 'Сварите бульон (говяжий или куриный). Добавьте нашинкованную капусту (свежую или квашеную). Обжарьте лук и морковь, добавьте в суп. Если капуста свежая, можно добавить немного томатной пасты. Варите до готовности капусты.',
            'как приготовить солянку': 'Приготовьте крепкий бульон. Обжарьте лук. Добавьте несколько видов мясных изделий (ветчина, колбаса, сосиски), нарезанных кубиком. Добавьте соленые огурцы, томатную пасту и немного бульона, потушите. Соедините с бульоном. Добавьте оливки, каперсы. При подаче положите ломтик лимона и сметану.',
            'как приготовить грибной суп': 'Обжарьте мелко нарезанный лук и морковь. Добавьте нарезанные грибы (шампиньоны или лесные), жарьте до испарения влаги. В кастрюле вскипятите воду или бульон, добавьте картофель. Когда картофель будет почти готов, добавьте грибную зажарку. Варите 10 минут.',
            'как приготовить крем-суп из шампиньонов': 'Обжарьте лук и шампиньоны. Залейте бульоном или водой, поварите 15 минут. Измельчите блендером до однородности. Верните на огонь, влейте сливки, посолите, поперчите. Доведите до кипения, но не кипятите.',
            'как приготовить харчо': 'Сварите бульон из говядины (грудинки). Мясо достаньте, нарежьте. В бульон добавьте промытый рис. Обжарьте лук, добавьте томатную пасту или протертые помидоры, потушите. Верните мясо и зажарку в суп. Добавьте соус ткемали, хмели-сунели, толченый чеснок, грецкие орехи и много зелени (кинза, петрушка).',
            'как приготовить гаспачо': 'Это холодный суп. Измельчите в блендере спелые помидоры (без кожицы), огурец, сладкий перец, красный лук и чеснок. Добавьте оливковое масло, винный уксус, соль и немного черствого белого хлеба. Протрите через сито.',
            'как приготовить окрошку': 'Нарежьте мелким кубиком отварной картофель, яйца, редис, свежие огурцы, вареную колбасу или мясо. Добавьте много зелени (укроп, зеленый лук). Залейте квасом или кефиром. Посолите, добавьте горчицу и сметану по вкусу.',
            'как приготовить тыквенный крем-суп': 'Запеките тыкву в духовке до мягкости. Обжарьте лук и морковь. Сложите все в кастрюлю, добавьте бульон или воду, чтобы покрыть овощи. Поварите 10 минут. Измельчите блендером. Добавьте сливки, соль, мускатный орех. Прогрейте.',
            'как приготовить куриный суп с лапшой': 'Сварите куриный бульон. Достаньте курицу, отделите мясо от костей. В бульон добавьте мелко нарезанный картофель (по желанию). Обжарьте лук и морковь. Добавьте зажарку и мясо в суп. В конце добавьте вермишель или лапшу, варите 3-5 минут. Добавьте лавровый лист и укроп.',
        
            // 51-60: Baking & Dough
            'как приготовить блины': 'Смешайте 2 яйца, 1 ст. л. сахара, 0.5 ч. л. соли. Добавьте 500 мл молока. Постепенно всыпьте 1 стакан муки, взбивая венчиком. В конце добавьте 2 ст. л. растительного масла. Жарьте на смазанной сковороде.',
            'как приготовить оладьи': 'Смешайте 500 мл кефира, 1 яйцо, 2 ст. л. сахара, щепотку соли. Добавьте 1.5-2 стакана муки и 1 ч. л. соды (или разрыхлителя). Перемешайте. Не взбивайте! Жарьте на растительном масле на среднем огне.',
            'как приготовить сырники': 'Смешайте 400 г творога (сухого), 1 яйцо, 2-3 ст. л. сахара, щепотку соли и 3-4 ст. л. муки. Можно добавить ванилин. Сформируйте сырники, обваляйте в муке и жарьте на сковороде до золотистой корочки.',
            'как приготовить дрожжевое тесто': 'Растворите 1-2 ч. л. сухих дрожжей в 1 стакане теплого молока. Добавьте 1 ст. л. сахара, дайте постоять 15 минут. Добавьте 1 яйцо, 50 г растопленного масла, соль. Постепенно всыпьте 3 стакана муки. Замесите тесто. Поставьте в теплое место на 1-1.5 часа, пока оно не поднимется.',
            'как приготовить тесто для пиццы': 'Смешайте 1 ч. л. сухих дрожжей, 1 ч. л. сахара в 200 мл теплой воды. Дайте постоять 10 минут. Добавьте 2 ст. л. оливкового масла, 0.5 ч. л. соли и около 300 г муки. Замесите эластичное тесто. Дайте подняться 40-60 минут.',
            'как приготовить шарлотку': 'Взбейте 3-4 яйца со 1 стаканом сахара до пышной пены. Добавьте 1 стакан муки, аккуратно перемешайте. Нарежьте 3-4 яблока. Форму смажьте маслом, выложите яблоки, залейте тестом. Выпекайте при 180°C 30-40 минут.',
            'как приготовить песочное тесто': 'Перетрите 200 г холодного сливочного масла с 300 г муки в крошку. Добавьте 100 г сахара, 1 яйцо и щепотку соли. Быстро замесите тесто. Охладите в холодильнике 30 минут перед использованием.',
            'как приготовить торт наполеон': 'Это сложный торт из множества тонких коржей (обычно из слоеного или похожего теста) и заварного крема. Коржи выпекаются, промазываются кремом и настаиваются.',
            'как приготовить заварной крем': 'Разотрите 2 желтка с 1 стаканом сахара и 2 ст. л. муки. Тонкой струйкой влейте 2 стакана горячего молока, постоянно помешивая. Поставьте на медленный огонь и варите до загустения. В конце добавьте сливочное масло и ванилин.',
            'как приготовить тирамису': 'Взбейте сыр маскарпоне. Отдельно взбейте желтки с сахаром. Аккуратно соедините. Печенье савоярди быстро обмакните в холодный крепкий кофе. Выложите слоями: крем, печенье, крем. Посыпьте какао. Охладите несколько часов.',
        
            // 61-70: Sauces & Dressings
            'как приготовить соус бешамель': 'Растопите 50 г сливочного масла, добавьте 2 ст. л. муки, обжарьте 1-2 минуты. Тонкой струйкой, постоянно помешивая, влейте 500 мл горячего молока. Доведите до кипения, поварите 5-7 минут до загустения. Добавьте соль и мускатный орех.',
            'как приготовить соус карбонара': 'Настоящая карбонара готовится без сливок! Обжарьте гуанчиале или панчетту (бекон). Смешайте желтки (3-4 шт) с тертым сыром пекорино или пармезаном и черным перцем. Горячую пасту смешайте с беконом, затем быстро влейте яично-сырную смесь и перемешайте (яйца готовятся от жара пасты).',
            'как приготовить соус болоньезе': 'Обжарьте фарш (говядина). В другой сковороде обжарьте "софрито": мелко нарезанные лук, морковь, сельдерей. Соедините фарш и овощи. Добавьте томаты в собственном соку, немного красного вина, бульон, травы. Тушите на медленном огне минимум 1-2 часа.',
            'как приготовить соус песто': 'Измельчите в блендере (или разотрите в ступке) свежий базилик, кедровые орешки, чеснок и тертый пармезан. Постепенно добавляйте оливковое масло до нужной консистенции. Посолите.',
            'как приготовить майонез': 'Взбейте 1 желток с 1 ч. л. горчицы, 0.5 ч. л. соли и 1 ч. л. сахара. По капле, продолжая взбивать, добавляйте 150-200 мл растительного масла. Когда масса загустеет, добавьте 1 ст. л. лимонного сока.',
            'как приготовить томатный соус для пасты': 'Обжарьте чеснок на оливковом масле. Добавьте консервированные томаты в собственном соку (лучше протертые). Добавьте соль, сахар (чтобы сбалансировать кислоту), сушеный орегано или свежий базилик. Тушите 15-20 минут.',
            'как приготовить соус тартар': 'Смешайте майонез с мелко нарезанными солеными огурцами, каперсами, укропом и зеленым луком. Можно добавить немного лимонного сока.',
            'как приготовить соус сальса': 'Мелко нарежьте помидоры (без семян), красный лук, перец чили, кинзу. Смешайте. Добавьте сок лайма и соль. Дайте настояться 15-20 минут.',
            'как приготовить дзадзики (цацики)': 'Натрите свежий огурец на терке, отожмите лишний сок. Смешайте с густым греческим йогуртом. Добавьте измельченный чеснок, оливковое масло, немного лимонного сока (или уксуса) и соль.',
            'как приготовить французскую заправку (винегрет)': 'Смешайте 3 части оливкового масла, 1 часть винного уксуса (или лимонного сока), 1 ч. л. дижонской горчицы, соль и перец. Взбейте вилкой до однородности.',
        
            // 71-80: Drinks & Desserts
            'как приготовить молочный коктейль': 'Смешайте в блендере 200 г мороженого (пломбир), 100 мл молока и 1 банан (или любые ягоды/сироп). Взбейте до однородности.',
            'как приготовить глинтвейн': 'Нагрейте 1 бутылку красного сухого вина в кастрюле (не кипятите!). Добавьте нарезанный апельсин, палочку корицы, несколько звездочек бадьяна, гвоздику и 2-3 ст. л. меда или сахара. Дайте настояться под крышкой 15 минут.',
            'как приготовить какао': 'Смешайте 2 ч. л. какао-порошка с 2 ч. л. сахара. Добавьте немного горячего молока или воды, разотрите в пасту. Влейте, помешивая, 1 стакан горячего молока.',
            'как приготовить чизкейк': 'Измельчите 200 г песочного печенья, смешайте со 100 г растопленного масла. Утрамбуйте на дно формы. Взбейте 600 г сливочного сыра (Филадельфия) с 150 г сахара. По одному добавьте 3 яйца. Влейте 100 мл жирных сливок. Вылейте начинку на основу. Выпекайте на водяной бане при 160°C около 1 часа.',
            'как приготовить панна котту': 'Замочите 10 г желатина в холодной воде. Нагрейте 500 мл жирных сливок с 100 г сахара и ванилином (не кипятите). Снимите с огня, растворите в сливках отжатый желатин. Разлейте по формочкам, охладите 4-6 часов.',
            'как приготовить шоколадный фондан': 'Растопите 100 г темного шоколада и 100 г сливочного масла. Взбейте 2 яйца со 100 г сахара. Соедините смеси. Добавьте 50 г муки. Разлейте по формочкам. Выпекайте при 200°C ровно 7-10 минут. Центр должен остаться жидким.',
            'как приготовить брауни': 'Растопите 200 г темного шоколада и 150 г сливочного масла. Взбейте 3 яйца со 200 г сахара. Соедините смеси. Добавьте 100 г муки и щепотку соли. Можно добавить орехи. Выпекайте при 180°C 20-25 минут.',
            'как приготовить яблочный штрудель': 'Тесто (фило или вытяжное) смазывают растопленным маслом. Выкладывают начинку: нарезанные яблоки, изюм, орехи, корица, сахар. Сворачивают в рулет. Выпекают до золотистой корочки.',
            'как приготовить крем-брюле': 'Смешайте жирные сливки (500 мл) с желтками (5 шт) и сахаром (100 г). Прогрейте, не доводя до кипения. Разлейте по формочкам. Запекайте на водяной бане при 150°C 30-40 минут. Остудите. Перед подачей посыпьте сахаром и обожгите горелкой.',
            'как приготовить безе (меренгу)': 'Взбейте яичные белки (4 шт) со щепоткой соли до пены. Постепенно, по 1 ложке, добавляйте сахар (200 г), продолжая взбивать. Взбивайте до "твердых пиков" (масса должна быть плотной и блестящей). Отсадите на противень и сушите в духовке при 100°C 1.5-2 часа.',
        
            // 81-90: Techniques & Misc
            'что такое "су-вид"': 'Это метод приготовления пищи в вакуумном пакете при низкой, точно контролируемой температуре в водяной бане. Это позволяет добиться идеальной степени готовности и сочности.',
            'что такое "бланшировать"': 'Это быстрая обработка продукта кипятком или паром. Например, опустить помидоры в кипяток на 30 секунд, чтобы легко снять кожицу, или бланшировать брокколи, чтобы она осталась ярко-зеленой.',
            'что такое "пассеровать"': 'Это легкое обжаривание овощей (обычно лука, моркови) в небольшом количестве жира на медленном огне до мягкости, не допуская образования корочки. Овощи становятся "прозрачными".',
            'что такое "маринование"': 'Это выдерживание продуктов (мяса, рыбы, овощей) в маринаде (смеси кислоты, масла, специй) перед приготовлением. Это размягчает продукт и придает ему вкус.',
            'что такое "карамелизация"': 'Это процесс, при котором сахар (в продуктах, как лук, или чистый сахар) нагревается и темнеет, приобретая характерный вкус и аромат.',
            'что такое "эмульсия"': 'Это смесь двух жидкостей, которые обычно не смешиваются, например, масла и воды (или уксуса). Майонез или соус винегрет — это эмульсии.',
            'как приготовить ризотто': 'Обжарьте лук на оливковом масле. Добавьте рис (арборио или карнароли), обжарьте до "прозрачности". Влейте бокал белого вина, выпарите. Затем половниками, по одному, добавляйте горячий бульон, постоянно помешивая. Каждый следующий половник добавляйте, когда предыдущий почти впитался. В конце добавьте сливочное масло и пармезан.',
            'как приготовить лазанью': 'Приготовьте соус болоньезе и соус бешамель. В форму для запекания выложите слоями: бешамель, листы лазаньи (сухие или отваренные), болоньезе, пармезан. Повторяйте слои. Верхний слой — бешамель и пармезан. Запекайте при 180°C 30-40 минут.',
            'как приготовить паэлью': 'Обжарьте курицу и/или морепродукты на большой сковороде (паэльере). Добавьте лук, чеснок, перец. Всыпьте рис (испанский, "бомба"), шафран, паприку. Залейте бульоном (соотношение 1:2.5). Не мешайте! Готовьте на среднем огне, пока бульон не впитается. В конце можно добавить горошек и лимон.',
            'как приготовить фондю': 'Натрите котелок (какелон) чесноком. Влейте белое вино, нагрейте. Постепенно добавляйте тертый швейцарский сыр (грюйер, эмменталь), помешивая. Добавьте немного крахмала, разведенного в кирше (вишневой водке), для густоты. Подавайте с кубиками хлеба.',
        
            // 91-100: Preserving & Other
            'как приготовить домашний квас': 'В 3-литровую банку положите 2-3 куска ржаного хлеба, подсушенного дочерна, 0.5 стакана сахара и горсть изюма. Залейте теплой кипяченой водой. Накройте марлей. Оставьте в теплом месте на 2-3 дня для брожения.',
            'как приготовить малосольные огурцы': 'В 1 литре кипятка растворите 2 ст. л. соли. Остудите. В банку уложите вымытые огурцы (обрежьте кончики), укроп (зонтики), листья хрена, смородины, вишни, чеснок. Залейте рассолом. Оставьте при комнатной температуре на 1-2 дня.',
            'как варить варенье': 'Классическая пропорция — 1:1 (1 кг ягод на 1 кг сахара). Ягоды засыпать сахаром, дать постоять, чтобы пустили сок. Довести до кипения, поварить 5 минут, снять пену. Дать полностью остыть. Повторить цикл 2-3 раза. Разлить по стерилизованным банкам.',
            'как стерилизовать банки': 'Можно в духовке (поставить чистые банки в холодную духовку, нагреть до 120-150°C и держать 15 минут) или над паром (над кипящим чайником). Крышки кипятить 5 минут.',
            'как приготовить джем': 'В отличие от варенья, джем имеет желеобразную консистенцию. Ягоды (например, смородину, малину) уваривают с сахаром (можно меньше, чем 1:1) до загустения. Можно добавить пектин.',
            'как квасить капусту': 'Нашинкуйте капусту. Натрите морковь (1 морковь на 1 кг капусты). Перемешайте с солью (1 ст. л. на 1 кг капусты), немного перетирая руками, чтобы дала сок. Плотно утрамбуйте в банку или эмалированную кастрюлю. Поставьте гнет. Оставьте при комнатной температуре на 3-5 дней, протыкая до дна 1-2 раза в день, чтобы выпустить газ.',
            'как сделать мохито (безалкогольный)': 'В высокий стакан положите мяту, 2-3 дольки лайма и 2 ч. л. сахара. Разомните мадлером. Наполните стакан колотым льдом. Залейте спрайтом или содовой.',
            'что такое "букет гарни"': 'Это пучок трав (обычно тимьян, петрушка, лавровый лист), связанный ниткой или завернутый в марлю. Его кладут в бульоны и рагу во время варки для аромата, а затем вынимают.',
            'что такое "ру" (roux)': 'Это смесь муки и жира (обычно сливочного масла), обжаренных вместе. Используется как загуститель для соусов (например, бешамель) и супов.',
            'как приготовить тесто "фило"': 'Это очень тонкое, как бумага, пресное вытяжное тесто. Его приготовление вручную — очень сложный процесс. Обычно его покупают готовым (замороженным) для пахлавы или штруделей.'
        };
        // /КОНЕЦ БЛОКА Q/A

        function renderSidebar(chatsData) {
            chatHistoryList.innerHTML = '';
            if (!chatsData) return;

            Object.entries(chatsData).forEach(([chatId, chatData]) => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = '#';
                a.dataset.chatId = chatId;
                a.textContent = chatData.title || 'Новый чат';
                a.className = `block px-3 py-2 text-sm rounded-md truncate ${chatId === currentActiveChatId ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}`;
                li.appendChild(a);
                chatHistoryList.appendChild(li);
            });
        }

        function renderChat(chatData) {
            chatMessages.innerHTML = '';
            if (!chatData || !chatData.messages) {
                chatMessages.innerHTML = '<p>Ошибка загрузки чата.</p>';
                return;
            }
            
            // ИСПРАВЛЕНИЕ: chatData.messages - это объект (Object), а не массив (Array)
            // Используем Object.values() для итерации
            Object.values(chatData.messages).forEach(msg => {
                appendMessage(msg.role, msg.content);
            });
        }

        function appendMessage(role, content) {
            const div = document.createElement('div');
            const isUser = role === 'user';
            
            const avatarChar = isUser ? 'U' : 'C';
            const avatarColor = isUser ? 'bg-indigo-600' : 'bg-blue-600';
            const title = isUser ? 'Вы' : 'CatAI';
            
            div.className = 'flex items-start space-x-4';
            div.innerHTML = `
                <div class="flex-shrink-0 w-10 h-10 rounded-full ${avatarColor} flex items-center justify-center">
                    <span class="text-lg font-medium">${avatarChar}</span>
                </div>
                <div class="flex-1">
                    <p class="font-bold text-white">${title}</p>
                    <p class="mt-1 text-gray-300">${content}</p>
                </div>
            `;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Ответ ИИ (симуляция)
        async function getAIResponse(userInput, chatId, selectedModel) {
            const lowerInput = userInput.toLowerCase().trim().replace('?', ''); // Нормализуем запрос
            let response = '';
            let modelPrefix = '';
            
            if (selectedModel === 'base') {
                modelPrefix = '(CatAI Base ⚙️): ';
            } else if (selectedModel === 'fast') {
                modelPrefix = '(CatAI Fast ⚡): ';
            } else if (selectedModel === 'pro') {
                // Проверка подписки
                if (subscriptionStatus.status !== 'active' || subscriptionStatus.model !== 'pro') {
                     response = '(CatAI): Ошибка! У вас нет активной PRO подписки.';
                } else {
                    modelPrefix = `(CatAI PRO 🚀 ${subscriptionStatus.limit / 1000}к): `;
                }
            } else {
                modelPrefix = '(CatAI): ';
            }

            if (response) { // Если уже есть ответ (ошибка подписки)
                 // response = response; // Ничего не делаем
            
            // ИЗМЕНЕННАЯ ЛОГИКА: Сначала ищем в базе Q/A
            } else if (cookingQA[lowerInput]) {
                response = modelPrefix + cookingQA[lowerInput];
            
            // Затем стандартные приветствия
            } else if (lowerInput.includes('привет')) {
                response = modelPrefix + 'Привет! Я CatAI, готов помочь. Задайте мне вопрос по кулинарии!';
            } else if (lowerInput.includes('как дела')) {
                response = modelPrefix + 'Я CatAI, и у меня все в порядке. Готовлю ответы на кулинарные вопросы!';
            
            // Ответ по умолчанию, если ничего не найдено
            } else {
                response = modelPrefix + 'Извините, я не совсем понял ваш запрос. Моя база знаний сейчас ограничена 100 кулинарными рецептами. Попробуйте спросить что-то вроде "как приготовить борщ?".';
            }

            // Добавляем ответ в базу данных
            const chatRef = ref(db, `users/${currentUserId}/chats/${chatId}/messages`);
            const newMsgRef = push(chatRef);
            await set(newMsgRef, {
                role: 'ai',
                content: response
            });
            // onValue() автоматически обновит UI
        }

        // === ОБРАБОТЧИКИ СОБЫТИЙ ===
        
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userInput = chatInput.value.trim();
            if (!userInput || !currentActiveChatId || !currentUserId) return;

            const selectedModel = modelSelect.value;
            chatInput.value = '';
            
            // ИСПРАВЛЕНИЕ: Запоминаем ID чата в момент отправки
            const chatIdForResponse = currentActiveChatId;

            const currentChatData = userChatsData[currentActiveChatId];
            const messages = currentChatData.messages || [];
            
            // 1. Сохраняем сообщение пользователя в Firebase
            const messagesRef = ref(db, `users/${currentUserId}/chats/${currentActiveChatId}/messages`);
            const newUserMsgRef = push(messagesRef);
            await set(newUserMsgRef, {
                role: 'user',
                content: userInput
            });
            
            // 2. Если это первое сообщение (после приветствия), обновляем заголовок чата
            if (messages.length === 1 && currentChatData.title === 'Новый чат') {
                const chatTitleRef = ref(db, `users/${currentUserId}/chats/${currentActiveChatId}/title`);
                await set(chatTitleRef, userInput.substring(0, 30));
            }

            // 3. Показываем "печатает" и ждем ответ
            typingIndicator.classList.remove('hidden');
            
            // Симуляция задержки ответа ИИ
            setTimeout(() => {
                // ИСПРАВЛЕНИЕ: Была ошибка ReferenceError: 'chatId' не определен.
                // Заменяем 'chatId' на 'chatIdForResponse'
                if (currentActiveChatId === chatIdForResponse) { // Проверяем, в том ли мы чате
                    typingIndicator.classList.add('hidden');
                }
                getAIResponse(userInput, chatIdForResponse, selectedModel);
            }, 1500);
        });

        newChatBtn.addEventListener('click', () => {
            createNewChat();
        });

        chatHistoryList.addEventListener('click', (e) => {
            e.preventDefault();
            const link = e.target.closest('a[data-chat-id]');
            if (!link) return;

            const chatId = link.dataset.chatId;
            if (chatId === currentActiveChatId) return; // Не переключаться на тот же чат
            
            currentActiveChatId = chatId;
            // onValue сам перерисует сайдбар (выделит активный)
            // и вызовет renderChat
            renderSidebar(userChatsData);
            renderChat(userChatsData[currentActiveChatId]);
            
            // Скрыть индикатор, если переключаемся
            typingIndicator.classList.add('hidden');
        });

        // Модальное окно (Модели)
        function resetModal() {
             // Сбрасываем все состояния
            modalStateDefault.classList.remove('hidden');
            modalStateWaiting.classList.add('hidden');
            modalStateError.classList.add('hidden');
            
            limitSelectionFieldset.classList.add('hidden');
            purchaseBtn.disabled = true;
            purchaseBtn.textContent = 'Оплатить (Скоро)';
            modelSelectionRadios.forEach(radio => radio.checked = false);
            limitSelectionRadios.forEach(radio => radio.checked = false);

            // Отписываемся от старого слушателя запроса, если он был
            if(purchaseListener) {
                off(ref(db, `purchaseRequests/${purchaseListener.id}`), 'value', purchaseListener.callback);
                purchaseListener = null;
            }
        }

        modelsBtn.addEventListener('click', (e) => {
            e.preventDefault();
            window.location.hash = '#models'; // Используем hash
        });

        closeModalBtn.addEventListener('click', () => {
            window.location.hash = '#ai'; // Используем hash
            resetModal(); // Сброс при закрытии
        });

        modalBackdrop.addEventListener('click', () => {
            window.location.hash = '#ai'; // Используем hash
            resetModal(); // Сброс при закрытии
        });
        
        closeErrorBtn.addEventListener('click', () => {
            resetModal(); // Возвращаем в состояние выбора
        });

        modelSelectionRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                if (radio.value === 'pro') {
                    limitSelectionFieldset.classList.remove('hidden');
                    purchaseBtn.disabled = true; // Разблокируется при выборе лимита
                    purchaseBtn.textContent = 'Выберите лимит';
                } else {
                    limitSelectionFieldset.classList.add('hidden');
                    purchaseBtn.disabled = true; // Бесплатные модели пока нельзя "купить"
                    purchaseBtn.textContent = 'Выбрать (Скоро)';
                }
            });
        });

        limitSelectionRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                purchaseBtn.textContent = 'Оплатить'; // ТЕПЕРЬ МОЖНО ОПЛАТИТЬ
                purchaseBtn.disabled = false; // РАЗБЛОКИРУЕМ КНОПКУ
            });
        });
        
        // ОБРАБОТЧИК ПОКУПКИ
        purchaseBtn.addEventListener('click', async () => {
            if (!currentUserId || !auth.currentUser) return;
            
            const selectedModelRadio = document.querySelector('input[name="model-selection"]:checked');
            const selectedLimitRadio = document.querySelector('input[name="limit-selection"]:checked');
            
            if (!selectedModelRadio || (selectedModelRadio.value === 'pro' && !selectedLimitRadio)) {
                alert("Пожалуйста, выберите модель и лимит.");
                return;
            }

            const model = selectedModelRadio.value;
            const limitText = selectedLimitRadio ? selectedLimitRadio.value.replace('k', '') : '0';
            const limit = parseInt(limitText) * 1000;
            const userEmail = auth.currentUser.email;

            // 1. Переключаем модальное окно в режим "Ожидание"
            modalStateDefault.classList.add('hidden');
            modalStateWaiting.classList.remove('hidden');
            
            try {
                // 2. Создаем запрос в Firebase
                const requestsRef = ref(db, 'purchaseRequests');
                const newRequestRef = push(requestsRef); // Создаем новый ID
                const requestId = newRequestRef.key;
                
                await set(newRequestRef, {
                    userId: currentUserId,
                    userEmail: userEmail,
                    model: model,
                    limit: limit,
                    status: 'pending', // Статус "в ожидании"
                    timestamp: serverTimestamp()
                });

                // 3. Начинаем слушать ИЗМЕНЕНИЯ этого запроса
                const requestCallback = onValue(newRequestRef, (snapshot) => {
                    const data = snapshot.val();
                    if (!data) return; // Запрос мог быть удален

                    if (data.status === 'confirmed') {
                        // УСПЕХ!
                        if(purchaseListener) {
                            off(ref(db, `purchaseRequests/${purchaseListener.id}`), 'value', purchaseListener.callback);
                            purchaseListener = null;
                        }
                        modelsModal.classList.add('hidden'); // Закрываем модалку
                        resetModal();
                        alert('Подписка успешно активирована!');
                        // updateModelAvailability() вызовется автоматически через setupSubscriptionListener
                    } 
                    
                    if (data.status === 'canceled') {
                        // ОТКАЗ!
                        if(purchaseListener) {
                            off(ref(db, `purchaseRequests/${purchaseListener.id}`), 'value', purchaseListener.callback);
                            purchaseListener = null;
                        }
                        modalStateWaiting.classList.add('hidden');
                        modalStateError.classList.remove('hidden');
                        modalErrorMessage.textContent = data.reason || 'Администратор отклонил ваш запрос.';
                    }
                });

                purchaseListener = { id: requestId, callback: requestCallback };

            } catch (error) {
                modalStateWaiting.classList.add('hidden');
                modalStateError.classList.remove('hidden');
                modalErrorMessage.textContent = 'Ошибка создания запроса: ' + error.message;
            }
        });

        // ========================
        // === ЛОГИКА АДМИНКИ ===
        // ========================
        
        // ОБРАБОТЧИКИ ДЛЯ АДМИН-МОДАЛКИ
        adminPanelBtn.addEventListener('click', (e) => {
            e.preventDefault();
            window.location.hash = '#admin';
        });

        closeAdminModalBtn.addEventListener('click', () => {
            window.location.hash = '#ai';
        });

        adminModalBackdrop.addEventListener('click', () => {
            window.location.hash = '#ai';
        });

        function setupAdminListeners() {
            cleanupAdminListeners(); // Чистим старый, если есть
            const requestsRef = ref(db, 'purchaseRequests');
            
            // Слушаем ВСЕ запросы
            adminListener = onValue(requestsRef, (snapshot) => {
                const requests = snapshot.val() || {};
                renderAdminPanel(requests);
            });
        }
        
        function renderAdminPanel(requests) {
            adminRequestsList.innerHTML = '';
            // Сортируем: сначала 'pending', потом остальные
            const sortedRequests = Object.entries(requests).sort(([, a], [, b]) => {
                if (a.status === 'pending' && b.status !== 'pending') return -1;
                if (a.status !== 'pending' && b.status === 'pending') return 1;
                return (b.timestamp || 0) - (a.timestamp || 0); // Новые вверху
            });
            
            if (sortedRequests.length === 0) {
                adminRequestsList.innerHTML = '<p class="text-gray-500">Нет запросов.</p>';
                return;
            }

            sortedRequests.forEach(([requestId, request]) => {
                const card = document.createElement('div');
                card.className = 'bg-gray-700 p-4 rounded-lg flex justify-between items-center';
                
                const date = request.timestamp ? new Date(request.timestamp).toLocaleString() : '...';
                
                let buttonsHtml = '';
                if (request.status === 'pending') {
                    buttonsHtml = `
                        <div class="space-x-2 flex-shrink-0">
                            <button data-id="${requestId}" data-action="confirm" class="px-3 py-1 bg-green-600 text-white text-sm rounded-md hover:bg-green-700">Подтвердить</button>
                            <button data-id="${requestId}" data-action="cancel" class="px-3 py-1 bg-red-600 text-white text-sm rounded-md hover:bg-red-700">Отклонить</button>
                        </div>
                    `;
                } else if (request.status === 'confirmed') {
                    buttonsHtml = `<span class="text-sm text-green-400 font-medium">Подтвержден</span>`;
                } else if (request.status === 'canceled') {
                    buttonsHtml = `<span class="text-sm text-red-400 font-medium">Отклонен</span>`;
                }
                
                card.innerHTML = `
                    <div class="flex-1 min-w-0 mr-4">
                        <p class="font-semibold text-white truncate">${request.userEmail}</p>
                        <p class="text-sm text-gray-300">
                            Хочет: <strong>${request.model.toUpperCase()}</strong>, 
                            Лимит: <strong>${request.limit}</strong>
                        </p>
                        <p class="text-xs text-gray-400 mt-1">${date}</p>
                    </div>
                    ${buttonsHtml}
                `;
                adminRequestsList.appendChild(card);
            });
        }
        
        // Обработчик кнопок админки
        adminRequestsList.addEventListener('click', async (e) => {
            const button = e.target.closest('button[data-id]');
            if (!button) return;

            const requestId = button.dataset.id;
            const action = button.dataset.action;
            
            // Блокируем кнопки
            button.disabled = true;
            button.textContent = '...';
            
            const requestRef = ref(db, `purchaseRequests/${requestId}`);
            
            // ИСПРАВЛЕНИЕ: Используем 'get' для разового чтения
            const requestSnapshot = await get(requestRef);
            const requestData = requestSnapshot.val();
            
            if (!requestData) {
                console.error("Запрос не найден!");
                return;
            }

            const targetUserId = requestData.userId;

            if (action === 'confirm') {
                // 1. Обновляем подписку юзера
                const subRef = ref(db, `users/${targetUserId}/subscription`);
                await set(subRef, {
                    model: requestData.model,
                    limit: requestData.limit,
                    status: 'active',
                    activatedAt: serverTimestamp()
                });
                
                // 2. Обновляем статус запроса (юзер получит это обновление)
                await update(requestRef, { status: 'confirmed' });

            } else if (action === 'cancel') {
                // 1. Обновляем статус запроса с причиной
                await update(requestRef, { 
                    status: 'canceled',
                    reason: 'Запрос отклонен администратором.'
                });
            }
        });

    </script>

</body>
</html>
