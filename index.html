
<html lang="ru" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CatAI - Вход</title>
    <!-- Подключаем Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Подключаем шрифты -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Базовые стили */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Стили для кастомного скроллбара в чате */
        #chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        #chat-messages::-webkit-scrollbar-track {
            background: #202123; /* Цвет фона трека */
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background-color: #4a4a4a; /* Цвет ползунка */
            border-radius: 20px; /* Скругление */
        }
    </style>
</head>
<body class="bg-gray-900 text-white h-full overflow-hidden">

    <!-- 
      Секции приложения.
      JavaScript будет показывать одну и скрывать остальные в зависимости от URL hash.
    -->

    <!-- ======================= -->
    <!--      ЭКРАН ВХОДА        -->
    <!-- ======================= -->
    <section id="login" class="page hidden h-full">
        <div class="flex items-center justify-center min-h-full px-4 py-12">
            <div class="w-full max-w-md space-y-8">
                <div>
                    <h2 class="mt-6 text-center text-3xl font-bold tracking-tight text-white">
                        Вход в CatAI
                    </h2>
                </div>
                <form id="login-form" class="mt-8 space-y-6" action="#" method="POST">
                    <input type="hidden" name="remember" value="true">
                    <div class="rounded-md shadow-sm -space-y-px">
                        <div>
                            <label for="login-email" class="sr-only">Email</label>
                            <input id="login-email" name="email" type="email" autocomplete="email" required
                                class="relative block w-full appearance-none rounded-t-md border-0 bg-gray-700 px-3 py-3 text-white placeholder-gray-400 focus:z-10 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm"
                                placeholder="Email" value="user@catai.com">
                        </div>
                        <div>
                            <label for="login-password" class="sr-only">Пароль</label>
                            <input id="login-password" name="password" type="password" autocomplete="current-password" required
                                class="relative block w-full appearance-none rounded-b-md border-0 bg-gray-700 px-3 py-3 text-white placeholder-gray-400 focus:z-10 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm"
                                placeholder="Пароль" value="password">
                        </div>
                    </div>

                    <div>
                        <button type="submit"
                            class="group relative flex w-full justify-center rounded-md border border-transparent bg-blue-600 py-2 px-4 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900">
                            Войти
                        </button>
                    </div>
                </form>
                <p class="text-center text-sm text-gray-400">
                    Нет аккаунта?
                    <a href="#register" class="font-medium text-blue-400 hover:text-blue-300">
                        Регистрация
                    </a>
                </p>
            </div>
        </div>
    </section>

    <!-- ======================= -->
    <!--    ЭКРАН РЕГИСТРАЦИИ    -->
    <!-- ======================= -->
    <section id="register" class="page hidden h-full">
        <div class="flex items-center justify-center min-h-full px-4 py-12">
            <div class="w-full max-w-md space-y-8">
                <div>
                    <h2 class="mt-6 text-center text-3xl font-bold tracking-tight text-white">
                        Создать аккаунт CatAI
                    </h2>
                </div>
                <form id="register-form" class="mt-8 space-y-6" action="#" method="POST">
                    <div class="rounded-md shadow-sm space-y-3">
                        <div>
                            <label for="register-email" class="sr-only">Email</label>
                            <input id="register-email" name="email" type="email" autocomplete="email" required
                                class="relative block w-full appearance-none rounded-md border-0 bg-gray-700 px-3 py-3 text-white placeholder-gray-400 focus:z-10 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm"
                                placeholder="Email">
                        </div>
                        <div>
                            <label for="register-password" class="sr-only">Пароль</label>
                            <input id="register-password" name="password" type="password" required
                                class="relative block w-full appearance-none rounded-md border-0 bg-gray-700 px-3 py-3 text-white placeholder-gray-400 focus:z-10 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm"
                                placeholder="Пароль">
                        </div>
                         <div>
                            <label for="register-confirm-password" class="sr-only">Повторите пароль</label>
                            <input id="register-confirm-password" name="confirm-password" type="password" required
                                class="relative block w-full appearance-none rounded-md border-0 bg-gray-700 px-3 py-3 text-white placeholder-gray-400 focus:z-10 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm"
                                placeholder="Повторите пароль">
                        </div>
                    </div>

                    <div>
                        <button type="submit"
                            class="group relative flex w-full justify-center rounded-md border border-transparent bg-blue-600 py-2 px-4 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900">
                            Зарегистрироваться
                        </button>
                    </div>
                </form>
                <p class="text-center text-sm text-gray-400">
                    Уже есть аккаунт?
                    <a href="#login" class="font-medium text-blue-400 hover:text-blue-300">
                        Войти
                    </a>
                </p>
            </div>
        </div>
    </section>

    <!-- ======================= -->
    <!--       ЭКРАН ЧАТА        -->
    <!-- ======================= -->
    <section id="ai" class="page hidden h-full">
        <div class="flex h-full">
            <!-- Боковая панель (для похожести на ChatGPT) -->
            <div class="hidden md:flex md:w-64 flex-col bg-gray-950 border-r border-gray-700">
                <div class="flex h-full min-h-0 flex-col">
                    <div class="flex-1 overflow-y-auto p-4">
                        <!-- Кнопка нового чата -->
                        <a href="#ai" id="new-chat-btn" class="flex items-center justify-between w-full px-3 py-2 rounded-lg text-white bg-blue-600 hover:bg-blue-700 mb-4">
                            <span>Новый чат</span>
                            <!-- Иконка "плюс" -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                        </a>
                        
                        <!-- Список прошлых чатов (будет заполнен JS) -->
                        <nav id="chat-history-list" class="flex-1 space-y-1">
                            <!-- Сюда JS добавит ссылки на чаты -->
                        </nav>
                    </div>
                    <!-- Футер сайдбара -->
                    <div class="border-t border-gray-700 p-4">
                         <a href="#login" id="logout-btn" class="flex w-full items-center px-3 py-2 text-sm font-medium rounded-md text-gray-400 hover:bg-gray-800 hover:text-white">
                            <!-- Иконка выхода -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" />
                            </svg>
                            Выйти
                        </a>
                    </div>
                </div>
            </div>

            <!-- Основная область чата -->
            <div class="flex flex-1 flex-col overflow-hidden">
                <!-- Хедер (виден на мобильных) -->
                <header class="flex md:hidden items-center justify-between border-b border-gray-700 bg-gray-900 px-4 py-3">
                     <h1 class="text-lg font-semibold text-white">CatAI</h1>
                     <a href="#login" class="text-gray-400 hover:text-white">
                        <!-- Иконка выхода -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                     </a>
                </header>

                <!-- Контейнер сообщений -->
                <main class="flex-1 overflow-y-auto" id="chat-messages">
                    <!-- Сообщения будут добавляться сюда с помощью JavaScript. -->
                </main>

                <!-- Индикатор "печатает..." (скрыт по умолчанию) -->
                <div id="typing-indicator" class="hidden px-4 py-2 text-sm text-gray-400">
                    CatAI печатает...
                </div>

                <!-- Форма ввода сообщения -->
                <footer class="p-4 bg-gray-900 border-t border-gray-700">
                    <form id="chat-form" class="flex items-center space-x-3">
                        <label for="chat-input" class="sr-only">Ваше сообщение</label>
                        <input type="text" id="chat-input" autocomplete="off"
                            class="flex-1 block w-full rounded-lg border-0 bg-gray-800 px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500"
                            placeholder="Напишите что-нибудь для CatAI...">
                        <button type="submit"
                            class="inline-flex h-12 w-12 items-center justify-center rounded-lg bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900">
                            <!-- Иконка "отправить" (бумажный самолетик) -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                              <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009.175 16V4.697a1 1 0 00-1.169-1.409l-5 1.429zM10 4.697v11.304l5-1.429a1 1 0 00.707-1.707l-7-14z" />
                            </svg>
                            <span class="sr-only">Отправить</span>
                        </button>
                    </form>
                    <p class="text-center text-xs text-gray-500 mt-3">
                        CatAI. Ответы могут быть неточными.
                    </p>
                </footer>
            </div>
        </div>
    </section>

    <!-- 
      ========================================
      FIREBASE SDKs
      ========================================
      Импортируем модули Firebase, которые нам нужны
    -->
    <script type="module">
        // Импорты Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getDatabase, ref, onValue, push, set } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        // Твоя конфигурация Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCcgLac2riawIGPHsdkXLOeFTEY_TUZX_s",
            authDomain: "catai-1624d.firebaseapp.com",
            databaseURL: "https://catai-1624d-default-rtdb.firebaseio.com",
            projectId: "catai-1624d",
            storageBucket: "catai-1624d.firebasestorage.app",
            messagingSenderId: "565260079109",
            appId: "1:565260079109:web:fd10c337a424555c0b0c6c"
        };

        // Инициализация Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // === ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ===
        const pages = document.querySelectorAll('.page');
        
        // Формы
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const registerEmailInput = document.getElementById('register-email');
        const registerPasswordInput = document.getElementById('register-password');

        // Чат
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');
        const typingIndicator = document.getElementById('typing-indicator');
        const newChatBtn = document.getElementById('new-chat-btn');
        const chatHistoryList = document.getElementById('chat-history-list');
        const logoutBtn = document.getElementById('logout-btn');

        // Состояние приложения
        let currentUserId = null;
        let userChatsData = {}; // Кэш данных из RTDB
        let currentActiveChatId = null;
        let chatsListener = null; // Хранит функцию отписки от onValue

        const WELCOME_MESSAGE = 'Привет! Я CatAI. Чем могу помочь?';

        // === ЛОГИКА МАРШРУТИЗАЦИИ (ПЕРЕКЛЮЧЕНИЯ СТРАНИЦ) ===

        function updateView() {
            const hash = window.location.hash || (currentUserId ? '#ai' : '#login');
            
            pages.forEach(page => page.classList.add('hidden'));

            const activePage = document.querySelector(hash);
            if (activePage) {
                activePage.classList.remove('hidden');
            } else {
                document.querySelector('#login').classList.remove('hidden');
            }
        }
        window.addEventListener('hashchange', updateView);

        // === ГЛАВНЫЙ СЛУШАТЕЛЬ АУТЕНТИФИКАЦИИ ===
        // Это ядро приложения. Он решает, что показывать: логин или чат.

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Пользователь вошел в систему
                currentUserId = user.uid;
                if (window.location.hash !== '#ai') {
                    window.location.hash = '#ai';
                }
                setupChatListeners(currentUserId); // Запускаем realtime-слушатель
            } else {
                // Пользователь вышел
                currentUserId = null;
                if (window.location.hash !== '#login' && window.location.hash !== '#register') {
                    window.location.hash = '#login';
                }
                cleanupChatListeners(); // Отключаем realtime-слушатель
                chatHistoryList.innerHTML = '';
                chatMessages.innerHTML = '';
            }
            updateView();
        });

        // === ЛОГИКА ФОРМ ВХОДА И РЕГИСТРАЦИИ (FIREBASE) ===

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged сам перекинет нас на #ai
            } catch (error) {
                alert("Ошибка входа: " + error.message);
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = registerEmailInput.value;
            const password = registerPasswordInput.value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged поймает нового юзера, но мы
                // перекинем его на логин, чтобы он вошел сам.
                alert('Регистрация прошла успешно! Теперь вы можете войти.');
                window.location.hash = '#login';
            } catch (error) {
                alert("Ошибка регистрации: " + error.message);
            }
        });

        logoutBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            await signOut(auth);
            // onAuthStateChanged сам перекинет на #login
        });


        // === ЛОГИКА FIREBASE REALTIME DATABASE ===

        /** Запускает onValue слушатель для чатов пользователя */
        function setupChatListeners(uid) {
            cleanupChatListeners(); // Очищаем старый, если есть
            
            // ИСПРАВЛЕНО: Убраны лишние кавычки в пути к ref. Было 'users/'' + uid + ''/chats'
            const chatsRef = ref(db, 'users/' + uid + '/chats');
            
            // onValue будет срабатывать КАЖДЫЙ РАЗ, когда данные меняются в RTDB
            chatsListener = onValue(chatsRef, (snapshot) => {
                userChatsData = snapshot.val() || {};
                
                // Если у пользователя нет чатов, создаем первый
                if (Object.keys(userChatsData).length === 0) {
                    createNewChat(); // Он создаст чат, и onValue вызовется СНОВА
                    return;
                }

                // Проверяем, валиден ли активный чат
                if (!currentActiveChatId || !userChatsData[currentActiveChatId]) {
                    // Если нет, берем первый из списка
                    currentActiveChatId = Object.keys(userChatsData)[0];
                }

                // Перерисовываем интерфейс с новыми данными
                renderSidebar(userChatsData, currentActiveChatId);
                renderChat(currentActiveChatId);
            });
        }

        /** Отключает onValue слушатель */
        function cleanupChatListeners() {
            if (chatsListener) {
                chatsListener(); // Это функция отписки, которую возвращает onValue
                chatsListener = null;
            }
            userChatsData = {};
        }

        /** Создает новый чат в RTDB */
        async function createNewChat() {
            if (!currentUserId) return;
            
            const chatsRef = ref(db, `users/${currentUserId}/chats`);
            const newChatRef = push(chatsRef); // Генерируем ID для чата

            // Создаем приветственное сообщение
            const messagesRef = ref(db, `users/${currentUserId}/chats/${newChatRef.key}/messages`);
            const firstMessageRef = push(messagesRef); // Генерируем ID для сообщения
            
            // Записываем и сообщение, и заголовок чата
            await set(firstMessageRef, { sender: 'ai', text: WELCOME_MESSAGE });
            await set(ref(db, `users/${currentUserId}/chats/${newChatRef.key}/title`), 'Новый чат');

            // Устанавливаем новый чат как активный
            currentActiveChatId = newChatRef.key;
            // onValue listener сам поймает это изменение и все перерисует.
        }

        // === ЛОГИКА ЧАТА (РЕНДЕРИНГ) ===
        // Эти функции теперь только рисуют. Они не хранят и не читают,
        // этим занимается onValue.

        /** Отрисовывает список чатов в сайдбаре */
        function renderSidebar(chats, activeId) {
            chatHistoryList.innerHTML = '';
            // chats - это объект { chatId1: {title: ...}, chatId2: {title: ...} }
            Object.keys(chats).forEach(chatId => {
                const chat = chats[chatId];
                if (!chat) return; // На всякий случай

                const isActive = chatId === activeId;
                const link = document.createElement('a');
                link.href = '#ai';
                link.dataset.chatId = chatId; // Используем ID из Firebase
                link.textContent = chat.title || 'Чат без имени';
                link.className = `block truncate px-3 py-2 text-sm font-medium rounded-md ${
                    isActive 
                    ? 'text-white bg-gray-800' 
                    : 'text-gray-400 hover:bg-gray-800 hover:text-white'
                }`;
                chatHistoryList.appendChild(link);
            });
        }

        /** Отрисовывает сообщения активного чата */
        function renderChat(chatId) {
            if (!chatId || !userChatsData[chatId]) {
                chatMessages.innerHTML = '<p class="p-4 text-gray-500">Выберите чат или создайте новый.</p>';
                return;
            }
            
            currentActiveChatId = chatId; // Обновляем глобальный ID
            const chat = userChatsData[chatId];
            chatMessages.innerHTML = ''; // Очищаем чат
            
            if (chat.messages) {
                // chat.messages - это объект { msgId1: {...}, msgId2: {...} }
                // RTDB по-умолчанию хранит их в хронологическом порядке
                Object.values(chat.messages).forEach(message => {
                    addMessageToDOM(message.text, message.sender);
                });
            } else {
                // Если чат есть, а сообщений нет (редкий случай)
                addMessageToDOM(WELCOME_MESSAGE, 'ai');
            }
            
            // Обновляем сайдбар, чтобы подсветить активный чат
            renderSidebar(userChatsData, chatId);
        }

        /** Добавляет ОДНО сообщение в DOM (в окно чата) */
        function addMessageToDOM(text, sender) {
            const messageElement = document.createElement('div');
            // ... (весь тот же HTML-контент, что и в прошлой версии) ...
            messageElement.classList.add('message', 'p-4', 'max-w-3xl', 'mx-auto');

            let content = '';

            if (sender === 'ai') {
                messageElement.classList.add('bg-gray-800'); 
                content = `
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center font-bold text-sm">C</div>
                        <div class="flex-1">
                            <p class="font-semibold">CatAI</p>
                            <p class="text-gray-300">${text}</p>
                        </div>
                    </div>
                `;
            } else {
                content = `
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center font-bold text-sm">U</div>
                        <div class="flex-1">
                            <p class="font-semibold">Вы</p>
                            <p class="text-white">${text}</p>
                        </div>
                    </div>
                `;
            }

            messageElement.innerHTML = content;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight; // Автопрокрутка
        }
        
        /** Генерирует и СОХРАНЯЕТ ответ от ИИ */
        async function getAIResponse(userInput, chatId) {
            const lowerInput = userInput.toLowerCase();
            let response = '';

            if (lowerInput.includes('привет')) {
                response = 'Мяу! Привет. Чем могу быть полезен?';
            } else if (lowerInput.includes('как дела')) {
                response = 'Я CatAI, и у меня все в порядке. А у вас?';
            } else if (lowerInput.includes('пока')) {
                response = 'До встречи! Был рад пообщаться. Мяу!';
            } else if (lowerInput.includes('котик') || lowerInput.includes('кошка')) {
                response = 'Я очень люблю котиков! Мррр...';
            } else {
                response = 'Извините, я CatAI и не могу обработать этот запрос. Я еще учусь. Попробуйте спросить что-нибудь другое.';
            }

            // Просто записываем ответ в RTDB. onValue его поймает и отрисует.
            if (currentUserId && chatId) {
                const messagesRef = ref(db, `users/${currentUserId}/chats/${chatId}/messages`);
                const newMessageRef = push(messagesRef);
                await set(newMessageRef, { sender: 'ai', text: response });
            }

            // Скрываем индикатор печати (только если чат все еще активен)
            if (chatId === currentActiveChatId) {
                typingIndicator.classList.add('hidden');
            }
        }


        // === ОБРАБОТЧИКИ СОБЫТИЙ ===

        // 1. Отправка формы чата
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageText = chatInput.value.trim();
            const activeId = currentActiveChatId;

            if (messageText && activeId && currentUserId) {
                // 1. Оптимистично очистить поле ввода
                chatInput.value = '';
                
                // 2. Сохранить сообщение пользователя в RTDB
                const messagesRef = ref(db, `users/${currentUserId}/chats/${activeId}/messages`);
                const newMessageRef = push(messagesRef);
                await set(newMessageRef, { sender: 'user', text: messageText });
                // onValue поймает это и отрисует.
                
                // 3. Проверить, не нужно ли обновить заголовок чата
                const chat = userChatsData[activeId];
                const messageCount = chat.messages ? Object.keys(chat.messages).length : 0;
                
                // Если это первое сообщение пользователя (второе в чате после приветствия ИИ)
                if (messageCount === 1) { 
                    const newTitle = messageText.length > 25 ? messageText.substring(0, 25) + '...' : messageText;
                    // Сохраняем заголовок в RTDB
                    await set(ref(db, `users/${currentUserId}/chats/${activeId}/title`), newTitle);
                    // onValue поймает и это.
                }
                
                // 4. Показать индикатор "печатает"
                typingIndicator.classList.remove('hidden');

                // 5. Сгенерировать ответ ИИ (он сам сохранится в RTDB)
                setTimeout(getAIResponse, 1500, messageText, activeId);
            }
        });
        
        // 2. Нажатие кнопки "Новый чат"
        newChatBtn.addEventListener('click', (e) => {
            e.preventDefault();
            createNewChat(); // Просто создаем новый чат. onValue сделает остальное.
        });
        
        // 3. Нажатие на чат в истории (делегирование событий)
        chatHistoryList.addEventListener('click', (e) => {
            const link = e.target.closest('a[data-chat-id]');
            if (link) {
                e.preventDefault();
                const chatId = link.dataset.chatId;
                if (chatId !== currentActiveChatId) {
                    renderChat(chatId); // Просто перерисовываем, данные уже есть
                    typingIndicator.classList.add('hidden');
                }
            }
        });

    </script>

</body>
</html>
