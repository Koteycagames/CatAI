<!DOCTYPE html>
<html lang="ru" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CatAI - –ß–∞—Ç</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —à—Ä–∏—Ñ—Ç—ã -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ –≤ —á–∞—Ç–µ */
        #chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        #chat-messages::-webkit-scrollbar-track {
            background: #202123; /* –¶–≤–µ—Ç —Ñ–æ–Ω–∞ —Ç—Ä–µ–∫–∞ */
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background-color: #4a4a4a; /* –¶–≤–µ—Ç –ø–æ–ª–∑—É–Ω–∫–∞ */
            border-radius: 20px; /* –°–∫—Ä—É–≥–ª–µ–Ω–∏–µ */
        }
    </style>
</head>
<body class="bg-gray-900 text-white h-full overflow-hidden">

    <!-- 
      –°–µ–∫—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
      JavaScript –±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ–¥–Ω—É –∏ —Å–∫—Ä—ã–≤–∞—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç URL hash.
    -->

    <!-- ======================= -->
    <!--      –≠–ö–†–ê–ù –í–•–û–î–ê        -->
    <!-- ======================= -->
    <section id="login" class="page hidden h-full">
        <div class="flex items-center justify-center min-h-full px-4 py-12">
            <div class="w-full max-w-md space-y-8">
                <div>
                    <h2 class="mt-6 text-center text-3xl font-bold tracking-tight text-white">
                        –í—Ö–æ–¥ –≤ CatAI
                    </h2>
                </div>
                <form id="login-form" class="mt-8 space-y-6" action="#" method="POST">
                    <input type="hidden" name="remember" value="true">
                    <div class="rounded-md shadow-sm -space-y-px">
                        <div>
                            <label for="login-email" class="sr-only">Email</label>
                            <input id="login-email" name="email" type="email" autocomplete="email" required
                                class="relative block w-full appearance-none rounded-t-md border-0 bg-gray-700 px-3 py-3 text-white placeholder-gray-400 focus:z-10 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm"
                                placeholder="Email" value="user@catai.com">
                        </div>
                        <div>
                            <label for="login-password" class="sr-only">–ü–∞—Ä–æ–ª—å</label>
                            <input id="login-password" name="password" type="password" autocomplete="current-password" required
                                class="relative block w-full appearance-none rounded-b-md border-0 bg-gray-700 px-3 py-3 text-white placeholder-gray-400 focus:z-10 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm"
                                placeholder="–ü–∞—Ä–æ–ª—å" value="password">
                        </div>
                    </div>

                    <div id="login-error" class="text-red-400 text-sm hidden"></div>

                    <div>
                        <button type="submit"
                            class="group relative flex w-full justify-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900">
                            –í–æ–π—Ç–∏
                        </button>
                    </div>
                </form>

                <div class="text-sm text-center">
                    <a href="#register" class="font-medium text-blue-500 hover:text-blue-400">
                        –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                    </a>
                </div>
            </div>
        </div>
    </section>

    <!-- ======================= -->
    <!--    –≠–ö–†–ê–ù –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò    -->
    <!-- ======================= -->
    <section id="register" class="page hidden h-full">
        <div class="flex items-center justify-center min-h-full px-4 py-12">
            <div class="w-full max-w-md space-y-8">
                <div>
                    <h2 class="mt-6 text-center text-3xl font-bold tracking-tight text-white">
                        –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ CatAI
                    </h2>
                </div>
                <form id="register-form" class="mt-8 space-y-6" action="#" method="POST">
                    <div class="rounded-md shadow-sm space-y-3">
                        <div>
                            <label for="register-email" class="sr-only">Email</label>
                            <input id="register-email" name="email" type="email" autocomplete="email" required
                                class="relative block w-full appearance-none rounded-md border-0 bg-gray-700 px-3 py-3 text-white placeholder-gray-400 focus:z-10 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm"
                                placeholder="Email">
                        </div>
                        <div>
                            <label for="register-password" class="sr-only">–ü–∞—Ä–æ–ª—å</label>
                            <input id="register-password" name="password" type="password" autocomplete="new-password" required
                                class="relative block w-full appearance-none rounded-md border-0 bg-gray-700 px-3 py-3 text-white placeholder-gray-400 focus:z-10 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm"
                                placeholder="–ü–∞—Ä–æ–ª—å">
                        </div>
                        <div>
                            <label for="register-confirm-password" class="sr-only">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                            <input id="register-confirm-password" name="confirm-password" type="password" autocomplete="new-password" required
                                class="relative block w-full appearance-none rounded-md border-0 bg-gray-700 px-3 py-3 text-white placeholder-gray-400 focus:z-10 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm"
                                placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                        </div>
                    </div>

                    <div id="register-error" class="text-red-400 text-sm hidden"></div>

                    <div>
                        <button type="submit"
                            class="group relative flex w-full justify-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900">
                            –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                        </button>
                    </div>
                </form>

                <div class="text-sm text-center">
                    <a href="#login" class="font-medium text-blue-500 hover:text-blue-400">
                        –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏
                    </a>
                </div>
            </div>
        </div>
    </section>

    <!-- ======================= -->
    <!--       –≠–ö–†–ê–ù –ß–ê–¢–ê        -->
    <!-- ======================= -->
    <section id="ai" class="page hidden h-full flex overflow-hidden">
        
        <!-- === –°–ê–ô–î–ë–ê–† (–ù–∞–≤–∏–≥–∞—Ü–∏—è) === -->
        <div class="flex-shrink-0 w-64 bg-gray-950 flex flex-col border-r border-gray-700">
            <!-- –í–µ—Ä—Ö–Ω—è—è —á–∞—Å—Ç—å —Å–∞–π–¥–±–∞—Ä–∞ (–∫–Ω–æ–ø–∫–∞ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞) -->
            <div class="p-4">
                <a href="#ai" id="new-chat-btn" class="flex items-center justify-between w-full px-3 py-2 text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                    –ù–æ–≤—ã–π —á–∞—Ç
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                </a>
            </div>
            
            <!-- –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å (—Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤) -->
            <div class="flex-1 overflow-y-auto px-4">
                <nav id="chat-history-list" class="space-y-1">
                    <!-- –°—Å—ã–ª–∫–∏ –Ω–∞ —á–∞—Ç—ã –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω—ã —Å—é–¥–∞ —Å –ø–æ–º–æ—â—å—é JS -->
                    <p class="text-gray-500 text-sm">–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...</p>
                </nav>
            </div>
            
            <!-- –§—É—Ç–µ—Ä —Å–∞–π–¥–±–∞—Ä–∞ -->
            <div class="border-t border-gray-700 p-4">
                 <!-- –ö–ù–û–ü–ö–ê –ú–û–î–ï–õ–ò -->
                 <a href="#" id="models-btn" class="flex w-full items-center px-3 py-2 text-sm font-medium rounded-md text-gray-400 hover:bg-gray-800 hover:text-white mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M5 2a1 1 0 00-1 1v1h1a1 1 0 010 2H4v1a1 1 0 001 1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1V9a1 1 0 011-1h2a1 1 0 001-1V6h-1a1 1 0 110-2h1V3a1 1 0 00-1-1H5zM2 13v3a1 1 0 001 1h3a1 1 0 001-1v-3a1 1 0 00-1-1H3a1 1 0 00-1 1zm14 0v3a1 1 0 001 1h3a1 1 0 001-1v-3a1 1 0 00-1-1h-3a1 1 0 00-1 1z" clip-rule="evenodd" />
                    </svg>
                    –ú–æ–¥–µ–ª–∏
                </a>
                 <!-- /–ö–ù–û–ü–ö–ê –ú–û–î–ï–õ–ò -->

                 <a href="#login" id="logout-btn" class="flex w-full items-center px-3 py-2 text-sm font-medium rounded-md text-gray-400 hover:bg-gray-800 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V5.414L12.586 14 14 12.586 5.414 4H16a1 1 0 100-2H4a1 1 0 00-1 1z" clip-rule="evenodd" />
                    </svg>
                    –í—ã–π—Ç–∏
                </a>
            </div>
        </div>

        <!-- === –û–°–ù–û–í–ù–û–ï –û–ö–ù–û –ß–ê–¢–ê === -->
        <div class="flex-1 flex flex-col bg-gray-900">
            <!-- –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω—ã —Å—é–¥–∞ -->
            </div>

            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ø–µ—á–∞—Ç–∞–µ—Ç" -->
            <div id="typing-indicator" class="hidden p-4 max-w-3xl mx-auto w-full">
                <div class="flex items-start space-x-3">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center font-bold text-sm">C</div>
                    <div class="flex-1">
                        <p class="font-semibold">CatAI</p>
                        <p class="text-gray-300 italic">CatAI –ø–µ—á–∞—Ç–∞–µ—Ç...</p>
                    </div>
                </div>
            </div>

            <!-- –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ -->
            <div class="bg-gray-900 p-4 border-t border-gray-800">
                <form id="chat-form" class="max-w-3xl mx-auto flex items-center space-x-3">
                    
                    <!-- –ö–ù–û–ü–ö–ê –í–´–ë–û–†–ê –ú–û–î–ï–õ–ò -->
                    <div class="relative flex-shrink-0">
                        <label for="model-select" class="sr-only">–í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏</label>
                        <select id="model-select" name="model"
                            class="h-12 w-40 appearance-none block rounded-lg border-0 bg-gray-800 pl-3 pr-8 py-3 text-white focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm">
                            <option value="base">CatAI base</option>
                            <option value="fast">CatAI Fast</option>
                            <option value="pro">CatAI PRO</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M10 3a.75.75 0 01.53.22l3.5 3.5a.75.75 0 01-1.06 1.06L10 4.81 6.53 8.28a.75.75 0 01-1.06-1.06l3.5-3.5A.75.75 0 0110 3z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </div>

                    <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ -->
                    <div class="relative flex-1">
                        <input type="text" id="chat-input"
                            class="block w-full h-12 rounded-lg border-0 bg-gray-800 py-3 pr-14 pl-4 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm"
                            placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ CatAI..." autocomplete="off">
                        
                        <!-- –ö–Ω–æ–ø–∫–∞ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å" -->
                        <button type="submit"
                            class="absolute right-3 top-1/2 -translate-y-1/2 w-8 h-8 rounded-lg bg-blue-600 text-white flex items-center justify-center hover:bg-blue-700 focus:outline-none">
                            <svg class="w-5 h-5 -mr-px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M3.105 1.153a.5.5 0 01.594.02l13.63 8.232a.5.5 0 010 .87l-13.63 8.232a.5.5 0 01-.84-.399V1.55a.5.5 0 01.246-.418z" />
                            </svg>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <!-- ======================= -->
    <!--     –ù–û–í–ê–Ø –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨    -->
    <!-- ======================= -->
    <section id="admin" class="page hidden h-full flex flex-col">
        <header class="bg-gray-950 p-4 border-b border-gray-700 flex justify-between items-center">
            <h1 class="text-xl font-bold text-white">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å CatAI</h1>
            <a href="#login" id="admin-logout-btn" class="text-sm text-blue-500 hover:text-blue-400">–í—ã–π—Ç–∏ (Admin)</a>
        </header>

        <div class="flex-1 overflow-y-auto p-6">
            <h2 class="text-lg font-semibold mb-4">–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –ø–æ–∫—É–ø–∫—É</h2>
            <div id="admin-requests-list" class="space-y-3">
                <!-- –ó–∞–ø—Ä–æ—Å—ã –±—É–¥—É—Ç —Ä–µ–Ω–¥–µ—Ä–∏—Ç—å—Å—è —Å—é–¥–∞ -->
                <p class="text-gray-500">–û–∂–∏–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤...</p>
            </div>
        </div>
    </section>

    <!-- ======================= -->
    <!--     –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û      -->
    <!-- ======================= -->
    <div id="models-modal" class="page hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <!-- –§–æ–Ω-–æ–≤–µ—Ä–ª–µ–π -->
            <div id="modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity" aria-hidden="true"></div>

            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ -->
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                
                <!-- –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –ö–û–ù–¢–ï–ù–¢ –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê -->
                
                <!-- 1. –§–æ—Ä–º–∞ –≤—ã–±–æ—Ä–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                <div id="modal-state-default">
                    <div class="bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-600 sm:mx-0 sm:h-10 sm:w-10">
                                <!-- ... (–∏–∫–æ–Ω–∫–∞) ... -->
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M5 2a1 1 0 00-1 1v1h1a1 1 0 010 2H4v1a1 1 0 001 1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1V9a1 1 0 011-1h2a1 1 0 001-1V6h-1a1 1 0 110-2h1V3a1 1 0 00-1-1H5zM2 13v3a1 1 0 001 1h3a1 1 0 001-1v-3a1 1 0 00-1-1H3a1 1 0 00-1 1zm14 0v3a1 1 0 001 1h3a1 1 0 001-1v-3a1 1 0 00-1-1h-3a1 1 0 00-1 1z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                                <h3 class="text-lg leading-6 font-medium text-white" id="modal-title">
                                    –ú–æ–¥–µ–ª–∏ CatAI
                                </h3>
                                <div class="mt-2">
                                    <p class="text-sm text-gray-400">
                                        –í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ –≤–∞—à–∏ –∑–∞–¥–∞—á–∏. PRO-–º–æ–¥–µ–ª–∏ —Ç—Ä–µ–±—É—é—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏.
                                    </p>
                                </div>
                            </div>
                        </div>
                        <!-- –ò–ù–¢–ï–†–ê–ö–¢–ò–í–ù–´–ô –ë–õ–û–ö –í–´–ë–û–†–ê -->
                        <div class="mt-6 space-y-6">
                            <!-- 1. –í—ã–±–æ—Ä –ú–æ–¥–µ–ª–∏ -->
                            <fieldset>
                                        CatAI base üêà <span class="text-gray-400">(–î–æ—Å—Ç—É–ø–Ω–æ)</span>
                                    </label>
                                </div>
                            </fieldset>
                        </div>
                    </div>
                    <!-- –§—É—Ç–µ—Ä –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ -->
                    <div class="bg-gray-800 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse border-t border-gray-700">
                        <button id="purchase-btn" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm" disabled>
                            –û–ø–ª–∞—Ç–∏—Ç—å (–°–∫–æ—Ä–æ)
                        </button>
                        <button id="close-modal-btn" type="button" class="mt-3 sm:mt-0 w-full inline-flex justify-center rounded-md border border-gray-600 shadow-sm px-4 py-2 bg-gray-700 text-base font-medium text-white hover:bg-gray-600 focus:outline-none sm:w-auto sm:text-sm">
                            –ó–∞–∫—Ä—ã—Ç—å
                        </button>
                    </div>
                </div>

                <!-- 2. –û–∂–∏–¥–∞–Ω–∏–µ (–ù–û–í–´–ô –ë–õ–û–ö) -->
                <div id="modal-state-waiting" class="hidden">
                    <div class="bg-gray-800 px-4 pt-5 pb-8 sm:p-6 sm:pb-8 text-center">
                        <h3 class="text-lg font-medium text-white">–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è...</h3>
                        <p class="text-sm text-gray-400 mt-2">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —ç—Ç–æ –æ–∫–Ω–æ. –ê–¥–º–∏–Ω –ø–æ–ª—É—á–∏–ª –≤–∞—à –∑–∞–ø—Ä–æ—Å.</p>
                        <!-- –ê–Ω–∏–º–∞—Ü–∏—è —Å–ø–∏–Ω–Ω–µ—Ä–∞ -->
                        <svg class="animate-spin h-8 w-8 text-blue-500 mx-auto mt-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                </div>

                <!-- 3. –û—à–∏–±–∫–∞ (–ù–û–í–´–ô –ë–õ–û–ö) -->
                <div id="modal-state-error" class="hidden">
                    <div class="bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-600 sm:mx-0 sm:h-10 sm:w-10">
                                <svg class="h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </div>
                            <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                                <h3 class="text-lg leading-6 font-medium text-white">–ó–∞–ø—Ä–æ—Å –æ—Ç–∫–ª–æ–Ω–µ–Ω</h3>
                                <div class="mt-2">
                                    <p class="text-sm text-gray-400" id="modal-error-message">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ—Ç–∫–ª–æ–Ω–∏–ª –≤–∞—à –∑–∞–ø—Ä–æ—Å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-800 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse border-t border-gray-700">
                        <button id="close-error-btn" type="button" class="w-full inline-flex justify-center rounded-md border border-gray-600 shadow-sm px-4 py-2 bg-gray-700 text-base font-medium text-white hover:bg-gray-600 focus:outline-none sm:w-auto sm:text-sm">
                            –ó–∞–∫—Ä—ã—Ç—å
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>


    <!-- 
      ========================================
      FIREBASE SDKs
      ========================================
    -->
    <script type="module">
        // –ò–º–ø–æ—Ä—Ç—ã Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        // –î–û–ë–ê–í–õ–ï–ù–û: serverTimestamp, update, off
        import { getDatabase, ref, onValue, push, set, serverTimestamp, update, off } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        // –¢–≤–æ—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCcgLac2riawIGPHsdkXLOeFTEY_TUZX_s",
            authDomain: "catai-1624d.firebaseapp.com",
            databaseURL: "https://catai-1624d-default-rtdb.firebaseio.com",
            projectId: "catai-1624d",
            storageBucket: "catai-1624d.firebasestorage.app",
            messagingSenderId: "565260079109",
            appId: "1:565260079109:web:fd10c337a424555c0b0c6c"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ===
        const pages = document.querySelectorAll('.page');
        
        // –§–æ—Ä–º—ã
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const registerEmailInput = document.getElementById('register-email');
        const registerPasswordInput = document.getElementById('register-password');
        const registerConfirmPasswordInput = document.getElementById('register-confirm-password');
        const loginError = document.getElementById('login-error');
        const registerError = document.getElementById('register-error');

        // –ß–∞—Ç
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const modelSelect = document.getElementById('model-select');
        const chatMessages = document.getElementById('chat-messages');
        const typingIndicator = document.getElementById('typing-indicator');
        const newChatBtn = document.getElementById('new-chat-btn');
        const chatHistoryList = document.getElementById('chat-history-list');
        const logoutBtn = document.getElementById('logout-btn');
        const adminLogoutBtn = document.getElementById('admin-logout-btn'); // –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê –í–´–•–û–î–ê

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        const modelsBtn = document.getElementById('models-btn');
        const modelsModal = document.getElementById('models-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modelSelectionRadios = document.querySelectorAll('input[name="model-selection"]');
        const limitSelectionFieldset = document.getElementById('limit-selection-fieldset');
        const purchaseBtn = document.getElementById('purchase-btn');
        const limitSelectionRadios = document.querySelectorAll('input[name="limit-selection"]');
        // –ù–û–í–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –°–û–°–¢–û–Ø–ù–ò–ô –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê
        const modalStateDefault = document.getElementById('modal-state-default');
        const modalStateWaiting = document.getElementById('modal-state-waiting');
        const modalStateError = document.getElementById('modal-state-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const closeErrorBtn = document.getElementById('close-error-btn');
        
        // –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
        const adminRequestsList = document.getElementById('admin-requests-list');

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let currentUserId = null;
        let isAdmin = false; // –ù–û–í–û–ï
        let userChatsData = {}; // –ö—ç—à –¥–∞–Ω–Ω—ã—Ö –∏–∑ RTDB
        let currentActiveChatId = null;
        let chatsListener = null; // –•—Ä–∞–Ω–∏—Ç —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ø–∏—Å–∫–∏ –æ—Ç onValue
        let adminListener = null; // –ù–û–í–û–ï
        let purchaseListener = null; // –ù–û–í–û–ï
        // –ò–ó–ú–ï–ù–ï–ù–û: hasProSubscription —Å—Ç–∞–ª –æ–±—ä–µ–∫—Ç–æ–º
        let subscriptionStatus = { status: 'none', model: 'base', limit: 0 }; 

        const WELCOME_MESSAGE = '–ü—Ä–∏–≤–µ—Ç! –Ø CatAI. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?';

        // === –õ–û–ì–ò–ö–ê –ú–ê–†–®–†–£–¢–ò–ó–ê–¶–ò–ò (–ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–Ø –°–¢–†–ê–ù–ò–¶) ===

        function updateView() {
            // –ò–ó–ú–ï–ù–ï–ù–û: –õ–æ–≥–∏–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç–µ–ø–µ—Ä—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç isAdmin
            const defaultHash = isAdmin ? '#admin' : (currentUserId ? '#ai' : '#login');
            const hash = window.location.hash || defaultHash;
            
            pages.forEach(page => page.classList.add('hidden'));

            // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ - –æ—Å–æ–±—ã–π —Å–ª—É—á–∞–π
            if (hash === '#models') {
                document.querySelector('#ai').classList.remove('hidden'); 
                modelsModal.classList.remove('hidden');
            } else if (hash === '#admin' && isAdmin) { 
                document.querySelector('#admin').classList.remove('hidden');
            } else if (hash === '#ai' && currentUserId && !isAdmin) {
                document.querySelector('#ai').classList.remove('hidden');
            } else if (hash === '#register' && !currentUserId) {
                 document.querySelector('#register').classList.remove('hidden');
            } else if (hash === '#login' && !currentUserId) {
                 document.querySelector('#login').classList.remove('hidden');
            } else {
                // –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
                if (!currentUserId) {
                    document.querySelector('#login').classList.remove('hidden');
                } else if (isAdmin) {
                    document.querySelector('#admin').classList.remove('hidden');
                } else {
                    document.querySelector('#ai').classList.remove('hidden');
                }
            }
        }
        window.addEventListener('hashchange', updateView);

        // === –ì–õ–ê–í–ù–´–ô –°–õ–£–®–ê–¢–ï–õ–¨ –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò ===
        onAuthStateChanged(auth, (user) => {
            // –°–Ω–∞—á–∞–ª–∞ –≤—Å—ë —á–∏—Å—Ç–∏–º
            cleanupChatListeners();
            cleanupAdminListeners();
            currentUserId = null;
            isAdmin = false;
            
            if (user) {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª
                currentUserId = user.uid;

                // –ü–†–û–í–ï–†–ö–ê –ù–ê –ê–î–ú–ò–ù–ê (–ø–æ email, –∫–∞–∫ —Ç—ã –ø—Ä–æ—Å–∏–ª)
                if (user.email.toLowerCase() === 'admin@gmail.com') {
                    isAdmin = true;
                    if (window.location.hash !== '#admin') {
                        window.location.hash = '#admin';
                    }
                    setupAdminListeners(); // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∫–∏
                } else {
                    isAdmin = false;
                    if (window.location.hash !== '#ai') {
                        window.location.hash = '#ai';
                    }
                    setupChatListeners(currentUserId); // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å —á–∞—Ç–æ–≤
                }
                
                // –û–ë–©–ò–ô –°–õ–£–®–ê–¢–ï–õ–¨ –ü–û–î–ü–ò–°–ö–ò (–¥–ª—è –≤—Å–µ—Ö)
                setupSubscriptionListener(currentUserId);

            } else {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª
                if (window.location.hash !== '#login' && window.location.hash !== '#register') {
                    window.location.hash = '#login';
                }
                chatHistoryList.innerHTML = '';
                chatMessages.innerHTML = '';
            }
            updateView();
        });

        // === –õ–û–ì–ò–ö–ê –§–û–†–ú –í–•–û–î–ê –ò –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò (FIREBASE) ===

        function showAuthError(element, message) {
            element.textContent = message;
            element.classList.remove('hidden');
        }

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginError.classList.add('hidden');
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showAuthError(loginError, "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + error.message);
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            registerError.classList.add('hidden');
            const email = registerEmailInput.value;
            const password = registerPasswordInput.value;
            const confirmPassword = registerConfirmPasswordInput.value;

            if (password !== confirmPassword) {
                showAuthError(registerError, "–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!");
                return;
            }

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏.');
                window.location.hash = '#login';
            } catch (error) {
                showAuthError(registerError, "–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: " + error.message);
            }
        });

        logoutBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            await signOut(auth);
        });
        
        // –ù–û–í–´–ô –í–´–•–û–î –î–õ–Ø –ê–î–ú–ò–ù–ê
        adminLogoutBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            await signOut(auth);
        });


        // === –õ–û–ì–ò–ö–ê FIREBASE REALTIME DATABASE ===

        // –°–ª—É—à–∞—Ç–µ–ª—å –ø–æ–¥–ø–∏—Å–∫–∏ (–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ –≤—Ö–æ–¥–µ)
        function setupSubscriptionListener(uid) {
            const subRef = ref(db, `users/${uid}/subscription`);
            onValue(subRef, (snapshot) => {
                subscriptionStatus = snapshot.val() || { status: 'none', model: 'base', limit: 0 };
                updateModelAvailability();
            });
        }

        function updateModelAvailability() {
            const proOption = document.querySelector('#model-select option[value="pro"]');
            if (!proOption) return;

            // –ò–ó–ú–ï–ù–ï–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ –æ–±—ä–µ–∫—Ç—É –ø–æ–¥–ø–∏—Å–∫–∏
            if (subscriptionStatus.status === 'active' && subscriptionStatus.model === 'pro') {
                proOption.disabled = false;
                proOption.textContent = `CatAI PRO (–î–æ ${subscriptionStatus.limit}–∫)`;
            } else {
                proOption.disabled = true;
                proOption.textContent = 'CatAI PRO (–ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏)';
            }
        }

        function setupChatListeners(uid) {
            cleanupChatListeners();
            const chatsRef = ref(db, 'users/' + uid + '/chats');
            
            chatsListener = onValue(chatsRef, (snapshot) => {
                userChatsData = snapshot.val() || {};
                
                if (Object.keys(userChatsData).length === 0) {
                    createNewChat();
                    return;
                }

                if (!currentActiveChatId || !userChatsData[currentActiveChatId]) {
                    currentActiveChatId = Object.keys(userChatsData)[0];
                }

                renderSidebar(userChatsData, currentActiveChatId);
                renderChat(currentActiveChatId);
            });
        }

        function cleanupChatListeners() {
            if (chatsListener) {
                chatsListener(); // –û—Ç–ø–∏—Å–∫–∞ onValue
                chatsListener = null;
            }
            if (purchaseListener) {
                purchaseListener(); // –û—Ç–ø–∏—Å–∫–∞ –æ—Ç onValue –∑–∞–ø—Ä–æ—Å–∞
                purchaseListener = null;
            }
            userChatsData = {};
        }

        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø
        function cleanupAdminListeners() {
            if (adminListener) {
                adminListener(); // –û—Ç–ø–∏—Å–∫–∞ onValue
                adminListener = null;
            }
        }

        async function createNewChat() {
            if (!currentUserId) return;
            
            const chatsRef = ref(db, `users/${currentUserId}/chats`);
            const newChatRef = push(chatsRef); 

            const messagesRef = ref(db, `users/${currentUserId}/chats/${newChatRef.key}/messages`);
            const firstMessageRef = push(messagesRef);
            
            await set(firstMessageRef, { sender: 'ai', text: WELCOME_MESSAGE });
            await set(ref(db, `users/${currentUserId}/chats/${newChatRef.key}/title`), '–ù–æ–≤—ã–π —á–∞—Ç');

            currentActiveChatId = newChatRef.key;
        }

        // === –õ–û–ì–ò–ö–ê –ß–ê–¢–ê (–†–ï–ù–î–ï–†–ò–ù–ì) ===

        function renderSidebar(chats, activeId) {
            chatHistoryList.innerHTML = '';
            Object.keys(chats).forEach(chatId => {
                const chat = chats[chatId];
                if (!chat) return;

                const isActive = chatId === activeId;
                const link = document.createElement('a');
                link.href = '#ai';
                link.dataset.chatId = chatId;
                link.textContent = chat.title || '–ß–∞—Ç –±–µ–∑ –∏–º–µ–Ω–∏';
                link.className = `block truncate px-3 py-2 text-sm font-medium rounded-md ${
                    isActive 
                    ? 'text-white bg-gray-800' 
                    : 'text-gray-400 hover:bg-gray-800 hover:text-white'
                }`;
                chatHistoryList.appendChild(link);
            });
        }

        function renderChat(chatId) {
            if (!chatId || !userChatsData[chatId]) {
                chatMessages.innerHTML = '<p class="p-4 text-gray-500">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π.</p>';
                return;
            }
            
            currentActiveChatId = chatId;
            const chat = userChatsData[chatId];
            chatMessages.innerHTML = '';
            
            if (chat.messages) {
                Object.values(chat.messages).forEach(message => {
                    addMessageToDOM(message.text, message.sender);
                });
            } else {
                addMessageToDOM(WELCOME_MESSAGE, 'ai');
            }
            
            renderSidebar(userChatsData, chatId);
        }

        function addMessageToDOM(text, sender) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', 'p-4', 'max-w-3xl', 'mx-auto');
            let content = '';

            if (sender === 'ai') {
                messageElement.classList.add('bg-gray-800'); 
                content = `
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center font-bold text-sm">C</div>
                        <div class="flex-1">
                            <p class="font-semibold">CatAI</p>
                            <p class="text-gray-300">${text}</p>
                        </div>
                    </div>
                `;
            } else {
                content = `
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center font-bold text-sm">U</div>
                        <div class="flex-1">
                            <p class="font-semibold">–í—ã</p>
                            <p class="text-white">${text}</p>
                        </div>
                    </div>
                `;
            }

            messageElement.innerHTML = content;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        async function getAIResponse(userInput, chatId) {
            const lowerInput = userInput.toLowerCase();
            let response = '';
            const selectedModel = modelSelect.value; 
            let modelPrefix = '';

            if (selectedModel === 'base') {
                modelPrefix = '(CatAI base üêà): ';
            } else if (selectedModel === 'fast') {
                modelPrefix = '(CatAI Fast ‚ö°): ';
            } else if (selectedModel === 'pro') {
                // –ü–†–û–í–ï–†–ö–ê –ü–û–î–ü–ò–°–ö–ò
                if (subscriptionStatus.status !== 'active' || subscriptionStatus.model !== 'pro') {
                     response = '(CatAI): –û—à–∏–±–∫–∞! –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π PRO –ø–æ–¥–ø–∏—Å–∫–∏.';
                } else {
                    modelPrefix = `(CatAI PRO üöÄ ${subscriptionStatus.limit}–∫): `;
                }
            } else {
                modelPrefix = `(${selectedModel}): `;
            }

            if (lowerInput.includes('–ø—Ä–∏–≤–µ—Ç')) {
                response = modelPrefix + '–ú—è—É! –ü—Ä–∏–≤–µ—Ç. –ß–µ–º –º–æ–≥—É –±—ã—Ç—å –ø–æ–ª–µ–∑–µ–Ω?';
            } else if (lowerInput.includes('–∫–∞–∫ –¥–µ–ª–∞')) {
                response = modelPrefix + '–Ø CatAI, –∏ —É –º–µ–Ω—è –≤—Å–µ –≤ –ø–æ—Ä—è–¥–∫–µ. –ê —É –≤–∞—Å?';
            } else if (lowerInput.includes('–ø–æ–∫–∞')) {
                response = modelPrefix + '–î–æ –≤—Å—Ç—Ä–µ—á–∏! –ë—ã–ª —Ä–∞–¥ –ø–æ–æ–±—â–∞—Ç—å—Å—è. –ú—è—É!';
            } else if (lowerInput.includes('–∫–æ—Ç–∏–∫') || lowerInput.includes('–∫–æ—à–∫–∞')) {
                response = modelPrefix + '–Ø –æ—á–µ–Ω—å –ª—é–±–ª—é –∫–æ—Ç–∏–∫–æ–≤! –ú—Ä—Ä—Ä...';
            } else {
                response = modelPrefix + '–ò–∑–≤–∏–Ω–∏—Ç–µ, —è CatAI –∏ –Ω–µ –º–æ–≥—É –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å. –Ø –µ—â–µ —É—á—É—Å—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–ø—Ä–æ—Å–∏—Ç—å —á—Ç–æ-–Ω–∏–±—É–¥—å –¥—Ä—É–≥–æ–µ.';
            }

            if (currentUserId && chatId) {
                const messagesRef = ref(db, `users/${currentUserId}/chats/${chatId}/messages`);
                const newMessageRef = push(messagesRef);
                await set(newMessageRef, { sender: 'ai', text: response });
            }

            if (chatId === currentActiveChatId) {
                typingIndicator.classList.add('hidden');
            }
        }

        // === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ===

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageText = chatInput.value.trim();
            const activeId = currentActiveChatId;

            if (messageText && activeId && currentUserId) {
                chatInput.value = '';
                
                const messagesRef = ref(db, `users/${currentUserId}/chats/${activeId}/messages`);
                const newMessageRef = push(messagesRef);
                await set(newMessageRef, { sender: 'user', text: messageText });
                
                const chat = userChatsData[activeId];
                const messageCount = chat.messages ? Object.keys(chat.messages).length : 0;
                
                if (messageCount === 1) { 
                    const newTitle = messageText.length > 25 ? messageText.substring(0, 25) + '...' : messageText;
                    await set(ref(db, `users/${currentUserId}/chats/${activeId}/title`), newTitle);
                }
                
                typingIndicator.classList.remove('hidden');
                setTimeout(getAIResponse, 1500, messageText, activeId);
            }
        });
        
        newChatBtn.addEventListener('click', (e) => {
            e.preventDefault();
            createNewChat();
        });
        
        chatHistoryList.addEventListener('click', (e) => {
            const link = e.target.closest('a[data-chat-id]');
            if (link) {
                e.preventDefault();
                const chatId = link.dataset.chatId;
                if (chatId !== currentActiveChatId) {
                    renderChat(chatId);
                    typingIndicator.classList.add('hidden');
                }
            }
        });

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        function resetModal() {
             // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            modalStateDefault.classList.remove('hidden');
            modalStateWaiting.classList.add('hidden');
            modalStateError.classList.add('hidden');
            
            limitSelectionFieldset.classList.add('hidden');
            purchaseBtn.disabled = true;
            purchaseBtn.textContent = '–û–ø–ª–∞—Ç–∏—Ç—å (–°–∫–æ—Ä–æ)';
            modelSelectionRadios.forEach(radio => radio.checked = false);
            limitSelectionRadios.forEach(radio => radio.checked = false);

            // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç —Å—Ç–∞—Ä–æ–≥–æ —Å–ª—É—à–∞—Ç–µ–ª—è –∑–∞–ø—Ä–æ—Å–∞, –µ—Å–ª–∏ –æ–Ω –±—ã–ª
            if(purchaseListener) {
                purchaseListener();
                purchaseListener = null;
            }
        }

        modelsBtn.addEventListener('click', (e) => {
            e.preventDefault();
            modelsModal.classList.remove('hidden');
            resetModal();
        });

        closeModalBtn.addEventListener('click', () => {
            modelsModal.classList.add('hidden');
            resetModal(); // –°–±—Ä–æ—Å –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        });

        modalBackdrop.addEventListener('click', () => {
            modelsModal.classList.add('hidden');
            resetModal(); // –°–±—Ä–æ—Å –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        });
        
        closeErrorBtn.addEventListener('click', () => {
            resetModal(); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—ã–±–æ—Ä–∞
        });

        modelSelectionRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                const selectedModel = e.target.value;
                if (selectedModel === 'pro') {
                    limitSelectionFieldset.classList.remove('hidden');
                    purchaseBtn.disabled = true;
                    purchaseBtn.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –ª–∏–º–∏—Ç';
                } else {
                    limitSelectionFieldset.classList.add('hidden');
                    purchaseBtn.disabled = true; // –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –º–æ–¥–µ–ª–∏ –ø–æ–∫–∞ –Ω–µ–ª—å–∑—è "–∫—É–ø–∏—Ç—å"
                    purchaseBtn.textContent = '–í—ã–±—Ä–∞—Ç—å (–°–∫–æ—Ä–æ)';
                }
            });
        });

        limitSelectionRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                purchaseBtn.textContent = '–û–ø–ª–∞—Ç–∏—Ç—å'; // –¢–ï–ü–ï–†–¨ –ú–û–ñ–ù–û –û–ü–õ–ê–¢–ò–¢–¨
                purchaseBtn.disabled = false; // –†–ê–ó–ë–õ–û–ö–ò–†–£–ï–ú –ö–ù–û–ü–ö–£
            });
        });
        
        // –ù–û–í–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –ü–û–ö–£–ü–ö–ò
        purchaseBtn.addEventListener('click', async () => {
            if (!currentUserId || !auth.currentUser) return;
            
            const selectedModelRadio = document.querySelector('input[name="model-selection"]:checked');
            const selectedLimitRadio = document.querySelector('input[name="limit-selection"]:checked');
            
            if (!selectedModelRadio || (selectedModelRadio.value === 'pro' && !selectedLimitRadio)) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å –∏ –ª–∏–º–∏—Ç.");
                return;
            }

            const model = selectedModelRadio.value;
            const limit = selectedLimitRadio ? parseInt(selectedLimitRadio.value.replace('k', '000')) : 0;
            const userEmail = auth.currentUser.email;

            // 1. –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤ —Ä–µ–∂–∏–º "–û–∂–∏–¥–∞–Ω–∏–µ"
            modalStateDefault.classList.add('hidden');
            modalStateWaiting.classList.remove('hidden');
            
            try {
                // 2. –°–æ–∑–¥–∞–µ–º –∑–∞–ø—Ä–æ—Å –≤ Firebase
                const requestsRef = ref(db, 'purchaseRequests');
                const newRequestRef = push(requestsRef); // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π ID
                const requestId = newRequestRef.key;
                
                await set(newRequestRef, {
                    userId: currentUserId,
                    userEmail: userEmail,
                    model: model,
                    limit: limit,
                    status: 'pending', // –°—Ç–∞—Ç—É—Å "–≤ –æ–∂–∏–¥–∞–Ω–∏–∏"
                    timestamp: serverTimestamp()
                });

                // 3. –ù–∞—á–∏–Ω–∞–µ–º —Å–ª—É—à–∞—Ç—å –ò–ó–ú–ï–ù–ï–ù–ò–Ø —ç—Ç–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
                purchaseListener = onValue(newRequestRef, (snapshot) => {
                    const data = snapshot.val();
                    if (!data) return; // –ó–∞–ø—Ä–æ—Å –º–æ–≥ –±—ã—Ç—å —É–¥–∞–ª–µ–Ω

                    if (data.status === 'confirmed') {
                        // –£–°–ü–ï–•!
                        purchaseListener(); // –ü–µ—Ä–µ—Å—Ç–∞–µ–º —Å–ª—É—à–∞—Ç—å
                        purchaseListener = null;
                        modelsModal.classList.add('hidden'); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
                        resetModal();
                        alert('–ü–æ–¥–ø–∏—Å–∫–∞ —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!');
                        // updateModelAvailability() –≤—ã–∑–æ–≤–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ setupSubscriptionListener
                    } 
                    
                    if (data.status === 'canceled') {
                        // –û–¢–ö–ê–ó!
                        purchaseListener(); // –ü–µ—Ä–µ—Å—Ç–∞–µ–º —Å–ª—É—à–∞—Ç—å
                        purchaseListener = null;
                        modalStateWaiting.classList.add('hidden');
                        modalStateError.classList.remove('hidden');
                        modalErrorMessage.textContent = data.reason || '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ—Ç–∫–ª–æ–Ω–∏–ª –≤–∞—à –∑–∞–ø—Ä–æ—Å.';
                    }
                    
                    // –ï—Å–ª–∏ status == 'pending', –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, –ø—Ä–æ—Å—Ç–æ –∂–¥–µ–º
                });

            } catch (error) {
                modalStateWaiting.classList.add('hidden');
                modalStateError.classList.remove('hidden');
                modalErrorMessage.textContent = '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞: ' + error.message;
            }
        });

        // ========================
        // === –õ–û–ì–ò–ö–ê –ê–î–ú–ò–ù–ö–ò ===
        // ========================
        
        function setupAdminListeners() {
            cleanupAdminListeners(); // –ß–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–π, –µ—Å–ª–∏ –µ—Å—Ç—å
            const requestsRef = ref(db, 'purchaseRequests');
            
            // –°–ª—É—à–∞–µ–º –í–°–ï –∑–∞–ø—Ä–æ—Å—ã
            adminListener = onValue(requestsRef, (snapshot) => {
                const requests = snapshot.val() || {};
                renderAdminPanel(requests);
            });
        }
        
        function renderAdminPanel(requests) {
            adminRequestsList.innerHTML = '';
            const pendingRequests = Object.entries(requests).filter(([, req]) => req.status === 'pending');
            
            if (pendingRequests.length === 0) {
                adminRequestsList.innerHTML = '<p class="text-gray-500">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.</p>';
                return;
            }

            pendingRequests.forEach(([requestId, request]) => {
                const card = document.createElement('div');
                card.className = 'bg-gray-800 p-4 rounded-lg flex justify-between items-center';
                card.innerHTML = `
                    <div>
                        <p class="font-semibold text-white">${request.userEmail}</p>
                        <p class="text-sm text-gray-400">
                            –•–æ—á–µ—Ç: <strong>${request.model.toUpperCase()}</strong>, 
                            –õ–∏–º–∏—Ç: <strong>${request.limit}</strong>
                        </p>
                    </div>
                    <div class="space-x-2">
                        <button data-id="${requestId}" data-action="confirm" class="px-3 py-1 bg-green-600 text-white text-sm rounded-md hover:bg-green-700">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                        <button data-id="${requestId}" data-action="cancel" class="px-3 py-1 bg-red-600 text-white text-sm rounded-md hover:bg-red-700">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                    </div>
                `;
                adminRequestsList.appendChild(card);
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫ –∞–¥–º–∏–Ω–∫–∏
        adminRequestsList.addEventListener('click', async (e) => {
            const button = e.target.closest('button[data-id]');
            if (!button) return;

            const requestId = button.dataset.id;
            const action = button.dataset.action;
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
            button.disabled = true;
            
            const requestRef = ref(db, `purchaseRequests/${requestId}`);
            const requestSnapshot = await onValue(requestRef, () => {}, { onlyOnce: true }); // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞ 1 —Ä–∞–∑
            const requestData = requestSnapshot.val();
            
            if (!requestData) return;

            const targetUserId = requestData.userId;

            if (action === 'confirm') {
                // 1. –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É —é–∑–µ—Ä–∞
                const subRef = ref(db, `users/${targetUserId}/subscription`);
                await set(subRef, {
                    model: requestData.model,
                    limit: requestData.limit,
                    status: 'active',
                    activatedAt: serverTimestamp()
                });
                
                // 2. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–ø—Ä–æ—Å–∞ (—é–∑–µ—Ä –ø–æ–ª—É—á–∏—Ç —ç—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
                await update(requestRef, { status: 'confirmed' });

            } else if (action === 'cancel') {
                // 1. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–ø—Ä–æ—Å–∞ —Å –ø—Ä–∏—á–∏–Ω–æ–π
                await update(requestRef, { 
                    status: 'canceled',
                    reason: '–ó–∞–ø—Ä–æ—Å –æ—Ç–∫–ª–æ–Ω–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.'
                });
            }
        });

    </script>

</body>
</html>
