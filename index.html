<!DOCTYPE html>
<html lang="ru" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CatAI - –í—Ö–æ–¥</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —à—Ä–∏—Ñ—Ç—ã -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ –≤ —á–∞—Ç–µ */
        #chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        #chat-messages::-webkit-scrollbar-track {
            background: #202123; /* –¶–≤–µ—Ç —Ñ–æ–Ω–∞ —Ç—Ä–µ–∫–∞ */
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background-color: #4a4a4a; /* –¶–≤–µ—Ç –ø–æ–ª–∑—É–Ω–∫–∞ */
            border-radius: 20px; /* –°–∫—Ä—É–≥–ª–µ–Ω–∏–µ */
        }
    </style>
</head>
<body class="bg-gray-900 text-white h-full overflow-hidden">

    <!-- 
      –°–µ–∫—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
      JavaScript –±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ–¥–Ω—É –∏ —Å–∫—Ä—ã–≤–∞—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç URL hash.
    -->

    <!-- ======================= -->
    <!--      –≠–ö–†–ê–ù –í–•–û–î–ê        -->
    <!-- ======================= -->
    <section id="login" class="page hidden h-full">
        <div class="flex items-center justify-center min-h-full px-4 py-12">
            <div class="w-full max-w-md space-y-8">
                <div>
                    <h2 class="mt-6 text-center text-3xl font-bold tracking-tight text-white">
                        –í—Ö–æ–¥ –≤ CatAI
                    </h2>
                </div>
                <form id="login-form" class="mt-8 space-y-6" action="#" method="POST">
                    <input type="hidden" name="remember" value="true">
                    <div class="rounded-md shadow-sm -space-y-px">
                        <div>
                            <label for="login-email" class="sr-only">Email</label>
                            <input id="login-email" name="email" type="email" autocomplete="email" required
                                class="relative block w-full appearance-none rounded-t-md border-0 bg-gray-700 px-3 py-3 text-white placeholder-gray-400 focus:z-10 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm"
                                placeholder="Email" value="user@catai.com">
                        </div>
                        <div>
                            <label for="login-password" class="sr-only">–ü–∞—Ä–æ–ª—å</label>
                            <input id="login-password" name="password" type="password" autocomplete="current-password" required
                                class="relative block w-full appearance-none rounded-b-md border-0 bg-gray-700 px-3 py-3 text-white placeholder-gray-400 focus:z-10 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm"
                                placeholder="–ü–∞—Ä–æ–ª—å" value="password">
                        </div>
                    </div>

                    <div>
                        <button type="submit"
                            class="group relative flex w-full justify-center rounded-md border border-transparent bg-blue-600 py-2 px-4 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900">
                            –í–æ–π—Ç–∏
                        </button>
                    </div>
                </form>
                <p class="text-center text-sm text-gray-400">
                    –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞?
                    <a href="#register" class="font-medium text-blue-400 hover:text-blue-300">
                        –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                    </a>
                </p>
            </div>
        </div>
    </section>

    <!-- ======================= -->
    <!--    –≠–ö–†–ê–ù –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò    -->
    <!-- ======================= -->
    <section id="register" class="page hidden h-full">
        <div class="flex items-center justify-center min-h-full px-4 py-12">
            <div class="w-full max-w-md space-y-8">
                <div>
                    <h2 class="mt-6 text-center text-3xl font-bold tracking-tight text-white">
                        –°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç CatAI
                    </h2>
                </div>
                <form id="register-form" class="mt-8 space-y-6" action="#" method="POST">
                    <div class="rounded-md shadow-sm space-y-3">
                        <div>
                            <label for="register-email" class="sr-only">Email</label>
                            <input id="register-email" name="email" type="email" autocomplete="email" required
                                class="relative block w-full appearance-none rounded-md border-0 bg-gray-700 px-3 py-3 text-white placeholder-gray-400 focus:z-10 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm"
                                placeholder="Email">
                        </div>
                        <div>
                            <label for="register-password" class="sr-only">–ü–∞—Ä–æ–ª—å</label>
                            <input id="register-password" name="password" type="password" required
                                class="relative block w-full appearance-none rounded-md border-0 bg-gray-700 px-3 py-3 text-white placeholder-gray-400 focus:z-10 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm"
                                placeholder="–ü–∞—Ä–æ–ª—å">
                        </div>
                         <div>
                            <label for="register-confirm-password" class="sr-only">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                            <input id="register-confirm-password" name="confirm-password" type="password" required
                                class="relative block w-full appearance-none rounded-md border-0 bg-gray-700 px-3 py-3 text-white placeholder-gray-400 focus:z-10 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm"
                                placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                        </div>
                    </div>

                    <div>
                        <button type="submit"
                            class="group relative flex w-full justify-center rounded-md border border-transparent bg-blue-600 py-2 px-4 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900">
                            –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                        </button>
                    </div>
                </form>
                <p class="text-center text-sm text-gray-400">
                    –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç?
                    <a href="#login" class="font-medium text-blue-400 hover:text-blue-300">
                        –í–æ–π—Ç–∏
                    </a>
                </p>
            </div>
        </div>
    </section>

    <!-- ======================= -->
    <!--       –≠–ö–†–ê–ù –ß–ê–¢–ê        -->
    <!-- ======================= -->
    <section id="ai" class="page hidden h-full">
        <div class="flex h-full">
            <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å (–¥–ª—è –ø–æ—Ö–æ–∂–µ—Å—Ç–∏ –Ω–∞ ChatGPT) -->
            <div class="hidden md:flex md:w-64 flex-col bg-gray-950 border-r border-gray-700">
                <div class="flex h-full min-h-0 flex-col">
                    <div class="flex-1 overflow-y-auto p-4">
                        <!-- –ö–Ω–æ–ø–∫–∞ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞ -->
                        <a href="#ai" id="new-chat-btn" class="flex items-center justify-between w-full px-3 py-2 rounded-lg text-white bg-blue-600 hover:bg-blue-700 mb-4">
                            <span>–ù–æ–≤—ã–π —á–∞—Ç</span>
                            <!-- –ò–∫–æ–Ω–∫–∞ "–ø–ª—é—Å" -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                        </a>
                        
                        <!-- –°–ø–∏—Å–æ–∫ –ø—Ä–æ—à–ª—ã—Ö —á–∞—Ç–æ–≤ (–±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω JS) -->
                        <nav id="chat-history-list" class="flex-1 space-y-1">
                            <!-- –°—é–¥–∞ JS –¥–æ–±–∞–≤–∏—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ —á–∞—Ç—ã -->
                        </nav>
                    </div>
                    <!-- –§—É—Ç–µ—Ä —Å–∞–π–¥–±–∞—Ä–∞ -->
                    <div class="border-t border-gray-700 p-4">
                         <a href="#login" id="logout-btn" class="flex w-full items-center px-3 py-2 text-sm font-medium rounded-md text-gray-400 hover:bg-gray-800 hover:text-white">
                            <!-- –ò–∫–æ–Ω–∫–∞ –≤—ã—Ö–æ–¥–∞ -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" />
                            </svg>
                            –í—ã–π—Ç–∏
                        </a>
                    </div>
                </div>
            </div>

            <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
            <div class="flex flex-1 flex-col overflow-hidden">
                <!-- –•–µ–¥–µ—Ä (–≤–∏–¥–µ–Ω –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö) -->
                <header class="flex md:hidden items-center justify-between border-b border-gray-700 bg-gray-900 px-4 py-3">
                     <h1 class="text-lg font-semibold text-white">CatAI</h1>
                     <a href="#login" class="text-gray-400 hover:text-white">
                        <!-- –ò–∫–æ–Ω–∫–∞ –≤—ã—Ö–æ–¥–∞ -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                     </a>
                </header>

                <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π -->
                <main class="flex-1 overflow-y-auto" id="chat-messages">
                    <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ —Å –ø–æ–º–æ—â—å—é JavaScript. -->
                </main>

                <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ø–µ—á–∞—Ç–∞–µ—Ç..." (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                <div id="typing-indicator" class="hidden px-4 py-2 text-sm text-gray-400">
                    CatAI –ø–µ—á–∞—Ç–∞–µ—Ç...
                </div>

                <!-- –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è -->
                <footer class="p-4 bg-gray-900 border-t border-gray-700">
                    <form id="chat-form" class="flex items-center space-x-3">
                        <label for="chat-input" class="sr-only">–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</label>
                        <input type="text" id="chat-input" autocomplete="off"
                            class="flex-1 block w-full rounded-lg border-0 bg-gray-800 px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500"
                            placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å –¥–ª—è CatAI...">
                        
                        <!-- == –ö–ù–û–ü–ö–ê –í–´–ë–û–†–ê –ú–û–î–ï–õ–ò == -->
                        <div class="relative flex-shrink-0">
                            <label for="model-select" class="sr-only">–í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏</label>
                            <select id="model-select" name="model"
                                class="h-12 appearance-none block w-full rounded-lg border-0 bg-gray-800 pl-3 pr-8 py-3 text-white focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm">
                                <option>CatAI</option>
                                <option>CatAI Pro</option>
                            </select>
                            <!-- –ò–∫–æ–Ω–∫–∞ —Å—Ç—Ä–µ–ª–∫–∏ –¥–ª—è select -->
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                        <!-- == /–ö–ù–û–ü–ö–ê –í–´–ë–û–†–ê –ú–û–î–ï–õ–ò == -->

                        <button type="submit"
                            class="inline-flex flex-shrink-0 h-12 w-12 items-center justify-center rounded-lg bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900">
                            <!-- –ò–∫–æ–Ω–∫–∞ "–æ—Ç–ø—Ä–∞–≤–∏—Ç—å" (–±—É–º–∞–∂–Ω—ã–π —Å–∞–º–æ–ª–µ—Ç–∏–∫) -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                              <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009.175 16V4.697a1 1 0 00-1.169-1.409l-5 1.429zM10 4.697v11.304l5-1.429a1 1 0 00.707-1.707l-7-14z" />
                            </svg>
                            <span class="sr-only">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</span>
                        </button>
                    </form>
                    <p class="text-center text-xs text-gray-500 mt-3">
                        CatAI. –û—Ç–≤–µ—Ç—ã –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ—Ç–æ—á–Ω—ã–º–∏.
                    </p>
                </footer>
            </div>
        </div>
    </section>

    <!-- 
      ========================================
      FIREBASE SDKs
      ========================================
      –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥—É–ª–∏ Firebase, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞–º –Ω—É–∂–Ω—ã
    -->
    <script type="module">
        // –ò–º–ø–æ—Ä—Ç—ã Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getDatabase, ref, onValue, push, set } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        // –¢–≤–æ—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCcgLac2riawIGPHsdkXLOeFTEY_TUZX_s",
            authDomain: "catai-1624d.firebaseapp.com",
            databaseURL: "https://catai-1624d-default-rtdb.firebaseio.com",
            projectId: "catai-1624d",
            storageBucket: "catai-1624d.firebasestorage.app",
            messagingSenderId: "565260079109",
            appId: "1:565260079109:web:fd10c337a424555c0b0c6c"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ===
        const pages = document.querySelectorAll('.page');
        
        // –§–æ—Ä–º—ã
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const registerEmailInput = document.getElementById('register-email');
        const registerPasswordInput = document.getElementById('register-password');
        const registerConfirmPasswordInput = document.getElementById('register-confirm-password'); // <-- –î–û–ë–ê–í–õ–ï–ù–û

        // –ß–∞—Ç
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const modelSelect = document.getElementById('model-select'); // <-- –î–û–ë–ê–í–õ–ï–ù–û
        const chatMessages = document.getElementById('chat-messages');
        const typingIndicator = document.getElementById('typing-indicator');
        const newChatBtn = document.getElementById('new-chat-btn');
        const chatHistoryList = document.getElementById('chat-history-list');
        const logoutBtn = document.getElementById('logout-btn');

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let currentUserId = null;
        let userChatsData = {}; // –ö—ç—à –¥–∞–Ω–Ω—ã—Ö –∏–∑ RTDB
        let currentActiveChatId = null;
        let chatsListener = null; // –•—Ä–∞–Ω–∏—Ç —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ø–∏—Å–∫–∏ –æ—Ç onValue

        const WELCOME_MESSAGE = '–ü—Ä–∏–≤–µ—Ç! –Ø CatAI. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?';

        // === –õ–û–ì–ò–ö–ê –ú–ê–†–®–†–£–¢–ò–ó–ê–¶–ò–ò (–ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–Ø –°–¢–†–ê–ù–ò–¶) ===

        function updateView() {
            const hash = window.location.hash || (currentUserId ? '#ai' : '#login');
            
            pages.forEach(page => page.classList.add('hidden'));

            const activePage = document.querySelector(hash);
            if (activePage) {
                activePage.classList.remove('hidden');
            } else {
                document.querySelector('#login').classList.remove('hidden');
            }
        }
        window.addEventListener('hashchange', updateView);

        // === –ì–õ–ê–í–ù–´–ô –°–õ–£–®–ê–¢–ï–õ–¨ –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò ===
        // –≠—Ç–æ —è–¥—Ä–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –û–Ω —Ä–µ—à–∞–µ—Ç, —á—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å: –ª–æ–≥–∏–Ω –∏–ª–∏ —á–∞—Ç.

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É
                currentUserId = user.uid;
                if (window.location.hash !== '#ai') {
                    window.location.hash = '#ai';
                }
                setupChatListeners(currentUserId); // –ó–∞–ø—É—Å–∫–∞–µ–º realtime-—Å–ª—É—à–∞—Ç–µ–ª—å
            } else {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª
                currentUserId = null;
                if (window.location.hash !== '#login' && window.location.hash !== '#register') {
                    window.location.hash = '#login';
                }
                cleanupChatListeners(); // –û—Ç–∫–ª—é—á–∞–µ–º realtime-—Å–ª—É—à–∞—Ç–µ–ª—å
                chatHistoryList.innerHTML = '';
                chatMessages.innerHTML = '';
            }
            updateView();
        });

        // === –õ–û–ì–ò–ö–ê –§–û–†–ú –í–•–û–î–ê –ò –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò (FIREBASE) ===

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged —Å–∞–º –ø–µ—Ä–µ–∫–∏–Ω–µ—Ç –Ω–∞—Å –Ω–∞ #ai
            } catch (error) {
                alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + error.message);
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = registerEmailInput.value;
            const password = registerPasswordInput.value;
            const confirmPassword = registerConfirmPasswordInput.value; // <-- –î–û–ë–ê–í–õ–ï–ù–û

            // <-- –î–û–ë–ê–í–õ–ï–ù–ê –ü–†–û–í–ï–†–ö–ê
            if (password !== confirmPassword) {
                alert("–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!");
                return;
            }

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged –ø–æ–π–º–∞–µ—Ç –Ω–æ–≤–æ–≥–æ —é–∑–µ—Ä–∞, –Ω–æ –º—ã
                // –ø–µ—Ä–µ–∫–∏–Ω–µ–º –µ–≥–æ –Ω–∞ –ª–æ–≥–∏–Ω, —á—Ç–æ–±—ã –æ–Ω –≤–æ—à–µ–ª —Å–∞–º.
                alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏.');
                window.location.hash = '#login';
            } catch (error) {
                alert("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: " + error.message);
            }
        });

        logoutBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            await signOut(auth);
            // onAuthStateChanged —Å–∞–º –ø–µ—Ä–µ–∫–∏–Ω–µ—Ç –Ω–∞ #login
        });


        // === –õ–û–ì–ò–ö–ê FIREBASE REALTIME DATABASE ===

        /** –ó–∞–ø—É—Å–∫–∞–µ—Ç onValue —Å–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è —á–∞—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
        function setupChatListeners(uid) {
            cleanupChatListeners(); // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π, –µ—Å–ª–∏ –µ—Å—Ç—å
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–±—Ä–∞–Ω—ã –ª–∏—à–Ω–∏–µ –∫–∞–≤—ã—á–∫–∏ –≤ –ø—É—Ç–∏ –∫ ref. –ë—ã–ª–æ 'users/'' + uid + ''/chats'
            const chatsRef = ref(db, 'users/' + uid + '/chats');
            
            // onValue –±—É–¥–µ—Ç —Å—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ö–ê–ñ–î–´–ô –†–ê–ó, –∫–æ–≥–¥–∞ –¥–∞–Ω–Ω—ã–µ –º–µ–Ω—è—é—Ç—Å—è –≤ RTDB
            chatsListener = onValue(chatsRef, (snapshot) => {
                userChatsData = snapshot.val() || {};
                
                // –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç —á–∞—Ç–æ–≤, —Å–æ–∑–¥–∞–µ–º –ø–µ—Ä–≤—ã–π
                if (Object.keys(userChatsData).length === 0) {
                    createNewChat(); // –û–Ω —Å–æ–∑–¥–∞—Å—Ç —á–∞—Ç, –∏ onValue –≤—ã–∑–æ–≤–µ—Ç—Å—è –°–ù–û–í–ê
                    return;
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∞–ª–∏–¥–µ–Ω –ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç
                if (!currentActiveChatId || !userChatsData[currentActiveChatId]) {
                    // –ï—Å–ª–∏ –Ω–µ—Ç, –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –∏–∑ —Å–ø–∏—Å–∫–∞
                    currentActiveChatId = Object.keys(userChatsData)[0];
                }

                // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                renderSidebar(userChatsData, currentActiveChatId);
                renderChat(currentActiveChatId);
            });
        }

        /** –û—Ç–∫–ª—é—á–∞–µ—Ç onValue —Å–ª—É—à–∞—Ç–µ–ª—å */
        function cleanupChatListeners() {
            if (chatsListener) {
                chatsListener(); // –≠—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø–∏—Å–∫–∏, –∫–æ—Ç–æ—Ä—É—é –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç onValue
                chatsListener = null;
            }
            userChatsData = {};
        }

        /** –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π —á–∞—Ç –≤ RTDB */
        async function createNewChat() {
            if (!currentUserId) return;
            
            const chatsRef = ref(db, `users/${currentUserId}/chats`);
            const newChatRef = push(chatsRef); // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID –¥–ª—è —á–∞—Ç–∞

            // –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            const messagesRef = ref(db, `users/${currentUserId}/chats/${newChatRef.key}/messages`);
            const firstMessageRef = push(messagesRef); // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è
            
            // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞
            await set(firstMessageRef, { sender: 'ai', text: WELCOME_MESSAGE });
            await set(ref(db, `users/${currentUserId}/chats/${newChatRef.key}/title`), '–ù–æ–≤—ã–π —á–∞—Ç');

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —á–∞—Ç –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—ã–π
            currentActiveChatId = newChatRef.key;
            // onValue listener —Å–∞–º –ø–æ–π–º–∞–µ—Ç —ç—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∏ –≤—Å–µ –ø–µ—Ä–µ—Ä–∏—Å—É–µ—Ç.
        }

        // === –õ–û–ì–ò–ö–ê –ß–ê–¢–ê (–†–ï–ù–î–ï–†–ò–ù–ì) ===
        // –≠—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —Ç–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ —Ä–∏—Å—É—é—Ç. –û–Ω–∏ –Ω–µ —Ö—Ä–∞–Ω—è—Ç –∏ –Ω–µ —á–∏—Ç–∞—é—Ç,
        // —ç—Ç–∏–º –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è onValue.

        /** –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –≤ —Å–∞–π–¥–±–∞—Ä–µ */
        function renderSidebar(chats, activeId) {
            chatHistoryList.innerHTML = '';
            // chats - —ç—Ç–æ –æ–±—ä–µ–∫—Ç { chatId1: {title: ...}, chatId2: {title: ...} }
            Object.keys(chats).forEach(chatId => {
                const chat = chats[chatId];
                if (!chat) return; // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π

                const isActive = chatId === activeId;
                const link = document.createElement('a');
                link.href = '#ai';
                link.dataset.chatId = chatId; // –ò—Å–ø–æ–ª—å–∑—É–µ–º ID –∏–∑ Firebase
                link.textContent = chat.title || '–ß–∞—Ç –±–µ–∑ –∏–º–µ–Ω–∏';
                link.className = `block truncate px-3 py-2 text-sm font-medium rounded-md ${
                    isActive 
                    ? 'text-white bg-gray-800' 
                    : 'text-gray-400 hover:bg-gray-800 hover:text-white'
                }`;
                chatHistoryList.appendChild(link);
            });
        }

        /** –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞ */
        function renderChat(chatId) {
            if (!chatId || !userChatsData[chatId]) {
                chatMessages.innerHTML = '<p class="p-4 text-gray-500">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π.</p>';
                return;
            }
            
            currentActiveChatId = chatId; // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π ID
            const chat = userChatsData[chatId];
            chatMessages.innerHTML = ''; // –û—á–∏—â–∞–µ–º —á–∞—Ç
            
            if (chat.messages) {
                // chat.messages - —ç—Ç–æ –æ–±—ä–µ–∫—Ç { msgId1: {...}, msgId2: {...} }
                // RTDB –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é —Ö—Ä–∞–Ω–∏—Ç –∏—Ö –≤ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º –ø–æ—Ä—è–¥–∫–µ
                Object.values(chat.messages).forEach(message => {
                    addMessageToDOM(message.text, message.sender);
                });
            } else {
                // –ï—Å–ª–∏ —á–∞—Ç –µ—Å—Ç—å, –∞ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç (—Ä–µ–¥–∫–∏–π —Å–ª—É—á–∞–π)
                addMessageToDOM(WELCOME_MESSAGE, 'ai');
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∞–π–¥–±–∞—Ä, —á—Ç–æ–±—ã –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç
            renderSidebar(userChatsData, chatId);
        }

        /** –î–æ–±–∞–≤–ª—è–µ—Ç –û–î–ù–û —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ DOM (–≤ –æ–∫–Ω–æ —á–∞—Ç–∞) */
        function addMessageToDOM(text, sender) {
            const messageElement = document.createElement('div');
            // ... (–≤–µ—Å—å —Ç–æ—Ç –∂–µ HTML-–∫–æ–Ω—Ç–µ–Ω—Ç, —á—Ç–æ –∏ –≤ –ø—Ä–æ—à–ª–æ–π –≤–µ—Ä—Å–∏–∏) ...
            messageElement.classList.add('message', 'p-4', 'max-w-3xl', 'mx-auto');

            let content = '';

            if (sender === 'ai') {
                messageElement.classList.add('bg-gray-800'); 
                content = `
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center font-bold text-sm">C</div>
                        <div class="flex-1">
                            <p class="font-semibold">CatAI</p>
                            <p class="text-gray-300">${text}</p>
                        </div>
                    </div>
                `;
            } else {
                content = `
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center font-bold text-sm">U</div>
                        <div class="flex-1">
                            <p class="font-semibold">–í—ã</p>
                            <p class="text-white">${text}</p>
                        </div>
                    </div>
                `;
            }

            messageElement.innerHTML = content;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight; // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞
        }
        
        /** –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏ –°–û–•–†–ê–ù–Ø–ï–¢ –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò */
        async function getAIResponse(userInput, chatId) {
            const lowerInput = userInput.toLowerCase();
            let response = '';

            // <-- –î–û–ë–ê–í–õ–ï–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–∞—è –º–æ–¥–µ–ª—å –≤—ã–±—Ä–∞–Ω–∞
            const selectedModel = modelSelect.value; 
            let modelPrefix = '(CatAI): ';

            if (selectedModel === 'CatAI Pro') {
                modelPrefix = '(CatAI Pro üöÄ): ';
            }

            if (lowerInput.includes('–ø—Ä–∏–≤–µ—Ç')) {
                response = modelPrefix + '–ú—è—É! –ü—Ä–∏–≤–µ—Ç. –ß–µ–º –º–æ–≥—É –±—ã—Ç—å –ø–æ–ª–µ–∑–µ–Ω?';
            } else if (lowerInput.includes('–∫–∞–∫ –¥–µ–ª–∞')) {
                response = modelPrefix + '–Ø CatAI, –∏ —É –º–µ–Ω—è –≤—Å–µ –≤ –ø–æ—Ä—è–¥–∫–µ. –ê —É –≤–∞—Å?';
            } else if (lowerInput.includes('–ø–æ–∫–∞')) {
                response = modelPrefix + '–î–æ –≤—Å—Ç—Ä–µ—á–∏! –ë—ã–ª —Ä–∞–¥ –ø–æ–æ–±—â–∞—Ç—å—Å—è. –ú—è—É!';
            } else if (lowerInput.includes('–∫–æ—Ç–∏–∫') || lowerInput.includes('–∫–æ—à–∫–∞')) {
                response = modelPrefix + '–Ø –æ—á–µ–Ω—å –ª—é–±–ª—é –∫–æ—Ç–∏–∫–æ–≤! –ú—Ä—Ä—Ä...';
            } else {
                response = modelPrefix + '–ò–∑–≤–∏–Ω–∏—Ç–µ, —è CatAI –∏ –Ω–µ –º–æ–≥—É –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å. –Ø –µ—â–µ —É—á—É—Å—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–ø—Ä–æ—Å–∏—Ç—å —á—Ç–æ-–Ω–∏–±—É–¥—å –¥—Ä—É–≥–æ–µ.';
            }

            // –ü—Ä–æ—Å—Ç–æ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –≤ RTDB. onValue –µ–≥–æ –ø–æ–π–º–∞–µ—Ç –∏ –æ—Ç—Ä–∏—Å—É–µ—Ç.
            if (currentUserId && chatId) {
                const messagesRef = ref(db, `users/${currentUserId}/chats/${chatId}/messages`);
                const newMessageRef = push(messagesRef);
                await set(newMessageRef, { sender: 'ai', text: response });
            }

            // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —á–∞—Ç –≤—Å–µ –µ—â–µ –∞–∫—Ç–∏–≤–µ–Ω)
            if (chatId === currentActiveChatId) {
                typingIndicator.classList.add('hidden');
            }
        }


        // === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ===

        // 1. –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã —á–∞—Ç–∞
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageText = chatInput.value.trim();
            const activeId = currentActiveChatId;

            if (messageText && activeId && currentUserId) {
                // 1. –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ –≤–≤–æ–¥–∞
                chatInput.value = '';
                
                // 2. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ RTDB
                const messagesRef = ref(db, `users/${currentUserId}/chats/${activeId}/messages`);
                const newMessageRef = push(messagesRef);
                await set(newMessageRef, { sender: 'user', text: messageText });
                // onValue –ø–æ–π–º–∞–µ—Ç —ç—Ç–æ –∏ –æ—Ç—Ä–∏—Å—É–µ—Ç.
                
                // 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ –Ω—É–∂–Ω–æ –ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞
                const chat = userChatsData[activeId];
                const messageCount = chat.messages ? Object.keys(chat.messages).length : 0;
                
                // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤—Ç–æ—Ä–æ–µ –≤ —á–∞—Ç–µ –ø–æ—Å–ª–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –ò–ò)
                if (messageCount === 1) { 
                    const newTitle = messageText.length > 25 ? messageText.substring(0, 25) + '...' : messageText;
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ RTDB
                    await set(ref(db, `users/${currentUserId}/chats/${activeId}/title`), newTitle);
                    // onValue –ø–æ–π–º–∞–µ—Ç –∏ —ç—Ç–æ.
                }
                
                // 4. –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ø–µ—á–∞—Ç–∞–µ—Ç"
                typingIndicator.classList.remove('hidden');

                // 5. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç –ò–ò (–æ–Ω —Å–∞–º —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ RTDB)
                setTimeout(getAIResponse, 1500, messageText, activeId);
            }
        });
        
        // 2. –ù–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ "–ù–æ–≤—ã–π —á–∞—Ç"
        newChatBtn.addEventListener('click', (e) => {
            e.preventDefault();
            createNewChat(); // –ü—Ä–æ—Å—Ç–æ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —á–∞—Ç. onValue —Å–¥–µ–ª–∞–µ—Ç –æ—Å—Ç–∞–ª—å–Ω–æ–µ.
        });
        
        // 3. –ù–∞–∂–∞—Ç–∏–µ –Ω–∞ —á–∞—Ç –≤ –∏—Å—Ç–æ—Ä–∏–∏ (–¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π)
        chatHistoryList.addEventListener('click', (e) => {
            const link = e.target.closest('a[data-chat-id]');
            if (link) {
                e.preventDefault();
                const chatId = link.dataset.chatId;
                if (chatId !== currentActiveChatId) {
                    renderChat(chatId); // –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º, –¥–∞–Ω–Ω—ã–µ —É–∂–µ –µ—Å—Ç—å
                    typingIndicator.classList.add('hidden');
                }
            }
        });

    </script>

</body>
</html>
