<!DOCTYPE html>
<html lang="ru" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CatAI - –í—Ö–æ–¥</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —à—Ä–∏—Ñ—Ç—ã -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ –≤ —á–∞—Ç–µ */
        #chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        #chat-messages::-webkit-scrollbar-track {
            background: #202123; /* –¶–≤–µ—Ç —Ñ–æ–Ω–∞ —Ç—Ä–µ–∫–∞ */
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background-color: #4a4a4a; /* –¶–≤–µ—Ç –ø–æ–ª–∑—É–Ω–∫–∞ */
            border-radius: 20px; /* –°–∫—Ä—É–≥–ª–µ–Ω–∏–µ */
        }
    </style>
</head>
<body class="bg-gray-900 text-white h-full overflow-hidden">

    <!-- 
      –°–µ–∫—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
      JavaScript –±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ–¥–Ω—É –∏ —Å–∫—Ä—ã–≤–∞—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç URL hash.
    -->

    <!-- ======================= -->
    <!--      –≠–ö–†–ê–ù –í–•–û–î–ê        -->
    <!-- ======================= -->
    <section id="login" class="page hidden h-full">
        <div class="flex items-center justify-center min-h-full px-4 py-12">
            <div class="w-full max-w-md space-y-8">
                <div>
                    <h2 class="mt-6 text-center text-3xl font-bold tracking-tight text-white">
                        –í—Ö–æ–¥ –≤ CatAI
                    </h2>
                </div>
                <form id="login-form" class="mt-8 space-y-6" action="#" method="POST">
                    <input type="hidden" name="remember" value="true">
                    <div class="rounded-md shadow-sm -space-y-px">
                        <div>
                            <label for="login-email" class="sr-only">Email</label>
                            <input id="login-email" name="email" type="email" autocomplete="email" required
                                class="relative block w-full appearance-none rounded-t-md border-0 bg-gray-700 px-3 py-3 text-white placeholder-gray-400 focus:z-10 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm"
                                placeholder="Email" value="user@catai.com">
                        </div>
                        <div>
                            <label for="login-password" class="sr-only">–ü–∞—Ä–æ–ª—å</label>
                            <input id="login-password" name="password" type="password" autocomplete="current-password" required
                                class="relative block w-full appearance-none rounded-b-md border-0 bg-gray-700 px-3 py-3 text-white placeholder-gray-400 focus:z-10 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500 sm:text-sm"
                                placeholder="–ü–∞—Ä–æ–ª—å" value="password">
                        </div>
                    </div>
                    <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –º–æ–¥–µ–ª–µ–π (–°–¢–ê–†–´–ô –ö–û–î –£–î–ê–õ–ï–ù) -->
                    <!-- ================================== -->
                    <!-- –ù–û–í–´–ô –ò–ù–¢–ï–†–ê–ö–¢–ò–í–ù–´–ô –ë–õ–û–ö –í–´–ë–û–†–ê -->
                    <!-- ================================== -->
                    <div class="mt-6 space-y-6">
                        <!-- 1. –í—ã–±–æ—Ä –ú–æ–¥–µ–ª–∏ -->
                        <fieldset>
                            <legend class="text-base font-medium text-white">1. –í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å</legend>
                            <div class="mt-4 space-y-4">
                                <!-- –ú–æ–¥–µ–ª—å Base -->
                                <div class="flex items-center">
                                    <input id="model-base" name="model-selection" type="radio" value="base" class="h-4 w-4 text-blue-600 border-gray-600 focus:ring-blue-500 bg-gray-700">
                                    <label for="model-base" class="ml-3 block text-sm font-medium text-gray-300">
                                        CatAI base üêà <span class="text-gray-400">(–î–æ—Å—Ç—É–ø–Ω–æ)</span>
                                    </label>
                                </div>
                                <!-- –ú–æ–¥–µ–ª—å Fast -->
                                <div class="flex items-center">
                                    <input id="model-fast" name="model-selection" type="radio" value="fast" class="h-4 w-4 text-blue-600 border-gray-600 focus:ring-blue-500 bg-gray-700">
                                    <label for="model-fast" class="ml-3 block text-sm font-medium text-gray-300">
                                        CatAI Fast ‚ö° <span class="text-gray-400">(–î–æ—Å—Ç—É–ø–Ω–æ)</span>
                                    </label>
                                </div>
                                <!-- –ú–æ–¥–µ–ª—å PRO -->
                                <div class="flex items-center">
                                    <input id="model-pro" name="model-selection" type="radio" value="pro" class="h-4 w-4 text-blue-600 border-gray-600 focus:ring-blue-500 bg-gray-700">
                                    <label for="model-pro" class="ml-3 block text-sm font-medium text-gray-300">
                                        CatAI PRO üöÄ <span class="text-yellow-400">(–¢—Ä–µ–±—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏)</span>
                                    </label>
                                </div>
                            </div>
                        </fieldset>

                        <!-- 2. –í—ã–±–æ—Ä –õ–∏–º–∏—Ç–∞ (–°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                        <fieldset id="limit-selection-fieldset" class="hidden">
                            <legend class="text-base font-medium text-white">2. –í—ã–±–µ—Ä–∏—Ç–µ –ª–∏–º–∏—Ç (–¥–ª—è PRO)</legend>
                            <div class="mt-4 grid grid-cols-3 gap-3">
                                <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º radio-–∫–Ω–æ–ø–∫–∏, —Å—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–¥ –∫–Ω–æ–ø–∫–∏ -->
                                <div>
                                    <input type="radio" name="limit-selection" id="limit-1k" value="1k" class="sr-only peer">
                                    <label for="limit-1k" class="block w-full text-center p-3 rounded-lg bg-gray-700 text-gray-300 cursor-pointer hover:bg-gray-600 peer-checked:bg-blue-600 peer-checked:text-white">1–∫</label>
                                </div>
                                <div>
                                    <input type="radio" name="limit-selection" id="limit-3k" value="3k" class="sr-only peer">
                                    <label for="limit-3k" class="block w-full text-center p-3 rounded-lg bg-gray-700 text-gray-300 cursor-pointer hover:bg-gray-600 peer-checked:bg-blue-600 peer-checked:text-white">3–∫</label>
                                </div>
                                <div>
                                    <input type="radio" name="limit-selection" id="limit-5k" value="5k" class="sr-only peer">
                                    <label for="limit-5k" class="block w-full text-center p-3 rounded-lg bg-gray-700 text-gray-300 cursor-pointer hover:bg-gray-600 peer-checked:bg-blue-600 peer-checked:text-white">5–∫</label>
                                </div>
                                <div>
                                    <input type="radio" name="limit-selection" id="limit-10k" value="10k" class="sr-only peer">
                                    <label for="limit-10k" class="block w-full text-center p-3 rounded-lg bg-gray-700 text-gray-300 cursor-pointer hover:bg-gray-600 peer-checked:bg-blue-600 peer-checked:text-white">10–∫</label>
                                </div>
                                <div>
                                    <input type="radio" name="limit-selection" id="limit-30k" value="30k" class="sr-only peer">
                                    <label for="limit-30k" class="block w-full text-center p-3 rounded-lg bg-gray-700 text-gray-300 cursor-pointer hover:bg-gray-600 peer-checked:bg-blue-600 peer-checked:text-white">30–∫</label>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                    <!-- ================================== -->
                    <!-- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê -->
                    <!-- ================================== -->
                </div>
                <!-- –ò–ó–ú–ï–ù–ï–ù –§–£–¢–ï–† –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê -->
                <div class="bg-gray-800 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse border-t border-gray-700">
                    <button id="purchase-btn" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm" disabled>
                        –û–ø–ª–∞—Ç–∏—Ç—å (–°–∫–æ—Ä–æ)
                    </button>
                    <button id="close-modal-btn" type="button" class="mt-3 sm:mt-0 w-full inline-flex justify-center rounded-md border border-gray-600 shadow-sm px-4 py-2 bg-gray-700 text-base font-medium text-white hover:bg-gray-600 focus:outline-none sm:w-auto sm:text-sm">
                        –ó–∞–∫—Ä—ã—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- 
      ========================================
      FIREBASE SDKs
      ========================================
      –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥—É–ª–∏ Firebase, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞–º –Ω—É–∂–Ω—ã
    -->
    <script type="module">
        // –ò–º–ø–æ—Ä—Ç—ã Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getDatabase, ref, onValue, push, set } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        // –¢–≤–æ—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCcgLac2riawIGPHsdkXLOeFTEY_TUZX_s",
            authDomain: "catai-1624d.firebaseapp.com",
            databaseURL: "https://catai-1624d-default-rtdb.firebaseio.com",
            projectId: "catai-1624d",
            storageBucket: "catai-1624d.firebasestorage.app",
            messagingSenderId: "565260079109",
            appId: "1:565260079109:web:fd10c337a424555c0b0c6c"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ===
        const pages = document.querySelectorAll('.page');
        
        // –§–æ—Ä–º—ã
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const registerEmailInput = document.getElementById('register-email');
        const registerPasswordInput = document.getElementById('register-password');
        const registerConfirmPasswordInput = document.getElementById('register-confirm-password'); // <-- –î–û–ë–ê–í–õ–ï–ù–û

        // –ß–∞—Ç
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const modelSelect = document.getElementById('model-select'); // <-- –î–û–ë–ê–í–õ–ï–ù–û
        const chatMessages = document.getElementById('chat-messages');
        const typingIndicator = document.getElementById('typing-indicator');
        const newChatBtn = document.getElementById('new-chat-btn');
        const chatHistoryList = document.getElementById('chat-history-list');
        const logoutBtn = document.getElementById('logout-btn');

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        const modelsBtn = document.getElementById('models-btn');
        const modelsModal = document.getElementById('models-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalBackdrop = document.getElementById('modal-backdrop');

        // == –ù–û–í–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –õ–û–ì–ò–ö–ò –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê ==
        const modelSelectionRadios = document.querySelectorAll('input[name="model-selection"]');
        const limitSelectionFieldset = document.getElementById('limit-selection-fieldset');
        const purchaseBtn = document.getElementById('purchase-btn');
        const limitSelectionRadios = document.querySelectorAll('input[name="limit-selection"]');


        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let currentUserId = null;
        let userChatsData = {}; // –ö—ç—à –¥–∞–Ω–Ω—ã—Ö –∏–∑ RTDB
        let currentActiveChatId = null;
        let chatsListener = null; // –•—Ä–∞–Ω–∏—Ç —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ø–∏—Å–∫–∏ –æ—Ç onValue
        let hasProSubscription = false; // <-- –°–ò–ú–£–õ–Ø–¶–ò–Ø –ü–û–î–ü–ò–°–ö–ò

        const WELCOME_MESSAGE = '–ü—Ä–∏–≤–µ—Ç! –Ø CatAI. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?';

        // === –õ–û–ì–ò–ö–ê –ú–ê–†–®–†–£–¢–ò–ó–ê–¶–ò–ò (–ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–Ø –°–¢–†–ê–ù–ò–¶) ===

        function updateView() {
            const hash = window.location.hash || (currentUserId ? '#ai' : '#login');
            
            pages.forEach(page => page.classList.add('hidden'));

            const activePage = document.querySelector(hash);
            if (activePage) {
                activePage.classList.remove('hidden');
            } else {
                document.querySelector('#login').classList.remove('hidden');
            }
        }
        window.addEventListener('hashchange', updateView);

        // === –ì–õ–ê–í–ù–´–ô –°–õ–£–®–ê–¢–ï–õ–¨ –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò ===
        // –≠—Ç–æ —è–¥—Ä–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –û–Ω —Ä–µ—à–∞–µ—Ç, —á—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å: –ª–æ–≥–∏–Ω –∏–ª–∏ —á–∞—Ç.

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É
                currentUserId = user.uid;
                if (window.location.hash !== '#ai') {
                    window.location.hash = '#ai';
                }
                setupChatListeners(currentUserId); // –ó–∞–ø—É—Å–∫–∞–µ–º realtime-—Å–ª—É—à–∞—Ç–µ–ª—å
                updateModelAvailability(); // <-- –í–´–ó–´–í–ê–ï–ú –û–ë–ù–û–í–õ–ï–ù–ò–ï –ú–û–î–ï–õ–ï–ô
            } else {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª
                currentUserId = null;
                if (window.location.hash !== '#login' && window.location.hash !== '#register') {
                    window.location.hash = '#login';
                }
                cleanupChatListeners(); // –û—Ç–∫–ª—é—á–∞–µ–º realtime-—Å–ª—É—à–∞—Ç–µ–ª—å
                chatHistoryList.innerHTML = '';
                chatMessages.innerHTML = '';
            }
            updateView();
        });

        // === –õ–û–ì–ò–ö–ê –§–û–†–ú –í–•–û–î–ê –ò –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò (FIREBASE) ===

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged —Å–∞–º –ø–µ—Ä–µ–∫–∏–Ω–µ—Ç –Ω–∞—Å –Ω–∞ #ai
            } catch (error) {
                alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + error.message);
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = registerEmailInput.value;
            const password = registerPasswordInput.value;
            const confirmPassword = registerConfirmPasswordInput.value; // <-- –î–û–ë–ê–í–õ–ï–ù–û

            // <-- –î–û–ë–ê–í–õ–ï–ù–ê –ü–†–û–í–ï–†–ö–ê
            if (password !== confirmPassword) {
                alert("–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!");
                return;
            }

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged –ø–æ–π–º–∞–µ—Ç –Ω–æ–≤–æ–≥–æ —é–∑–µ—Ä–∞, –Ω–æ –º—ã
                // –ø–µ—Ä–µ–∫–∏–Ω–µ–º –µ–≥–æ –Ω–∞ –ª–æ–≥–∏–Ω, —á—Ç–æ–±—ã –æ–Ω –≤–æ—à–µ–ª —Å–∞–º.
                alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏.');
                window.location.hash = '#login';
            } catch (error) {
                alert("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: " + error.message);
            }
        });

        logoutBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            await signOut(auth);
            // onAuthStateChanged —Å–∞–º –ø–µ—Ä–µ–∫–∏–Ω–µ—Ç –Ω–∞ #login
        });


        // === –õ–û–ì–ò–ö–ê FIREBASE REALTIME DATABASE ===

        /** –û–±–Ω–æ–≤–ª—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–µ–π –≤ <select> –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–¥–ø–∏—Å–∫–∏ */
        function updateModelAvailability() {
            const proOption = document.querySelector('#model-select option[value="pro"]');
            if (!proOption) return;

            if (hasProSubscription) {
                proOption.disabled = false;
                proOption.textContent = 'CatAI PRO';
            } else {
                proOption.disabled = true;
                proOption.textContent = 'CatAI PRO (–ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏)';
            }
        }

        /** –ó–∞–ø—É—Å–∫–∞–µ—Ç onValue —Å–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è —á–∞—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
        function setupChatListeners(uid) {
            cleanupChatListeners(); // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π, –µ—Å–ª–∏ –µ—Å—Ç—å
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–±—Ä–∞–Ω—ã –ª–∏—à–Ω–∏–µ –∫–∞–≤—ã—á–∫–∏ –≤ –ø—É—Ç–∏ –∫ ref. –ë—ã–ª–æ 'users/'' + uid + ''/chats'
            const chatsRef = ref(db, 'users/' + uid + '/chats');
            
            // onValue –±—É–¥–µ—Ç —Å—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ö–ê–ñ–î–´–ô –†–ê–ó, –∫–æ–≥–¥–∞ –¥–∞–Ω–Ω—ã–µ –º–µ–Ω—è—é—Ç—Å—è –≤ RTDB
            chatsListener = onValue(chatsRef, (snapshot) => {
                userChatsData = snapshot.val() || {};
                
                // –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç —á–∞—Ç–æ–≤, —Å–æ–∑–¥–∞–µ–º –ø–µ—Ä–≤—ã–π
                if (Object.keys(userChatsData).length === 0) {
                    createNewChat(); // –û–Ω —Å–æ–∑–¥–∞—Å—Ç —á–∞—Ç, –∏ onValue –≤—ã–∑–æ–≤–µ—Ç—Å—è –°–ù–û–í–ê
                    return;
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∞–ª–∏–¥–µ–Ω –ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç
                if (!currentActiveChatId || !userChatsData[currentActiveChatId]) {
                    // –ï—Å–ª–∏ –Ω–µ—Ç, –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –∏–∑ —Å–ø–∏—Å–∫–∞
                    currentActiveChatId = Object.keys(userChatsData)[0];
                }

                // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                renderSidebar(userChatsData, currentActiveChatId);
                renderChat(currentActiveChatId);
            });
        }

        /** –û—Ç–∫–ª—é—á–∞–µ—Ç onValue —Å–ª—É—à–∞—Ç–µ–ª—å */
        function cleanupChatListeners() {
            if (chatsListener) {
                chatsListener(); // –≠—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø–∏—Å–∫–∏, –∫–æ—Ç–æ—Ä—É—é –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç onValue
                chatsListener = null;
            }
            userChatsData = {};
        }

        /** –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π —á–∞—Ç –≤ RTDB */
        async function createNewChat() {
            if (!currentUserId) return;
            
            const chatsRef = ref(db, `users/${currentUserId}/chats`);
            const newChatRef = push(chatsRef); // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID –¥–ª—è —á–∞—Ç–∞

            // –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            const messagesRef = ref(db, `users/${currentUserId}/chats/${newChatRef.key}/messages`);
            const firstMessageRef = push(messagesRef); // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è
            
            // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞
            await set(firstMessageRef, { sender: 'ai', text: WELCOME_MESSAGE });
            await set(ref(db, `users/${currentUserId}/chats/${newChatRef.key}/title`), '–ù–æ–≤—ã–π —á–∞—Ç');

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —á–∞—Ç –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—ã–π
            currentActiveChatId = newChatRef.key;
            // onValue listener —Å–∞–º –ø–æ–π–º–∞–µ—Ç —ç—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∏ –≤—Å–µ –ø–µ—Ä–µ—Ä–∏—Å—É–µ—Ç.
        }

        // === –õ–û–ì–ò–ö–ê –ß–ê–¢–ê (–†–ï–ù–î–ï–†–ò–ù–ì) ===
        // –≠—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —Ç–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ —Ä–∏—Å—É—é—Ç. –û–Ω–∏ –Ω–µ —Ö—Ä–∞–Ω—è—Ç –∏ –Ω–µ —á–∏—Ç–∞—é—Ç,
        // —ç—Ç–∏–º –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è onValue.

        /** –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –≤ —Å–∞–π–¥–±–∞—Ä–µ */
        function renderSidebar(chats, activeId) {
            chatHistoryList.innerHTML = '';
            // chats - —ç—Ç–æ –æ–±—ä–µ–∫—Ç { chatId1: {title: ...}, chatId2: {title: ...} }
            Object.keys(chats).forEach(chatId => {
                const chat = chats[chatId];
                if (!chat) return; // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π

                const isActive = chatId === activeId;
                const link = document.createElement('a');
                link.href = '#ai';
                link.dataset.chatId = chatId; // –ò—Å–ø–æ–ª—å–∑—É–µ–º ID –∏–∑ Firebase
                link.textContent = chat.title || '–ß–∞—Ç –±–µ–∑ –∏–º–µ–Ω–∏';
                link.className = `block truncate px-3 py-2 text-sm font-medium rounded-md ${
                    isActive 
                    ? 'text-white bg-gray-800' 
                    : 'text-gray-400 hover:bg-gray-800 hover:text-white'
                }`;
                chatHistoryList.appendChild(link);
            });
        }

        /** –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞ */
        function renderChat(chatId) {
            if (!chatId || !userChatsData[chatId]) {
                chatMessages.innerHTML = '<p class="p-4 text-gray-500">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π.</p>';
                return;
            }
            
            currentActiveChatId = chatId; // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π ID
            const chat = userChatsData[chatId];
            chatMessages.innerHTML = ''; // –û—á–∏—â–∞–µ–º —á–∞—Ç
            
            if (chat.messages) {
                // chat.messages - —ç—Ç–æ –æ–±—ä–µ–∫—Ç { msgId1: {...}, msgId2: {...} }
                // RTDB –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é —Ö—Ä–∞–Ω–∏—Ç –∏—Ö –≤ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º –ø–æ—Ä—è–¥–∫–µ
                Object.values(chat.messages).forEach(message => {
                    addMessageToDOM(message.text, message.sender);
                });
            } else {
                // –ï—Å–ª–∏ —á–∞—Ç –µ—Å—Ç—å, –∞ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç (—Ä–µ–¥–∫–∏–π —Å–ª—É—á–∞–π)
                addMessageToDOM(WELCOME_MESSAGE, 'ai');
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∞–π–¥–±–∞—Ä, —á—Ç–æ–±—ã –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç
            renderSidebar(userChatsData, chatId);
        }

        /** –î–æ–±–∞–≤–ª—è–µ—Ç –û–î–ù–û —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ DOM (–≤ –æ–∫–Ω–æ —á–∞—Ç–∞) */
        function addMessageToDOM(text, sender) {
            const messageElement = document.createElement('div');
            // ... (–≤–µ—Å—å —Ç–æ—Ç –∂–µ HTML-–∫–æ–Ω—Ç–µ–Ω—Ç, —á—Ç–æ –∏ –≤ –ø—Ä–æ—à–ª–æ–π –≤–µ—Ä—Å–∏–∏) ...
            messageElement.classList.add('message', 'p-4', 'max-w-3xl', 'mx-auto');

            let content = '';

            if (sender === 'ai') {
                messageElement.classList.add('bg-gray-800'); 
                content = `
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center font-bold text-sm">C</div>
                        <div class="flex-1">
                            <p class="font-semibold">CatAI</p>
                            <p class="text-gray-300">${text}</p>
                        </div>
                    </div>
                `;
            } else {
                content = `
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center font-bold text-sm">U</div>
                        <div class="flex-1">
                            <p class="font-semibold">–í—ã</p>
                            <p class="text-white">${text}</p>
                        </div>
                    </div>
                `;
            }

            messageElement.innerHTML = content;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight; // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞
        }
        
        /** –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏ –°–û–•–†–ê–ù–Ø–ï–¢ –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò */
        async function getAIResponse(userInput, chatId) {
            const lowerInput = userInput.toLowerCase();
            let response = '';

            const selectedModel = modelSelect.value; 
            let modelPrefix = '';

            // <-- –ò–ó–ú–ï–ù–ï–ù–û: –õ–æ–≥–∏–∫–∞ –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤ –ø–æ 'value'
            if (selectedModel === 'base') {
                modelPrefix = '(CatAI base üêà): ';
            } else if (selectedModel === 'fast') {
                modelPrefix = '(CatAI Fast ‚ö°): ';
            } else if (selectedModel === 'pro') {
                modelPrefix = '(CatAI PRO üöÄ): ';
            } else {
                modelPrefix = `(${selectedModel}): `; // –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
            }


            if (lowerInput.includes('–ø—Ä–∏–≤–µ—Ç')) {
                response = modelPrefix + '–ú—è—É! –ü—Ä–∏–≤–µ—Ç. –ß–µ–º –º–æ–≥—É –±—ã—Ç—å –ø–æ–ª–µ–∑–µ–Ω?';
            } else if (lowerInput.includes('–∫–∞–∫ –¥–µ–ª–∞')) {
                response = modelPrefix + '–Ø CatAI, –∏ —É –º–µ–Ω—è –≤—Å–µ –≤ –ø–æ—Ä—è–¥–∫–µ. –ê —É –≤–∞—Å?';
            } else if (lowerInput.includes('–ø–æ–∫–∞')) {
                response = modelPrefix + '–î–æ –≤—Å—Ç—Ä–µ—á–∏! –ë—ã–ª —Ä–∞–¥ –ø–æ–æ–±—â–∞—Ç—å—Å—è. –ú—è—É!';
            } else if (lowerInput.includes('–∫–æ—Ç–∏–∫') || lowerInput.includes('–∫–æ—à–∫–∞')) {
                response = modelPrefix + '–Ø –æ—á–µ–Ω—å –ª—é–±–ª—é –∫–æ—Ç–∏–∫–æ–≤! –ú—Ä—Ä—Ä...';
            } else {
                response = modelPrefix + '–ò–∑–≤–∏–Ω–∏—Ç–µ, —è CatAI –∏ –Ω–µ –º–æ–≥—É –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å. –Ø –µ—â–µ —É—á—É—Å—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–ø—Ä–æ—Å–∏—Ç—å —á—Ç–æ-–Ω–∏–±—É–¥—å –¥—Ä—É–≥–æ–µ.';
            }

            // –ü—Ä–æ—Å—Ç–æ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –≤ RTDB. onValue –µ–≥–æ –ø–æ–π–º–∞–µ—Ç –∏ –æ—Ç—Ä–∏—Å—É–µ—Ç.
            if (currentUserId && chatId) {
                const messagesRef = ref(db, `users/${currentUserId}/chats/${chatId}/messages`);
                const newMessageRef = push(messagesRef);
                await set(newMessageRef, { sender: 'ai', text: response });
            }

            // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —á–∞—Ç –≤—Å–µ –µ—â–µ –∞–∫—Ç–∏–≤–µ–Ω)
            if (chatId === currentActiveChatId) {
                typingIndicator.classList.add('hidden');
            }
        }


        // === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ===

        // 1. –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã —á–∞—Ç–∞
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageText = chatInput.value.trim();
            const activeId = currentActiveChatId;

            if (messageText && activeId && currentUserId) {
                // 1. –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ –≤–≤–æ–¥–∞
                chatInput.value = '';
                
                // 2. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ RTDB
                const messagesRef = ref(db, `users/${currentUserId}/chats/${activeId}/messages`);
                const newMessageRef = push(messagesRef);
                await set(newMessageRef, { sender: 'user', text: messageText });
                // onValue –ø–æ–π–º–∞–µ—Ç —ç—Ç–æ –∏ –æ—Ç—Ä–∏—Å—É–µ—Ç.
                
                // 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ –Ω—É–∂–Ω–æ –ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞
                const chat = userChatsData[activeId];
                const messageCount = chat.messages ? Object.keys(chat.messages).length : 0;
                
                // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤—Ç–æ—Ä–æ–µ –≤ —á–∞—Ç–µ –ø–æ—Å–ª–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –ò–ò)
                if (messageCount === 1) { 
                    const newTitle = messageText.length > 25 ? messageText.substring(0, 25) + '...' : messageText;
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ RTDB
                    await set(ref(db, `users/${currentUserId}/chats/${activeId}/title`), newTitle);
                    // onValue –ø–æ–π–º–∞–µ—Ç –∏ —ç—Ç–æ.
                }
                
                // 4. –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ø–µ—á–∞—Ç–∞–µ—Ç"
                typingIndicator.classList.remove('hidden');

                // 5. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç –ò–ò (–æ–Ω —Å–∞–º —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ RTDB)
                setTimeout(getAIResponse, 1500, messageText, activeId);
            }
        });
        
        // 2. –ù–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ "–ù–æ–≤—ã–π —á–∞—Ç"
        newChatBtn.addEventListener('click', (e) => {
            e.preventDefault();
            createNewChat(); // –ü—Ä–æ—Å—Ç–æ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —á–∞—Ç. onValue —Å–¥–µ–ª–∞–µ—Ç –æ—Å—Ç–∞–ª—å–Ω–æ–µ.
        });
        
        // 3. –ù–∞–∂–∞—Ç–∏–µ –Ω–∞ —á–∞—Ç –≤ –∏—Å—Ç–æ—Ä–∏–∏ (–¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π)
        chatHistoryList.addEventListener('click', (e) => {
            const link = e.target.closest('a[data-chat-id]');
            if (link) {
                e.preventDefault();
                const chatId = link.dataset.chatId;
                if (chatId !== currentActiveChatId) {
                    renderChat(chatId); // –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º, –¥–∞–Ω–Ω—ã–µ —É–∂–µ –µ—Å—Ç—å
                    typingIndicator.classList.add('hidden');
                }
            }
        });

        // 4. –û—Ç–∫—Ä—ã—Ç–∏–µ/–ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        modelsBtn.addEventListener('click', (e) => {
            e.preventDefault();
            modelsModal.classList.remove('hidden');
            // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
            limitSelectionFieldset.classList.add('hidden'); // –°–∫—Ä—ã–≤–∞–µ–º –ª–∏–º–∏—Ç—ã
            purchaseBtn.disabled = true; // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É
            purchaseBtn.textContent = '–û–ø–ª–∞—Ç–∏—Ç—å (–°–∫–æ—Ä–æ)';
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
            modelSelectionRadios.forEach(radio => radio.checked = false);
            limitSelectionRadios.forEach(radio => radio.checked = false);
        });

        closeModalBtn.addEventListener('click', () => {
            modelsModal.classList.add('hidden');
        });

        modalBackdrop.addEventListener('click', () => {
            modelsModal.classList.add('hidden');
        });

        // 5. == –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –ü–û–ö–ê–ó–ê–¢–¨ –õ–ò–ú–ò–¢–´ –ü–†–ò –í–´–ë–û–†–ï PRO ==
        modelSelectionRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                const selectedModel = e.target.value;
                if (selectedModel === 'pro') {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–∏–º–∏—Ç—ã —Ç–æ–ª—å–∫–æ –¥–ª—è PRO
                    limitSelectionFieldset.classList.remove('hidden');
                    // –°–±—Ä–æ—Å –∫–Ω–æ–ø–∫–∏, –ø–æ–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω –ª–∏–º–∏—Ç
                    purchaseBtn.disabled = true;
                    purchaseBtn.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –ª–∏–º–∏—Ç';
                } else {
                    // –°–∫—Ä—ã–≤–∞–µ–º –ª–∏–º–∏—Ç—ã –¥–ª—è Base –∏ Fast
                    limitSelectionFieldset.classList.add('hidden');
                    // "–ü–æ–∫—É–ø–∫–∞" –¥–ª—è
                    purchaseBtn.disabled = false; // (–∏–ª–∏ true, –µ—Å–ª–∏ –æ–Ω–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ)
                    purchaseBtn.textContent = '–í—ã–±—Ä–∞—Ç—å'; // (–ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ "–í—ã–±—Ä–∞—Ç—å")
                }
            });
        });

        // 6. == –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –ê–ö–¢–ò–í–ê–¶–ò–Ø –ö–ù–û–ü–ö–ò –ü–û–ö–£–ü–ö–ò (–ü–û–ö–ê –û–¢–ö–õ–Æ–ß–ï–ù–ê) ==
        limitSelectionRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                // –ö–∞–∫ —Ç–æ–ª—å–∫–æ –ª–∏–º–∏—Ç –≤—ã–±—Ä–∞–Ω, –∫–Ω–æ–ø–∫–∞ –ø–æ–∫—É–ø–∫–∏ "–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è"
                // purchaseBtn.disabled = false; // <-- –†–ê–ó–ë–õ–û–ö–ò–†–£–ô –≠–¢–û, –ö–û–ì–î–ê –ë–£–î–ï–¢ –ì–û–¢–û–í–ê –û–ü–õ–ê–¢–ê
                purchaseBtn.textContent = '–û–ø–ª–∞—Ç–∏—Ç—å (–°–∫–æ—Ä–æ)';
                purchaseBtn.disabled = true; // –û—Å—Ç–∞–≤–ª—è–µ–º –æ—Ç–∫–ª—é—á–µ–Ω–Ω–æ–π –ø–æ —Ç–≤–æ–µ–π –ø—Ä–æ—Å—å–±–µ
            });
        });

    </script>

</body>
</html>
